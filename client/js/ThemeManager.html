<script>
/**
 * ===================================================================
 * CasesDash Theme Manager - Material Design 3.0 Theme System
 * ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã€ãƒ†ãƒ¼ãƒè¨­å®šç®¡ç†
 * ===================================================================
 */

/**
 * @fileoverview Material Design 3.0æº–æ‹ ã®ãƒ†ãƒ¼ãƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
 * @version 2.0.0
 * @author CasesDash Development Team
 */

'use strict';

/**
 * ç’°å¢ƒæ¤œå‡º - ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®ã¿å®Ÿè¡Œ
 * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆGASï¼‰ç’°å¢ƒã§ã¯å®‰å…¨ã«ã‚¹ã‚­ãƒƒãƒ—
 */
(function() {
    // ç’°å¢ƒãƒã‚§ãƒƒã‚¯
    if (typeof window === 'undefined') {
        // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆGASï¼‰ç’°å¢ƒã§ã¯ä½•ã‚‚ã—ãªã„
        console.log('ğŸ¨ ThemeManager: Skipping initialization in server environment');
        return;
    }

    /**
     * CasesDash Theme Manager
     * ãƒ†ãƒ¼ãƒã®åˆ‡ã‚Šæ›¿ãˆã€ä¿å­˜ã€å¾©å…ƒã‚’ç®¡ç†
     */
    window.CasesDashThemeManager = (function() {
    
    // === Constants ===
    const THEME_STORAGE_KEY = 'casesdash_theme_preference';
    const THEME_ATTRIBUTE = 'data-theme';
    const THEMES = {
        LIGHT: 'light',
        DARK: 'dark',
        AUTO: 'auto'
    };
    
    // === State ===
    let currentTheme = THEMES.DARK; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
    let mediaQueryList = null;
    let themeToggleButtons = [];
    let themeChangeCallbacks = [];
    
    /**
     * ãƒ†ãƒ¼ãƒãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
     * @public
     */
    function initialize() {
        try {
            console.log('ğŸ¨ Initializing CasesDash Theme Manager...');
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã®è¨­å®š
            setupMediaQuery();
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒè¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadSavedTheme();
            
            // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¨­å®š
            setupThemeToggleButtons();
            
            // åˆæœŸãƒ†ãƒ¼ãƒã‚’é©ç”¨
            applyCurrentTheme();
            
            // ãƒ†ãƒ¼ãƒå¤‰æ›´æ™‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
            setupCustomEventListeners();
            
            console.log('âœ… Theme Manager initialized successfully');
            
        } catch (error) {
            console.error('âŒ Failed to initialize Theme Manager:', error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã‚’é©ç”¨
            setTheme(THEMES.DARK);
        }
    }
    
    /**
     * ãƒ—ãƒªãƒ•ã‚¡ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã‚’è¨­å®š
     * @private
     */
    function setupMediaQuery() {
        // å®‰å…¨ãªç’°å¢ƒãƒã‚§ãƒƒã‚¯
        if (typeof window !== 'undefined' && window.matchMedia) {
            mediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã®å¤‰æ›´ã‚’ãƒªãƒƒã‚¹ãƒ³
            if (mediaQueryList.addEventListener) {
                mediaQueryList.addEventListener('change', handleSystemThemeChange);
            } else if (mediaQueryList.addListener) {
                // Safariå¯¾å¿œ
                mediaQueryList.addListener(handleSystemThemeChange);
            }
        }
    }
    
    /**
     * ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒå¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
     * @private
     * @param {MediaQueryListEvent} event - ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã‚¤ãƒ™ãƒ³ãƒˆ
     */
    function handleSystemThemeChange(event) {
        if (currentTheme === THEMES.AUTO) {
            console.log('ğŸ”„ System theme changed to:', event.matches ? 'dark' : 'light');
            applyCurrentTheme();
            notifyThemeChange();
        }
    }
    
    /**
     * ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒè¨­å®šã‚’èª­ã¿è¾¼ã¿
     * @private
     */
    function loadSavedTheme() {
        try {
            // HTMLã®åˆæœŸãƒ†ãƒ¼ãƒè¨­å®šã‚’ç¢ºèª
            let htmlTheme = THEMES.DARK; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«å›ºå®š
            if (typeof document !== 'undefined' && document.documentElement) {
                const htmlThemeAttr = document.documentElement.getAttribute(THEME_ATTRIBUTE);
                if (htmlThemeAttr && Object.values(THEMES).includes(htmlThemeAttr)) {
                    htmlTheme = htmlThemeAttr;
                } else {
                    // HTMLã«å±æ€§ãŒãªã„å ´åˆã€ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶è¨­å®š
                    document.documentElement.setAttribute(THEME_ATTRIBUTE, THEMES.DARK);
                    htmlTheme = THEMES.DARK;
                }
            }
            
            // å®‰å…¨ãªlocalStorageã‚¢ã‚¯ã‚»ã‚¹
            if (typeof localStorage === 'undefined') {
                console.log('ğŸ¨ localStorage not available, using dark theme');
                currentTheme = THEMES.DARK;
                return;
            }
            
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            if (savedTheme && Object.values(THEMES).includes(savedTheme)) {
                currentTheme = savedTheme;
                console.log('ğŸ“– Loaded saved theme:', savedTheme);
            } else {
                console.log('ğŸ”§ No saved theme found, using dark theme');
                currentTheme = THEMES.DARK;
            }
        } catch (error) {
            console.warn('âš ï¸ Failed to load saved theme:', error);
            currentTheme = THEMES.DARK; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }
    }
    
    /**
     * ãƒ†ãƒ¼ãƒè¨­å®šã‚’ä¿å­˜
     * @private
     * @param {string} theme - ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ
     */
    function saveTheme(theme) {
        try {
            // å®‰å…¨ãªlocalStorageã‚¢ã‚¯ã‚»ã‚¹
            if (typeof localStorage === 'undefined') {
                console.log('ğŸ¨ localStorage not available, skipping theme save');
                return;
            }
            
            localStorage.setItem(THEME_STORAGE_KEY, theme);
            console.log('ğŸ’¾ Theme saved:', theme);
        } catch (error) {
            console.warn('âš ï¸ Failed to save theme:', error);
        }
    }
    
    /**
     * ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¨­å®š
     * @private
     */
    function setupThemeToggleButtons() {
        // å®‰å…¨ãªDOMæ“ä½œ
        if (typeof document === 'undefined') {
            console.log('ğŸ¨ Document not available, skipping button setup');
            return;
        }
        
        // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’æ¤œç´¢
        const toggleButtons = document.querySelectorAll('.theme-toggle, [data-action="toggle-theme"]');
        
        toggleButtons.forEach(button => {
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
            button.removeEventListener('click', handleThemeToggleClick);
            button.addEventListener('click', handleThemeToggleClick);
            themeToggleButtons.push(button);
        });
        
        console.log(`ğŸ”˜ Found ${toggleButtons.length} theme toggle buttons`);
        
        // å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ã‚‚ç›£è¦–
        setTimeout(() => {
            const laterButtons = document.querySelectorAll('.theme-toggle, [data-action="toggle-theme"]');
            laterButtons.forEach(button => {
                if (!themeToggleButtons.includes(button)) {
                    button.removeEventListener('click', handleThemeToggleClick);
                    button.addEventListener('click', handleThemeToggleClick);
                    themeToggleButtons.push(button);
                    console.log('ğŸ”˜ Added delayed theme toggle button');
                }
            });
        }, 1000);
    }
    
    /**
     * ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
     * @private
     * @param {Event} event - ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
     */
    function handleThemeToggleClick(event) {
        event.preventDefault();
        toggleTheme();
    }
    
    /**
     * ç¾åœ¨ã®ãƒ†ãƒ¼ãƒã‚’é©ç”¨
     * @private
     */
    function applyCurrentTheme() {
        // å®‰å…¨ãªDOMæ“ä½œ
        if (typeof document === 'undefined') {
            console.log('ğŸ¨ Document not available, skipping theme application');
            return;
        }
        
        const resolvedTheme = resolveTheme(currentTheme);
        const html = document.documentElement;
        
        // HTMLã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã«ãƒ†ãƒ¼ãƒå±æ€§ã‚’è¨­å®š
        html.setAttribute(THEME_ATTRIBUTE, resolvedTheme);
        
        // ãƒœãƒ‡ã‚£ã‚¯ãƒ©ã‚¹ã‚‚è¨­å®šï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
        if (document.body) {
            document.body.classList.remove('theme-light', 'theme-dark');
            document.body.classList.add(`theme-${resolvedTheme}`);
        }
        
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®CSSå¤‰æ•°ã‚’å¼·åˆ¶é©ç”¨
        if (resolvedTheme === THEMES.DARK) {
            ensureDarkModeStyles();
        }
        
        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
        updateThemeToggleIcons(resolvedTheme);
        
        console.log(`ğŸ¨ Applied theme: ${resolvedTheme} (from ${currentTheme})`);
    }
    
    /**
     * ãƒ†ãƒ¼ãƒã‚’è§£æ±ºï¼ˆAUTOã®å ´åˆã¯ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä½¿ç”¨ï¼‰
     * @private
     * @param {string} theme - è§£æ±ºã™ã‚‹ãƒ†ãƒ¼ãƒ
     * @returns {string} è§£æ±ºã•ã‚ŒãŸãƒ†ãƒ¼ãƒ
     */
    function resolveTheme(theme) {
        if (theme === THEMES.AUTO) {
            if (mediaQueryList && mediaQueryList.matches) {
                return THEMES.DARK;
            }
            // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãŒãƒ©ã‚¤ãƒˆã®å ´åˆã§ã‚‚ã€æ˜ç¤ºçš„ã«ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
            return THEMES.DARK;
        }
        return theme;
    }
    
    /**
     * ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®å¼·åˆ¶é©ç”¨
     * @private
     */
    function ensureDarkModeStyles() {
        if (typeof document === 'undefined') return;
        
        const root = document.documentElement;
        
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®åŸºæœ¬CSSå¤‰æ•°ã‚’ç¢ºå®Ÿã«è¨­å®šï¼ˆMaterial Design 3.0æº–æ‹ ï¼‰
        const darkModeVariables = {
            '--current-surface': 'var(--md-sys-color-surface)',
            '--current-surface-container': 'var(--md-sys-color-surface-container)',
            '--current-surface-container-low': 'var(--md-sys-color-surface-container-low)',
            '--current-surface-container-high': 'var(--md-sys-color-surface-container-high)',
            '--current-surface-container-highest': 'var(--md-sys-color-surface-container-highest)',
            '--current-on-surface': 'var(--md-sys-color-on-surface)',
            '--current-on-surface-variant': 'var(--md-sys-color-on-surface-variant)',
            '--current-primary': 'var(--md-sys-color-primary)',
            '--current-on-primary': 'var(--md-sys-color-on-primary)',
            '--current-outline': 'var(--md-sys-color-outline)',
            '--current-outline-variant': 'var(--md-sys-color-outline-variant)',
            '--current-elevation-1': 'var(--md-elevation-level1)',
            '--current-elevation-2': 'var(--md-elevation-level2)',
            '--current-elevation-3': 'var(--md-elevation-level3)',
            '--current-elevation-4': 'var(--md-elevation-level4)',
            '--current-elevation-5': 'var(--md-elevation-level5)'
        };
        
        Object.entries(darkModeVariables).forEach(([property, value]) => {
            root.style.setProperty(property, value);
        });
        
        console.log('ğŸŒ™ Dark mode CSS variables enforced');
    }
    
    /**
     * ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
     * @private
     * @param {string} resolvedTheme - ç¾åœ¨é©ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ
     */
    function updateThemeToggleIcons(resolvedTheme) {
        themeToggleButtons.forEach(button => {
            const icon = button.querySelector('.material-icons, .material-symbols-outlined');
            if (icon) {
                if (resolvedTheme === THEMES.DARK) {
                    icon.textContent = 'light_mode';
                    button.setAttribute('title', 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                    button.setAttribute('aria-label', 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                } else {
                    icon.textContent = 'dark_mode';
                    button.setAttribute('title', 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                    button.setAttribute('aria-label', 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                }
            }
        });
    }
    
    /**
     * ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
     * @private
     */
    function setupCustomEventListeners() {
        // å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        if (typeof document === 'undefined') {
            console.log('ğŸ¨ Document not available, skipping event listeners');
            return;
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
        document.addEventListener('casesdash:theme:set', function(event) {
            if (event.detail && event.detail.theme) {
                setTheme(event.detail.theme);
            }
        });
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
        document.addEventListener('casesdash:theme:toggle', function() {
            toggleTheme();
        });
    }
    
    /**
     * ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’é€šçŸ¥
     * @private
     */
    function notifyThemeChange() {
        const resolvedTheme = resolveTheme(currentTheme);
        
        // å®‰å…¨ãªã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
        if (typeof document === 'undefined' || typeof CustomEvent === 'undefined') {
            console.log('ğŸ¨ CustomEvent not available, skipping event dispatch');
        } else {
            // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
            const event = new CustomEvent('casesdash:theme:changed', {
                detail: {
                    theme: currentTheme,
                    resolvedTheme: resolvedTheme,
                    timestamp: Date.now()
                }
            });
            document.dispatchEvent(event);
        }
        
        // ç™»éŒ²ã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
        themeChangeCallbacks.forEach(callback => {
            try {
                callback(currentTheme, resolvedTheme);
            } catch (error) {
                console.error('âŒ Theme change callback error:', error);
            }
        });
        
        console.log(`ğŸ“¡ Theme change notified: ${currentTheme} -> ${resolvedTheme}`);
    }
    
    /**
     * ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ç”¨ã®getComputedStyleå‘¼ã³å‡ºã—ã‚’å®‰å…¨ã«å®Ÿè¡Œ
     * @private
     * @param {HTMLElement} element - å¯¾è±¡è¦ç´ 
     * @returns {CSSStyleDeclaration|null} ã‚¹ã‚¿ã‚¤ãƒ«æƒ…å ±ã¾ãŸã¯null
     */
    function safeGetComputedStyle(element) {
        if (typeof window === 'undefined' || !window.getComputedStyle) {
            return null;
        }
        try {
            return window.getComputedStyle(element);
        } catch (error) {
            console.warn('âš ï¸ getComputedStyle failed:', error);
            return null;
        }
    }
    
    /**
     * ãƒ†ãƒ¼ãƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
     * @public
     */
    function preloadThemes() {
        // å®‰å…¨ãªDOMæ“ä½œã¨getComputedStyleå‘¼ã³å‡ºã—
        if (typeof document === 'undefined') {
            console.log('ğŸ¨ Document not available, skipping theme preload');
            return;
        }
        
        // CSSãƒ•ã‚¡ã‚¤ãƒ«ã®äº‹å‰èª­ã¿è¾¼ã¿ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‡¦ç†
        const themes = [THEMES.LIGHT, THEMES.DARK];
        
        themes.forEach(theme => {
            const testElement = document.createElement('div');
            testElement.setAttribute(THEME_ATTRIBUTE, theme);
            testElement.style.position = 'absolute';
            testElement.style.visibility = 'hidden';
            testElement.style.pointerEvents = 'none';
            document.body.appendChild(testElement);
            
            // å®‰å…¨ãªå¼·åˆ¶ã‚¹ã‚¿ã‚¤ãƒ«è¨ˆç®—
            const computedStyle = safeGetComputedStyle(testElement);
            if (computedStyle) {
                computedStyle.getPropertyValue('background-color');
            }
            
            document.body.removeChild(testElement);
        });
        
        console.log('âš¡ Themes preloaded for better performance');
    }
    
    /**
     * ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å–å¾—ï¼ˆå®‰å…¨ç‰ˆï¼‰
     * @public
     * @returns {Object} ãƒ‡ãƒãƒƒã‚°æƒ…å ±
     */
    function getDebugInfo() {
        return {
            currentTheme: currentTheme,
            resolvedTheme: resolveTheme(currentTheme),
            systemPreference: getSystemPreference(),
            supportsDarkMode: supportsDarkMode(),
            toggleButtonsCount: themeToggleButtons.length,
            callbacksCount: themeChangeCallbacks.length,
            mediaQuerySupport: typeof window !== 'undefined' && !!window.matchMedia,
            localStorageSupport: typeof window !== 'undefined' && !!window.localStorage,
            documentAvailable: typeof document !== 'undefined',
            windowAvailable: typeof window !== 'undefined'
        };
    }
    
    /**
     * ãƒ†ãƒ¼ãƒã‚’è¨­å®š
     * @public
     * @param {string} theme - è¨­å®šã™ã‚‹ãƒ†ãƒ¼ãƒ (light, dark, auto)
     * @returns {boolean} è¨­å®šãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹
     */
    function setTheme(theme) {
        if (!Object.values(THEMES).includes(theme)) {
            console.error('âŒ Invalid theme:', theme);
            return false;
        }
        
        if (currentTheme === theme) {
            console.log('â„¹ï¸ Theme already set to:', theme);
            return true;
        }
        
        const previousTheme = currentTheme;
        currentTheme = theme;
        
        // ãƒ†ãƒ¼ãƒã‚’é©ç”¨
        applyCurrentTheme();
        
        // ãƒ†ãƒ¼ãƒã‚’ä¿å­˜
        saveTheme(theme);
        
        // å¤‰æ›´ã‚’é€šçŸ¥
        notifyThemeChange();
        
        console.log(`ğŸ”„ Theme changed: ${previousTheme} -> ${theme}`);
        return true;
    }
    
    /**
     * ãƒ†ãƒ¼ãƒã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ©ã‚¤ãƒˆâ†”ãƒ€ãƒ¼ã‚¯ï¼‰
     * @public
     * @returns {string} æ–°ã—ã„ãƒ†ãƒ¼ãƒ
     */
    function toggleTheme() {
        const resolvedTheme = resolveTheme(currentTheme);
        let newTheme;
        
        if (resolvedTheme === THEMES.DARK) {
            newTheme = THEMES.LIGHT;
        } else {
            newTheme = THEMES.DARK;
        }
        
        setTheme(newTheme);
        return newTheme;
    }
    
    /**
     * ç¾åœ¨ã®ãƒ†ãƒ¼ãƒã‚’å–å¾—
     * @public
     * @returns {string} ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ
     */
    function getCurrentTheme() {
        return currentTheme;
    }
    
    /**
     * è§£æ±ºã•ã‚ŒãŸç¾åœ¨ã®ãƒ†ãƒ¼ãƒã‚’å–å¾—
     * @public
     * @returns {string} è§£æ±ºã•ã‚ŒãŸãƒ†ãƒ¼ãƒ
     */
    function getResolvedTheme() {
        return resolveTheme(currentTheme);
    }
    
    /**
     * ã‚·ã‚¹ãƒ†ãƒ ãŒãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
     * @public
     * @returns {boolean} ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã©ã†ã‹
     */
    function supportsDarkMode() {
        return mediaQueryList !== null;
    }
    
    /**
     * ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ—ãƒªãƒ•ã‚¡ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ã‚’å–å¾—
     * @public
     * @returns {string} ã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®š (light, dark, unknown)
     */
    function getSystemPreference() {
        if (!mediaQueryList) {
            return 'unknown';
        }
        return mediaQueryList.matches ? THEMES.DARK : THEMES.LIGHT;
    }
    
    /**
     * ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ 
     * @public
     * @param {Function} callback - ãƒ†ãƒ¼ãƒå¤‰æ›´æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
     * @returns {Function} ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤ç”¨ã®é–¢æ•°
     */
    function addThemeChangeCallback(callback) {
        if (typeof callback !== 'function') {
            console.error('âŒ Theme change callback must be a function');
            return () => {};
        }
        
        themeChangeCallbacks.push(callback);
        
        // å‰Šé™¤ç”¨ã®é–¢æ•°ã‚’è¿”ã™
        return function removeCallback() {
            const index = themeChangeCallbacks.indexOf(callback);
            if (index > -1) {
                themeChangeCallbacks.splice(index, 1);
            }
        };
    }
    
    /**
     * ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«è¿½åŠ 
     * @public
     * @param {HTMLElement} button - è¿½åŠ ã™ã‚‹ãƒœã‚¿ãƒ³è¦ç´ 
     */
    function addThemeToggleButton(button) {
        if (!(button instanceof HTMLElement)) {
            console.error('âŒ Invalid theme toggle button element');
            return;
        }
        
        button.addEventListener('click', handleThemeToggleClick);
        themeToggleButtons.push(button);
        
        // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
        updateThemeToggleIcons(resolveTheme(currentTheme));
        
        console.log('â• Theme toggle button added');
    }
    
    /**
     * CSSå¤‰æ•°ã‚’å‹•çš„ã«æ›´æ–°
     * @public
     * @param {Object} variables - æ›´æ–°ã™ã‚‹CSSå¤‰æ•°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateCSSVariables(variables) {
        // å®‰å…¨ãªDOMæ“ä½œ
        if (typeof document === 'undefined') {
            console.log('ğŸ¨ Document not available, skipping CSS variables update');
            return;
        }
        
        const root = document.documentElement;
        
        Object.entries(variables).forEach(([property, value]) => {
            root.style.setProperty(property, value);
        });
        
        console.log('ğŸ¨ CSS variables updated:', Object.keys(variables));
    }
    
    
    // === Public API ===
    return {
        // Core Functions
        initialize,
        setTheme,
        toggleTheme,
        getCurrentTheme,
        getResolvedTheme,
        
        // System Information
        supportsDarkMode,
        getSystemPreference,
        
        // Event Management
        addThemeChangeCallback,
        addThemeToggleButton,
        
        // Utilities
        updateCSSVariables,
        preloadThemes,
        getDebugInfo,
        
        // Constants
        THEMES
    };
    
})();

// === Auto-initialization ===
// DOMContentLoadedã§ã®è‡ªå‹•åˆæœŸåŒ–ï¼ˆå®‰å…¨ç‰ˆï¼‰
if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            if (window.CasesDashThemeManager) {
                window.CasesDashThemeManager.initialize();
            }
        });
    } else {
        // ã™ã§ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«åˆæœŸåŒ–
        if (window.CasesDashThemeManager) {
            window.CasesDashThemeManager.initialize();
        }
    }
}

// === Global Utility Functions ===
// ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®ã¿ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’è¨­å®š
if (typeof window !== 'undefined') {
    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆé–¢æ•°ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
     * @global
     */
    window.toggleTheme = function() {
        if (window.CasesDashThemeManager) {
            return window.CasesDashThemeManager.toggleTheme();
        }
        console.warn('ğŸ¨ ThemeManager not available');
        return null;
    };

    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ãƒ¼ãƒè¨­å®šé–¢æ•°
     * @global
     * @param {string} theme - è¨­å®šã™ã‚‹ãƒ†ãƒ¼ãƒ
     */
    window.setTheme = function(theme) {
        if (window.CasesDashThemeManager) {
            return window.CasesDashThemeManager.setTheme(theme);
        }
        console.warn('ğŸ¨ ThemeManager not available');
        return false;
    };
}

console.log('ğŸ¨ CasesDash Theme Manager loaded successfully');

})(); // IIFEçµ‚äº†
</script>