<script>
/**
 * Case Manager - Core CRUD Operations
 * Manages case creation, reading, updating, and deletion
 * 
 * @author Roo
 * @version 1.0
 * @since 2025-05-25
 */

if (typeof window !== 'undefined') {
  window.CasesDashCaseManager = (function() {
    'use strict';

    // Case management state
    let caseState = {
      initialized: false,
      currentCases: [],
      filteredCases: [],
      selectedCases: [],
      searchQuery: '',
      filterCriteria: {
        status: '',
        type: '',
        assignee: '',
        dateRange: null
      },
      sortCriteria: {
        field: 'createdDate',
        direction: 'desc'
      },
      pagination: {
        currentPage: 1,
        pageSize: 25,
        totalPages: 1,
        totalItems: 0
      }
    };

    // DOM elements cache
    let elements = {};

    /**
     * Initialize Case Manager
     */
    function initialize() {
      try {
        console.log('初期化中: ケースマネージャー...');
        
        cacheElements();
        setupEventListeners();
        setupDataTable();
        
        caseState.initialized = true;
        console.log('✅ ケースマネージャーが正常に初期化されました');
        
      } catch (error) {
        console.error('❌ ケースマネージャーの初期化に失敗:', error);
        throw error;
      }
    }

    /**
     * Cache DOM elements for case management
     */
    function cacheElements() {
      elements = {
        // Case list view elements
        casesTableBody: document.getElementById('cases-table-body'),
        casesTable: document.getElementById('cases-table'),
        caseSearchInput: document.getElementById('case-search'),
        
        // Filter controls
        statusFilter: document.getElementById('status-filter'),
        typeFilter: document.getElementById('type-filter'),
        assigneeFilter: document.getElementById('assignee-filter'),
        dateRangeFilter: document.getElementById('date-range-filter'),
        
        // Bulk actions
        bulkActionsPanel: document.getElementById('bulk-actions-panel'),
        selectAllCheckbox: document.getElementById('select-all-cases'),
        bulkDeleteBtn: document.getElementById('bulk-delete-btn'),
        bulkStatusBtn: document.getElementById('bulk-status-btn'),
        bulkExportBtn: document.getElementById('bulk-export-btn'),
        
        // Pagination
        paginationContainer: document.getElementById('pagination-container'),
        itemsPerPageSelect: document.getElementById('items-per-page'),
        
        // Case detail modal
        caseDetailModal: document.getElementById('case-detail-dialog'),
        caseDetailContent: document.getElementById('case-detail-content'),
        
        // Quick actions
        refreshCasesBtn: document.getElementById('refresh-cases-btn'),
        exportCasesBtn: document.getElementById('export-cases-btn'),
        
        // Stats elements
        totalCasesCount: document.getElementById('cases-count-total'),
        activeCasesCount: document.getElementById('cases-count-active'),
        completedCasesCount: document.getElementById('cases-count-completed')
      };
    }

    /**
     * Setup event listeners for case management
     */
    function setupEventListeners() {
      // Search functionality
      if (elements.caseSearchInput) {
        elements.caseSearchInput.addEventListener('input', debounce(handleSearch, 300));
      }

      // Filter controls
      if (elements.statusFilter) {
        elements.statusFilter.addEventListener('change', handleFilterChange);
      }
      if (elements.typeFilter) {
        elements.typeFilter.addEventListener('change', handleFilterChange);
      }
      if (elements.assigneeFilter) {
        elements.assigneeFilter.addEventListener('change', handleFilterChange);
      }
      if (elements.dateRangeFilter) {
        elements.dateRangeFilter.addEventListener('change', handleFilterChange);
      }

      // Bulk actions
      if (elements.selectAllCheckbox) {
        elements.selectAllCheckbox.addEventListener('change', handleSelectAll);
      }
      if (elements.bulkDeleteBtn) {
        elements.bulkDeleteBtn.addEventListener('click', handleBulkDelete);
      }
      if (elements.bulkStatusBtn) {
        elements.bulkStatusBtn.addEventListener('click', handleBulkStatusUpdate);
      }
      if (elements.bulkExportBtn) {
        elements.bulkExportBtn.addEventListener('click', handleBulkExport);
      }

      // Pagination
      if (elements.itemsPerPageSelect) {
        elements.itemsPerPageSelect.addEventListener('change', handlePageSizeChange);
      }

      // Quick actions
      if (elements.refreshCasesBtn) {
        elements.refreshCasesBtn.addEventListener('click', refreshCasesList);
      }
      if (elements.exportCasesBtn) {
        elements.exportCasesBtn.addEventListener('click', exportAllCases);
      }
    }

    /**
     * Setup data table with sorting and selection
     */
    function setupDataTable() {
      if (!elements.casesTable) return;

      // Setup sortable headers
      const headers = elements.casesTable.querySelectorAll('th[data-sort]');
      headers.forEach(header => {
        header.addEventListener('click', () => handleSort(header.dataset.sort));
        header.style.cursor = 'pointer';
      });
    }

    /**
     * Load user cases with current filters and pagination
     */
    async function loadUserCases() {
      try {
        showLoading(true);
        
        const requestParams = {
          search: caseState.searchQuery,
          filters: caseState.filterCriteria,
          sort: caseState.sortCriteria,
          pagination: caseState.pagination
        };

        const response = await callServerFunction('getUserCases', requestParams);
        
        if (response.success) {
          caseState.currentCases = response.data.cases || [];
          caseState.pagination = { ...caseState.pagination, ...response.data.pagination };
          
          updateCasesDisplay();
          updatePagination();
          updateCaseStats(response.data.stats);
        } else {
          throw new Error(response.error || 'ケースの読み込みに失敗しました');
        }
        
      } catch (error) {
        console.error('ケース読み込みエラー:', error);
        showError('ケースの読み込みに失敗しました: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    /**
     * Update cases display in the table
     */
    function updateCasesDisplay() {
      if (!elements.casesTableBody) return;

      if (caseState.currentCases.length === 0) {
        elements.casesTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="no-cases-message">
              <div style="text-align: center; padding: 20px; color: #666;">
                <i class="material-icons" style="font-size: 48px; margin-bottom: 10px;">inbox</i>
                <p>表示するケースがありません</p>
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="showCreateCase()">
                  新しいケースを作成
                </button>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      const casesHTML = caseState.currentCases.map(caseItem => `
        <tr data-case-id="${escapeHtml(caseItem.id)}" data-sheet-type="${escapeHtml(caseItem.sheetType)}">
          <td>
            <label class="mdl-checkbox mdl-js-checkbox mdl-checkbox--table-select" for="row-${caseItem.id}">
              <input type="checkbox" id="row-${caseItem.id}" class="mdl-checkbox__input case-checkbox" 
                     value="${escapeHtml(caseItem.id)}" onchange="handleCaseSelection(this)">
            </label>
          </td>
          <td class="mdl-data-table__cell--non-numeric">
            <a href="#" onclick="viewCaseDetails('${escapeHtml(caseItem.id)}', '${escapeHtml(caseItem.sheetType)}')" 
               class="case-id-link">${escapeHtml(caseItem.caseId || caseItem.id)}</a>
          </td>
          <td class="mdl-data-table__cell--non-numeric">${escapeHtml(caseItem.sheetType || 'Unknown')}</td>
          <td class="mdl-data-table__cell--non-numeric">
            <span class="status-badge status-${(caseItem.status || 'unknown').toLowerCase()}">
              ${escapeHtml(caseItem.status || 'Unknown')}
            </span>
          </td>
          <td class="mdl-data-table__cell--non-numeric">${formatDate(caseItem.createdDate)}</td>
          <td class="mdl-data-table__cell--non-numeric">
            <div class="case-actions">
              <button class="mdl-button mdl-js-button mdl-button--icon" 
                      onclick="viewCaseDetails('${escapeHtml(caseItem.id)}', '${escapeHtml(caseItem.sheetType)}')"
                      title="詳細表示">
                <i class="material-icons">visibility</i>
              </button>
              <button class="mdl-button mdl-js-button mdl-button--icon" 
                      onclick="editCase('${escapeHtml(caseItem.id)}', '${escapeHtml(caseItem.sheetType)}')"
                      title="編集">
                <i class="material-icons">edit</i>
              </button>
              ${(caseItem.status && ['Solution Offered', 'Finished', 'Closed'].includes(caseItem.status)) ? `
                <button class="mdl-button mdl-js-button mdl-button--icon reactivate-button" 
                        onclick="reactivateCase('${escapeHtml(caseItem.id)}', '${escapeHtml(caseItem.sheetType)}')"
                        title="Re-activate case"
                        style="color: var(--md-success-50);">
                  <i class="material-icons">refresh</i>
                </button>
              ` : ''}
              <button class="mdl-button mdl-js-button mdl-button--icon" 
                      onclick="deleteCase('${escapeHtml(caseItem.id)}', '${escapeHtml(caseItem.sheetType)}')"
                      title="削除">
                <i class="material-icons">delete</i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      elements.casesTableBody.innerHTML = casesHTML;
      
      // Re-initialize MDL components for new elements
      if (typeof componentHandler !== 'undefined') {
        componentHandler.upgradeElements(elements.casesTableBody);
      }
    }

    /**
     * Update pagination controls
     */
    function updatePagination() {
      if (!elements.paginationContainer) return;

      const { currentPage, totalPages, totalItems } = caseState.pagination;
      
      if (totalPages <= 1) {
        elements.paginationContainer.style.display = 'none';
        return;
      }

      elements.paginationContainer.style.display = 'block';
      
      const paginationHTML = `
        <div class="pagination-info">
          ${totalItems}件中 ${(currentPage - 1) * caseState.pagination.pageSize + 1}-${Math.min(currentPage * caseState.pagination.pageSize, totalItems)}件を表示
        </div>
        <div class="pagination-controls">
          <button class="mdl-button mdl-js-button mdl-button--icon" 
                  onclick="goToPage(1)" 
                  ${currentPage === 1 ? 'disabled' : ''}>
            <i class="material-icons">first_page</i>
          </button>
          <button class="mdl-button mdl-js-button mdl-button--icon" 
                  onclick="goToPage(${currentPage - 1})" 
                  ${currentPage === 1 ? 'disabled' : ''}>
            <i class="material-icons">chevron_left</i>
          </button>
          
          ${generatePageNumbers(currentPage, totalPages).map(page => `
            <button class="mdl-button mdl-js-button ${page === currentPage ? 'mdl-button--colored' : ''}" 
                    onclick="goToPage(${page})">${page}</button>
          `).join('')}
          
          <button class="mdl-button mdl-js-button mdl-button--icon" 
                  onclick="goToPage(${currentPage + 1})" 
                  ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="material-icons">chevron_right</i>
          </button>
          <button class="mdl-button mdl-js-button mdl-button--icon" 
                  onclick="goToPage(${totalPages})" 
                  ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="material-icons">last_page</i>
          </button>
        </div>
      `;

      elements.paginationContainer.innerHTML = paginationHTML;
    }

    /**
     * Update case statistics
     */
    function updateCaseStats(stats) {
      if (!stats) return;

      if (elements.totalCasesCount) {
        elements.totalCasesCount.textContent = stats.total || 0;
      }
      if (elements.activeCasesCount) {
        elements.activeCasesCount.textContent = stats.active || 0;
      }
      if (elements.completedCasesCount) {
        elements.completedCasesCount.textContent = stats.completed || 0;
      }
    }

    /**
     * View case details in modal
     */
    async function viewCaseDetails(caseId, sheetType) {
      try {
        showLoading(true);
        
        const response = await callServerFunction('getCaseById', caseId, sheetType);
        
        if (response.success && response.data) {
          displayCaseDetailsModal(response.data);
        } else {
          throw new Error(response.error || 'ケースの詳細を取得できませんでした');
        }
        
      } catch (error) {
        console.error('ケース詳細取得エラー:', error);
        showError('ケースの詳細を取得できませんでした: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    /**
     * Display case details in modal
     */
    function displayCaseDetailsModal(caseData) {
      if (!elements.caseDetailModal || !elements.caseDetailContent) return;

      const detailsHTML = `
        <div class="case-details">
          <div class="case-header">
            <h3>${escapeHtml(caseData.caseId || caseData.id)}</h3>
            <span class="status-badge status-${(caseData.status || 'unknown').toLowerCase()}">
              ${escapeHtml(caseData.status || 'Unknown')}
            </span>
          </div>
          
          <div class="case-info-grid">
            <div class="info-item">
              <label>シートタイプ:</label>
              <span>${escapeHtml(caseData.sheetType || 'Unknown')}</span>
            </div>
            <div class="info-item">
              <label>作成日:</label>
              <span>${formatDate(caseData.createdDate)}</span>
            </div>
            <div class="info-item">
              <label>更新日:</label>
              <span>${formatDate(caseData.lastModified)}</span>
            </div>
            <div class="info-item">
              <label>担当者:</label>
              <span>${escapeHtml(caseData.assignee || 'Unassigned')}</span>
            </div>
          </div>
          
          <div class="case-fields">
            ${Object.entries(caseData.fields || {}).map(([key, value]) => `
              <div class="field-item">
                <label>${escapeHtml(key)}:</label>
                <span>${escapeHtml(String(value || ''))}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      elements.caseDetailContent.innerHTML = detailsHTML;
      
      if (elements.caseDetailModal.showModal) {
        elements.caseDetailModal.showModal();
      }
    }

    /**
     * Delete a case with confirmation
     */
    async function deleteCase(caseId, sheetType) {
      try {
        const confirmed = confirm(`ケース ${caseId} を削除してもよろしいですか？この操作は取り消せません。`);
        if (!confirmed) return;

        showLoading(true);
        
        const response = await callServerFunction('deleteCase', caseId, sheetType);
        
        if (response.success) {
          showToast('ケースが正常に削除されました', 'success');
          await loadUserCases(); // Refresh the list
        } else {
          throw new Error(response.error || 'ケースの削除に失敗しました');
        }
        
      } catch (error) {
        console.error('ケース削除エラー:', error);
        showError('ケースの削除に失敗しました: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    /**
     * Event handlers
     */
    function handleSearch(event) {
      caseState.searchQuery = event.target.value.trim();
      caseState.pagination.currentPage = 1; // Reset to first page
      loadUserCases();
    }

    function handleFilterChange() {
      // Collect all filter values
      caseState.filterCriteria = {
        status: elements.statusFilter?.value || '',
        type: elements.typeFilter?.value || '',
        assignee: elements.assigneeFilter?.value || '',
        dateRange: elements.dateRangeFilter?.value || null
      };
      
      caseState.pagination.currentPage = 1; // Reset to first page
      loadUserCases();
    }

    function handleSort(field) {
      if (caseState.sortCriteria.field === field) {
        // Toggle direction
        caseState.sortCriteria.direction = caseState.sortCriteria.direction === 'asc' ? 'desc' : 'asc';
      } else {
        // New field
        caseState.sortCriteria.field = field;
        caseState.sortCriteria.direction = 'asc';
      }
      
      loadUserCases();
    }

    function handleSelectAll(event) {
      const checkboxes = document.querySelectorAll('.case-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = event.target.checked;
      });
      
      updateSelectedCases();
    }

    function handleCaseSelection(checkbox) {
      updateSelectedCases();
    }

    function updateSelectedCases() {
      const selectedCheckboxes = document.querySelectorAll('.case-checkbox:checked');
      caseState.selectedCases = Array.from(selectedCheckboxes).map(cb => cb.value);
      
      // Update bulk actions visibility
      if (elements.bulkActionsPanel) {
        elements.bulkActionsPanel.style.display = caseState.selectedCases.length > 0 ? 'block' : 'none';
      }
    }

    function handlePageSizeChange(event) {
      caseState.pagination.pageSize = parseInt(event.target.value);
      caseState.pagination.currentPage = 1;
      loadUserCases();
    }

    /**
     * Bulk operations
     */
    async function handleBulkDelete() {
      if (caseState.selectedCases.length === 0) return;

      const confirmed = confirm(`選択された ${caseState.selectedCases.length} 件のケースを削除してもよろしいですか？`);
      if (!confirmed) return;

      try {
        showLoading(true);
        
        const response = await callServerFunction('bulkDeleteCases', caseState.selectedCases);
        
        if (response.success) {
          showToast(`${response.data.deletedCount} 件のケースが削除されました`, 'success');
          await loadUserCases();
          caseState.selectedCases = [];
        } else {
          throw new Error(response.error || '一括削除に失敗しました');
        }
        
      } catch (error) {
        console.error('一括削除エラー:', error);
        showError('一括削除に失敗しました: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    /**
     * Utility functions
     */
    function generatePageNumbers(current, total) {
      const pages = [];
      const maxPages = 5;
      
      let start = Math.max(1, current - Math.floor(maxPages / 2));
      let end = Math.min(total, start + maxPages - 1);
      
      if (end - start < maxPages - 1) {
        start = Math.max(1, end - maxPages + 1);
      }
      
      for (let i = start; i <= end; i++) {
        pages.push(i);
      }
      
      return pages;
    }

    function formatDate(dateString) {
      if (!dateString) return '--';
      
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      } catch (error) {
        return '--';
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Utility function accessors
    function showLoading(show) {
      if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
        window.CasesDashApp.showLoading(show);
      }
    }

    function showError(message) {
      if (window.CasesDashApp && typeof window.CasesDashApp.showError === 'function') {
        window.CasesDashApp.showError(message);
      }
    }

    function showToast(message, type = 'info') {
      if (window.CasesDashApp && typeof window.CasesDashApp.showToast === 'function') {
        window.CasesDashApp.showToast(message, type);
      }
    }

    function callServerFunction(functionName, ...args) {
      // Try CasesDashApp first, then fallback to direct google.script.run
      if (window.CasesDashApp && typeof window.CasesDashApp.callServerFunction === 'function') {
        return window.CasesDashApp.callServerFunction(functionName, ...args);
      } else if (typeof google !== 'undefined' && google.script && google.script.run) {
        // Direct fallback to google.script.run
        return new Promise((resolve, reject) => {
          try {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              [functionName](...args);
          } catch (error) {
            reject(error);
          }
        });
      } else {
        return Promise.reject(new Error('Server function interface not available'));
      }
    }

    /**
     * Call server function with security context
     */
    function callServerFunctionSecure(functionName, ...args) {
      // Get security context
      const securityContext = {
        timestamp: Date.now(),
        sessionId: getSessionId(),
        csrfToken: getCSRFToken(),
        userAgent: navigator.userAgent
      };
      
      // Add security context as first parameter
      return callServerFunction(functionName, securityContext, ...args);
    }

    /**
     * Get current session ID
     */
    function getSessionId() {
      let sessionId = sessionStorage.getItem('casesdash_session_id');
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('casesdash_session_id', sessionId);
      }
      return sessionId;
    }

    /**
     * Get CSRF token
     */
    function getCSRFToken() {
      let token = localStorage.getItem('casesdash_csrf_token');
      if (!token) {
        token = 'csrf_' + Date.now() + '_' + Math.random().toString(36).substr(2, 16);
        localStorage.setItem('casesdash_csrf_token', token);
      }
      return token;
    }

    /**
     * Get current user info
     */
    function getCurrentUser() {
      try {
        // Try to get from session or return default
        return sessionStorage.getItem('casesdash_current_user') || 'unknown@google.com';
      } catch (error) {
        return 'unknown@google.com';
      }
    }

    /**
     * Reactivate a closed case (Spec 4.2.3)
     */
    async function reactivateCase(caseId, sheetType) {
      try {
        // Show confirmation dialog
        const confirmed = confirm(`Are you sure you want to reactivate case ${caseId}?\n\nThis will change the status back to "Assigned" and make the case active again.`);
        if (!confirmed) return;
        
        showLoading(true);
        
        // Call server function to reactivate the case
        const response = await callServerFunction('reactivateCase', {
          caseId: caseId,
          sheetType: sheetType,
          newStatus: 'Assigned',
          reactivatedBy: getCurrentUser(),
          reactivatedAt: new Date().toISOString(),
          reason: 'Manual reactivation from My Cases view'
        });
        
        if (response.success) {
          showToast(`✅ Case ${caseId} has been successfully reactivated`, 'success');
          
          // Reload the cases list to reflect the status change
          await loadUserCases();
          
          // Log the reactivation action
          console.log(`🔄 Case reactivated: ${caseId} (${sheetType}) by ${getCurrentUser()}`);
          
        } else {
          throw new Error(response.error || 'Failed to reactivate case');
        }
        
      } catch (error) {
        console.error('❌ Case reactivation failed:', error);
        showError(`Failed to reactivate case ${caseId}: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }

    /**
     * Create new case functionality according to specification
     */
    async function createNewCase() {
      try {
        console.log('新しいケース作成開始...');
        
        // Switch to the proper case form view as per specification 4.3.2
        if (window.CasesDashApp && typeof window.CasesDashApp.switchView === 'function') {
          window.CasesDashApp.switchView('case-form');
        }
        
        // Generate the specification-compliant form
        await generateSpecificationCaseForm();
        
      } catch (error) {
        console.error('ケース作成エラー:', error);
        showError('ケース作成フォームの表示に失敗しました: ' + error.message);
      }
    }

    /**
     * Generate specification-compliant case form in the proper view (spec 4.3.2)
     */
    async function generateSpecificationCaseForm() {
      try {
        console.log('🎨 Generating specification-compliant case form...');
        
        // Find the case form container in the proper view
        const caseForm = document.getElementById('case-form');
        if (!caseForm) {
          throw new Error('Case form container not found');
        }
        
        // Generate the form HTML based on specification 4.3.2
        const formHTML = `
          <div class="form-grid">
            
            <div class="form-field">
              <label for="case-id-input">Case ID *</label>
              <input type="text" id="case-id-input" value="${generateCaseId()}" required pattern="\\d-\\d{13}">
              <div class="field-hint">Format: X-1234567890123 (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="case-open-date">Case Open Date *</label>
              <input type="date" id="case-open-date" value="${getCurrentDate()}" required>
              <div class="field-hint">Required field (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="case-open-time">Case Open Time *</label>
              <input type="time" id="case-open-time" value="${getCurrentTime()}" required>
              <div class="field-hint">Required field (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="sheet-type-select">Sheet Type *</label>
              <select id="sheet-type-select" required onchange="handleSheetTypeChange(this.value)">
                <option value="">Select Sheet Type</option>
                <option value="OT Email">OT Email</option>
                <option value="3PO Email">3PO Email</option>
                <option value="OT Chat">OT Chat</option>
                <option value="3PO Chat">3PO Chat</option>
                <option value="OT Phone">OT Phone</option>
                <option value="3PO Phone">3PO Phone</option>
              </select>
              <div class="field-hint">Triggers dynamic form generation (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="incoming-segment">Incoming Segment *</label>
              <select id="incoming-segment" required>
                <option value="">Select Segment</option>
                <option value="Gold" selected>Gold</option>
                <option value="Platinum">Platinum</option>
                <option value="Titanium">Titanium</option>
                <option value="Silver">Silver</option>
                <option value="Bronze - Low">Bronze - Low</option>
                <option value="Bronze - High">Bronze - High</option>
              </select>
              <div class="field-hint">Required field with spec options (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="product-category">Product Category *</label>
              <select id="product-category" required>
                <option value="">Select Category</option>
                <option value="Search" selected>Search</option>
                <option value="Display">Display</option>
                <option value="Video">Video</option>
                <option value="Commerce">Commerce</option>
                <option value="Apps">Apps</option>
                <option value="M&A">M&A</option>
                <option value="Policy">Policy</option>
                <option value="Billing">Billing</option>
                <option value="Other">Other</option>
              </select>
              <div class="field-hint">Required field with spec options (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="first-assignee">1st Assignee *</label>
              <input type="text" id="first-assignee" value="${getCurrentUser()}" required>
              <div class="field-hint">Required field, defaults to current user (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="final-assignee">Final Assignee *</label>
              <input type="text" id="final-assignee" value="${getCurrentUser()}" required>
              <div class="field-hint">Required field, defaults to current user (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="final-segment">Final Segment *</label>
              <select id="final-segment" required>
                <option value="">Select Segment</option>
                <option value="Gold" selected>Gold</option>
                <option value="Platinum">Platinum</option>
                <option value="Titanium">Titanium</option>
                <option value="Silver">Silver</option>
                <option value="Bronze - Low">Bronze - Low</option>
                <option value="Bronze - High">Bronze - High</option>
              </select>
              <div class="field-hint">Required field with spec options (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="case-status">Case Status *</label>
              <select id="case-status" required>
                <option value="Assigned" selected>Assigned</option>
                <option value="Solution Offered">Solution Offered</option>
                <option value="Finished">Finished</option>
              </select>
              <div class="field-hint">Required field with spec options (spec 4.3.2)</div>
            </div>
            
            <div class="form-field">
              <label for="non-ncc">non NCC</label>
              <select id="non-ncc">
                <option value="">Select non NCC</option>
                <option value="Duplicate">Duplicate</option>
                <option value="Discard">Discard</option>
                <option value="Transfer to Platinum">Transfer to Platinum</option>
                <option value="Transfer to S/B">Transfer to S/B</option>
                <option value="Transfer to TDCX">Transfer to TDCX</option>
                <option value="Transfer to 3PO">Transfer to 3PO</option>
                <option value="Transfer to OT">Transfer to OT</option>
                <option value="Transfer to EN Team">Transfer to EN Team</option>
                <option value="Transfer to GMB Team">Transfer to GMB Team</option>
                <option value="Transfer to Other Team (not AM)">Transfer to Other Team (not AM)</option>
              </select>
              <div class="field-hint">Optional field (spec 4.3.2)</div>
            </div>
            
            <div id="issue-category-field" class="form-field" style="display: none;">
              <label for="issue-category">Issue Category *</label>
              <select id="issue-category">
                <option value="">Select Issue Category</option>
                <option value="CBT invo-invo">CBT invo-invo</option>
                <option value="CBT invo-auto">CBT invo-auto</option>
                <option value="CBT (self to self)">CBT (self to self)</option>
                <option value="LC creation">LC creation</option>
                <option value="PP link">PP link</option>
                <option value="PP update">PP update</option>
                <option value="IDT/ Bmod">IDT/ Bmod</option>
                <option value="LCS billing policy">LCS billing policy</option>
                <option value="self serve issue">self serve issue</option>
                <option value="Unidentified Charge">Unidentified Charge</option>
                <option value="CBT Flow">CBT Flow</option>
                <option value="GQ">GQ</option>
                <option value="OOS">OOS</option>
                <option value="Bulk CBT">Bulk CBT</option>
                <option value="CBT ext request">CBT ext request</option>
                <option value="MMS billing policy">MMS billing policy</option>
                <option value="Promotion code">Promotion code</option>
                <option value="Refund">Refund</option>
                <option value="Review">Review</option>
                <option value="TM form">TM form</option>
                <option value="Trademarks issue">Trademarks issue</option>
                <option value="Under Review">Under Review</option>
                <option value="Certificate">Certificate</option>
                <option value="Suspend">Suspend</option>
                <option value="AIV">AIV</option>
                <option value="Complaint">Complaint</option>
              </select>
              <div class="field-hint">Required for 3PO sheets (spec 4.3.2)</div>
            </div>
            
            <div id="details-field" class="form-field" style="display: none; grid-column: 1 / -1;">
              <label for="details">Details</label>
              <textarea id="details" rows="3" maxlength="1000"></textarea>
              <div class="field-hint">Optional field for 3PO sheets (spec 4.3.2)</div>
            </div>
            
            <div id="am-initiated-field" class="form-field" style="display: none;">
              <label class="checkbox-container">
                <input type="checkbox" id="am-initiated">
                <span class="checkmark"></span>
                AM Initiated
              </label>
            </div>
            
            <div class="form-field" style="grid-column: 1 / -1;">
              <h4 style="margin: 20px 0 10px 0; color: var(--md-primary-50);">Additional Options</h4>
              <div class="form-grid">
                <div class="form-field">
                  <label class="checkbox-container">
                    <input type="checkbox" id="triage">
                    <span class="checkmark"></span>
                    Triage
                  </label>
                </div>
                <div class="form-field">
                  <label class="checkbox-container">
                    <input type="checkbox" id="prefer-either">
                    <span class="checkmark"></span>
                    Prefer Either
                  </label>
                </div>
                <div class="form-field">
                  <label class="checkbox-container">
                    <input type="checkbox" id="is-30">
                    <span class="checkmark"></span>
                    Is 3.0
                  </label>
                </div>
                <div class="form-field">
                  <label class="checkbox-container">
                    <input type="checkbox" id="mcc">
                    <span class="checkmark"></span>
                    MCC
                  </label>
                </div>
                <div class="form-field">
                  <label class="checkbox-container">
                    <input type="checkbox" id="change-to-child">
                    <span class="checkmark"></span>
                    Change to Child
                  </label>
                </div>
                <div class="form-field">
                  <label class="checkbox-container">
                    <input type="checkbox" id="bug">
                    <span class="checkmark"></span>
                    Bug
                  </label>
                </div>
                <div class="form-field">
                  <label class="checkbox-container">
                    <input type="checkbox" id="need-info">
                    <span class="checkmark"></span>
                    Need Info
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-actions" style="margin-top: 24px;">
            <button type="button" class="btn btn-primary" onclick="submitSpecificationBasedCase()" id="submit-case-btn">
              <span class="material-symbols-outlined">save</span>
              Create Case (Spec 4.3)
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetSpecificationCaseForm()">
              <span class="material-symbols-outlined">refresh</span>
              Reset Form
            </button>
            <button type="button" class="btn btn-secondary" onclick="cancelCaseForm()">
              <span class="material-symbols-outlined">close</span>
              Cancel
            </button>
          </div>
        `;
        
        // Replace the form content
        caseForm.innerHTML = formHTML;
        
        console.log('✅ Specification-compliant case form generated successfully');
        
      } catch (error) {
        console.error('❌ Failed to generate specification case form:', error);
        throw error;
      }
    }

    /**
     * Fallback case creation using simple form
     */
    async function createNewCaseFallback() {
      console.log('🚧 Using fallback case creation method');
      
      // Get current theme
      const isDark = getCurrentTheme() === 'dark';
      const themeStyles = getThemeStyles(isDark);
      
      // Create a simple case creation modal
      const modalHTML = `
        <div id="simple-case-creation-dialog" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        ">
          <div style="
            background: ${themeStyles.background};
            color: ${themeStyles.text};
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid ${themeStyles.border};
          ">
            <h4 style="margin: 0 0 16px 0; color: ${themeStyles.title};">新しいケースを作成</h4>
            <form id="simple-case-form">
              <div style="margin-bottom: 16px;">
                <label for="case-title" style="display: block; margin-bottom: 4px; color: ${themeStyles.text};">ケースタイトル *</label>
                <input type="text" id="case-title" required style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid ${themeStyles.border};
                  border-radius: 4px;
                  font-size: 14px;
                  background: ${themeStyles.optionBackground};
                  color: ${themeStyles.text};
                ">
              </div>
              <div style="margin-bottom: 16px;">
                <label for="case-description" style="display: block; margin-bottom: 4px; color: ${themeStyles.text};">詳細説明</label>
                <textarea id="case-description" rows="3" style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid ${themeStyles.border};
                  border-radius: 4px;
                  font-size: 14px;
                  resize: vertical;
                  background: ${themeStyles.optionBackground};
                  color: ${themeStyles.text};
                "></textarea>
              </div>
              <div style="margin-bottom: 24px;">
                <label for="case-priority" style="display: block; margin-bottom: 4px; color: ${themeStyles.text};">優先度</label>
                <select id="case-priority" style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid ${themeStyles.border};
                  border-radius: 4px;
                  font-size: 14px;
                  background: ${themeStyles.optionBackground};
                  color: ${themeStyles.text};
                ">
                  <option value="low">低</option>
                  <option value="medium" selected>中</option>
                  <option value="high">高</option>
                  <option value="urgent">緊急</option>
                </select>
              </div>
            </form>
            <div style="text-align: right;">
              <button type="button" onclick="submitSimpleCaseForm()" style="
                background: ${themeStyles.primaryButton};
                color: white;
                border: none;
                padding: 8px 16px;
                margin-left: 8px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s ease;
              "
              onmouseover="this.style.backgroundColor='${themeStyles.primaryButtonHover}'"
              onmouseout="this.style.backgroundColor='${themeStyles.primaryButton}'">
                作成
              </button>
              <button type="button" onclick="closeSimpleCaseDialog()" style="
                background: ${themeStyles.secondaryButton};
                color: white;
                border: none;
                padding: 8px 16px;
                margin-left: 8px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s ease;
              "
              onmouseover="this.style.backgroundColor='${themeStyles.secondaryButtonHover}'"
              onmouseout="this.style.backgroundColor='${themeStyles.secondaryButton}'">
                キャンセル
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('simple-case-creation-dialog');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      console.log('✅ Simple case creation dialog displayed');
    }

    /**
     * Submit simple case form
     */
    async function submitSimpleCaseForm() {
      try {
        const title = document.getElementById('case-title').value.trim();
        const description = document.getElementById('case-description').value.trim();
        const priority = document.getElementById('case-priority').value;
        
        if (!title) {
          showError('ケースタイトルを入力してください');
          return;
        }
        
        console.log('📝 Submitting simple case:', { title, description, priority });
        
        const caseData = {
          title: title,
          description: description,
          priority: priority,
          status: 'open',
          createdDate: new Date().toISOString(),
          sheetType: 'General'
        };
        
        showLoading(true);
        
        // Try to call server function
        const response = await callServerFunction('createCase', caseData);
        
        if (response && response.success) {
          showToast('ケースが正常に作成されました', 'success');
          closeSimpleCaseDialog();
          if (typeof loadUserCases === 'function') {
            loadUserCases();
          }
        } else {
          throw new Error(response?.error || 'ケースの作成に失敗しました');
        }
        
      } catch (error) {
        console.error('Simple case submission error:', error);
        showError('ケースの作成に失敗しました: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    /**
     * Generate form fields HTML based on configuration (spec 4.3.2)
     */
    function generateFormFieldsHTML(fields, themeStyles) {
      let html = '';
      
      Object.entries(fields).forEach(([fieldName, config]) => {
        const fieldId = `field-${fieldName}`;
        const isRequired = config.required ? ' *' : '';
        const requiredAttr = config.required ? 'required' : '';
        
        html += `
          <div style="margin-bottom: 20px;">
            <label for="${fieldId}" style="
              display: block;
              margin-bottom: 8px;
              color: ${themeStyles.text};
              font-weight: 500;
              font-size: 16px;
            ">${escapeHtml(config.label)}${isRequired}</label>
        `;
        
        // Generate field based on type
        switch (config.type) {
          case 'text':
            html += `
              <input type="text" id="${fieldId}" name="${fieldName}" ${requiredAttr}
                     placeholder="${config.format || ''}" style="
                width: 100%;
                padding: 12px;
                border: 2px solid ${themeStyles.border};
                border-radius: 8px;
                font-size: 16px;
                background: ${themeStyles.optionBackground};
                color: ${themeStyles.text};
                transition: border-color 0.2s ease;
              "
              onfocus="this.style.borderColor='${themeStyles.primaryButton}'"
              onblur="this.style.borderColor='${themeStyles.border}'">
            `;
            break;
            
          case 'date':
            html += `
              <input type="date" id="${fieldId}" name="${fieldName}" ${requiredAttr} style="
                width: 100%;
                padding: 12px;
                border: 2px solid ${themeStyles.border};
                border-radius: 8px;
                font-size: 16px;
                background: ${themeStyles.optionBackground};
                color: ${themeStyles.text};
                transition: border-color 0.2s ease;
              "
              onfocus="this.style.borderColor='${themeStyles.primaryButton}'"
              onblur="this.style.borderColor='${themeStyles.border}'">
            `;
            break;
            
          case 'time':
            html += `
              <input type="time" id="${fieldId}" name="${fieldName}" ${requiredAttr} style="
                width: 100%;
                padding: 12px;
                border: 2px solid ${themeStyles.border};
                border-radius: 8px;
                font-size: 16px;
                background: ${themeStyles.optionBackground};
                color: ${themeStyles.text};
                transition: border-color 0.2s ease;
              "
              onfocus="this.style.borderColor='${themeStyles.primaryButton}'"
              onblur="this.style.borderColor='${themeStyles.border}'">
            `;
            break;
            
          case 'select':
            html += `
              <select id="${fieldId}" name="${fieldName}" ${requiredAttr} style="
                width: 100%;
                padding: 12px;
                border: 2px solid ${themeStyles.border};
                border-radius: 8px;
                font-size: 16px;
                background: ${themeStyles.optionBackground};
                color: ${themeStyles.text};
                transition: border-color 0.2s ease;
                cursor: pointer;
              "
              onfocus="this.style.borderColor='${themeStyles.primaryButton}'"
              onblur="this.style.borderColor='${themeStyles.border}'">
            `;
            
            if (config.required) {
              html += `<option value="">-- Select ${config.label} --</option>`;
            }
            
            config.options.forEach(option => {
              const isDefault = config.default === option;
              html += `<option value="${escapeHtml(option)}" ${isDefault ? 'selected' : ''}>${escapeHtml(option)}</option>`;
            });
            
            html += `</select>`;
            break;
            
          case 'textarea':
            html += `
              <textarea id="${fieldId}" name="${fieldName}" rows="3" ${requiredAttr} style="
                width: 100%;
                padding: 12px;
                border: 2px solid ${themeStyles.border};
                border-radius: 8px;
                font-size: 16px;
                resize: vertical;
                background: ${themeStyles.optionBackground};
                color: ${themeStyles.text};
                transition: border-color 0.2s ease;
                font-family: inherit;
              "
              onfocus="this.style.borderColor='${themeStyles.primaryButton}'"
              onblur="this.style.borderColor='${themeStyles.border}'"
              placeholder="Enter ${config.label.toLowerCase()}..."></textarea>
            `;
            break;
            
          case 'checkbox':
            html += `
              <div style="display: flex; align-items: center; padding: 12px; background: ${themeStyles.optionBackground}; border-radius: 8px;">
                <input type="checkbox" id="${fieldId}" name="${fieldName}" value="1" style="
                  margin-right: 12px;
                  transform: scale(1.2);
                  cursor: pointer;
                ">
                <label for="${fieldId}" style="cursor: pointer; color: ${themeStyles.text}; margin: 0;">
                  ${escapeHtml(config.label)}
                </label>
              </div>
            `;
            break;
        }
        
        html += `</div>`;
      });
      
      return html;
    }

    /**
     * Set default values for form fields
     */
    function setFormDefaultValues(formConfig) {
      Object.entries(formConfig.fields).forEach(([fieldName, config]) => {
        const fieldElement = document.getElementById(`field-${fieldName}`);
        if (!fieldElement) return;
        
        let defaultValue = config.default;
        
        // Handle special default values
        if (defaultValue === 'today') {
          defaultValue = new Date().toISOString().split('T')[0];
        } else if (defaultValue === 'now') {
          defaultValue = new Date().toTimeString().split(' ')[0].substring(0, 8);
        } else if (defaultValue === 'currentUser') {
          // Get current user from session or default
          defaultValue = Session?.getActiveUser()?.getEmail()?.split('@')[0] || 'unknown';
        }
        
        if (defaultValue !== undefined) {
          if (config.type === 'checkbox') {
            fieldElement.checked = Boolean(defaultValue);
          } else {
            fieldElement.value = defaultValue;
          }
        }
      });
    }

    /**
     * Close dynamic case creation dialog
     */
    function closeDynamicCaseDialog() {
      const modal = document.getElementById('dynamic-case-creation-dialog');
      if (modal) {
        modal.style.display = 'none';
        modal.remove();
      }
    }

    /**
     * Close integrated case creation dialog (legacy)
     */
    function closeIntegratedCaseDialog() {
      const modal = document.getElementById('integrated-case-creation-dialog');
      if (modal) {
        modal.style.display = 'none';
        modal.remove();
      }
    }

    /**
     * Submit dynamic case form with security and proper mapping (spec 4.3.2)
     */
    async function submitDynamicCaseForm() {
      try {
        const form = document.getElementById('dynamic-case-form');
        const sheetType = form.dataset.sheetType;
        
        console.log('📝 Starting dynamic case form submission for:', sheetType);
        
        // Collect form data
        const formData = new FormData(form);
        const caseData = {
          sheetType: sheetType,
          channel: getChannelType(sheetType),
          createdBy: getCurrentUser(),
          createdDate: new Date().toISOString()
        };
        
        // Convert FormData to object with proper typing
        for (const [key, value] of formData.entries()) {
          const fieldElement = document.getElementById(`field-${key}`);
          if (fieldElement && fieldElement.type === 'checkbox') {
            caseData[key] = fieldElement.checked;
          } else if (fieldElement && fieldElement.type === 'number') {
            caseData[key] = parseFloat(value) || 0;
          } else {
            caseData[key] = value;
          }
        }
        
        console.log('📋 Collected case data:', { sheetType, caseDataKeys: Object.keys(caseData) });
        
        // Validate required fields
        const validation = validateDynamicForm(form, sheetType);
        if (!validation.isValid) {
          showError(validation.errorMessage);
          return;
        }
        
        // Add security context for backend integration
        const securityContext = {
          timestamp: Date.now(),
          sessionId: getSessionId(),
          csrfToken: getCSRFToken(),
          userAgent: navigator.userAgent,
          referrer: document.referrer
        };
        
        console.log('🔒 Adding security context for backend integration');
        
        showLoading(true);
        
        // Call server function with security context
        console.log('📡 Calling createCase with enhanced integration...');
        const response = await callServerFunctionSecure('createCase', caseData, securityContext);
        
        if (response && response.success) {
          console.log('✅ Case created successfully:', response);
          showToast(`✅ Case ${response.data?.caseId || 'created'} successfully saved to ${sheetType}`, 'success');
          closeDynamicCaseDialog();
          
          // Refresh case list if available
          if (typeof loadUserCases === 'function') {
            loadUserCases();
          }
          
          // Show case details if available
          if (response.data?.caseId) {
            setTimeout(() => {
              showToast(`Case ID: ${response.data.caseId} - Check ${sheetType} sheet`, 'info');
            }, 1000);
          }
        } else {
          console.error('❌ Server response indicates failure:', response);
          throw new Error(response?.error || response?.message || 'Failed to create case');
        }
        
      } catch (error) {
        console.error('❌ Dynamic case submission error:', error);
        if (error.message.includes('Authentication')) {
          showError('Authentication required. Please refresh and try again.');
        } else if (error.message.includes('Validation')) {
          showError('Please check your input and try again.');
        } else {
          showError('Failed to create case: ' + error.message);
        }
      } finally {
        showLoading(false);
      }
    }

    /**
     * Validate dynamic form based on specification
     */
    function validateDynamicForm(form, sheetType) {
      const requiredFields = ['caseId', 'caseOpenDate', 'caseOpenTime', 'incomingSegment', 'productCategory', 'firstAssignee', 'caseStatus'];
      
      // Add 3PO specific required fields
      if (sheetType.includes('3PO')) {
        requiredFields.push('issueCategory');
      }
      
      for (const fieldName of requiredFields) {
        const fieldElement = document.getElementById(`field-${fieldName}`);
        if (!fieldElement) continue;
        
        const value = fieldElement.type === 'checkbox' ? fieldElement.checked : fieldElement.value.trim();
        
        if (!value) {
          const label = fieldElement.closest('div').querySelector('label').textContent.replace(' *', '');
          fieldElement.focus();
          return {
            isValid: false,
            errorMessage: `${label} is required`
          };
        }
        
        // Validate Case ID format (spec: X-1234567890123)
        if (fieldName === 'caseId') {
          const caseIdPattern = /^\d-\d{13}$/;
          if (!caseIdPattern.test(value)) {
            fieldElement.focus();
            return {
              isValid: false,
              errorMessage: 'Case ID must be in format: X-1234567890123 (where X is any digit)'
            };
          }
        }
      }
      
      return { isValid: true };
    }

    /**
     * Submit integrated case form (legacy)
     */
    async function submitIntegratedCaseForm() {
      try {
        const caseType = document.getElementById('case-type-select').value.trim();
        const title = document.getElementById('case-title-input').value.trim();
        const description = document.getElementById('case-description-input').value.trim();
        const priority = document.getElementById('case-priority-select').value;
        const customerInfo = document.getElementById('customer-info-input').value.trim();
        
        // Validation
        if (!caseType) {
          showError('ケースタイプを選択してください');
          document.getElementById('case-type-select').focus();
          return;
        }
        
        if (!title) {
          showError('ケースタイトルを入力してください');
          document.getElementById('case-title-input').focus();
          return;
        }
        
        console.log('📝 Submitting integrated case:', {
          caseType, title, description, priority, customerInfo
        });
        
        // Prepare case data
        const caseData = {
          sheetType: caseType,
          title: title,
          description: description,
          priority: priority,
          customerInfo: customerInfo,
          status: 'open',
          createdDate: new Date().toISOString(),
          assignee: Session?.getActiveUser()?.getEmail() || 'Unknown'
        };
        
        showLoading(true);
        
        // Call server function to create case
        const response = await callServerFunction('createCase', caseData);
        
        if (response && response.success) {
          showToast('✅ ケースが正常に作成されました', 'success');
          closeIntegratedCaseDialog();
          
          // Refresh case list if available
          if (typeof loadUserCases === 'function') {
            loadUserCases();
          }
        } else {
          throw new Error(response?.error || 'ケースの作成に失敗しました');
        }
        
      } catch (error) {
        console.error('❌ Integrated case submission error:', error);
        showError('ケースの作成に失敗しました: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    /**
     * Close simple case creation dialog
     */
    function closeSimpleCaseDialog() {
      const modal = document.getElementById('simple-case-creation-dialog');
      if (modal) {
        modal.style.display = 'none';
        modal.remove();
      }
    }

    /**
     * Show case creation form according to specification 4.3
     */
    async function showCaseCreationForm() {
      try {
        console.log('🔍 Attempting to get available sheet types...');
        
        // Get available sheet types from server
        const response = await callServerFunction('getAvailableSheetTypes');
        
        console.log('📊 Server response for sheet types:', response);
        
        if (!response.success || !response.data || !response.data.length) {
          console.log('⚠️ No sheet types available, using default');
          // Use default sheet types per specification
          const defaultSheetTypes = ['OT Email', '3PO Email', 'OT Chat', '3PO Chat', 'OT Phone', '3PO Phone'];
          displaySheetTypeSelection(defaultSheetTypes);
        } else {
          const sheetTypes = response.data;
          console.log('✅ Found sheet types:', sheetTypes);
          displaySheetTypeSelection(sheetTypes);
        }
        
      } catch (error) {
        console.error('シートタイプ取得エラー:', error);
        console.log('🔄 Using default form due to error');
        const defaultSheetTypes = ['OT Email', '3PO Email', 'OT Chat', '3PO Chat', 'OT Phone', '3PO Phone'];
        displaySheetTypeSelection(defaultSheetTypes);
      }
    }

    /**
     * Display dynamic case creation form based on sheet type (spec 4.3.2)
     */
    function displayDynamicCaseCreationForm(sheetType, formConfig) {
      console.log('🎨 Displaying dynamic case creation form for:', sheetType);
      console.log('🔍 Form config:', formConfig);
      
      // Get current theme
      const isDark = getCurrentTheme() === 'dark';
      const themeStyles = getThemeStyles(isDark);
      
      // Generate form fields HTML based on configuration
      const formFieldsHTML = generateFormFieldsHTML(formConfig.fields, themeStyles);
      
      const modalHTML = `
        <div id="dynamic-case-creation-dialog" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        ">
          <div style="
            background: ${themeStyles.background};
            color: ${themeStyles.text};
            border-radius: 12px;
            padding: 32px;
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 1px solid ${themeStyles.border};
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h3 style="margin: 0; color: ${themeStyles.title}; font-size: 24px;">
                📝 Create New Case - ${escapeHtml(sheetType)}
              </h3>
              <button onclick="closeDynamicCaseDialog()" style="
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: ${themeStyles.subtitle};
                padding: 4px;
                transition: color 0.2s ease;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
              "
              onmouseover="this.style.color='${themeStyles.text}'; this.style.backgroundColor='${themeStyles.optionHover}'"
              onmouseout="this.style.color='${themeStyles.subtitle}'; this.style.backgroundColor='transparent'">&times;</button>
            </div>
            
            <div style="background: ${themeStyles.optionBackground}; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid ${themeStyles.primaryButton};">
              <p style="margin: 0; font-size: 14px; color: ${themeStyles.text};">
                <strong>Sheet Type:</strong> ${escapeHtml(sheetType)} |
                <strong>Channel:</strong> ${escapeHtml(formConfig.channelType)} |
                <strong>Type:</strong> ${formConfig.is3PO ? '3PO' : 'OT'}
              </p>
            </div>
            
            <form id="dynamic-case-form" data-sheet-type="${escapeHtml(sheetType)}">
              ${formFieldsHTML}
            </form>
            
            <!-- Action Buttons -->
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-top: 32px;
              padding-top: 24px;
              border-top: 1px solid ${themeStyles.border};
            ">
              <button type="button" onclick="closeDynamicCaseDialog()" style="
                background: ${themeStyles.secondaryButton};
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                transition: all 0.2s ease;
                min-width: 120px;
              "
              onmouseover="this.style.backgroundColor='${themeStyles.secondaryButtonHover}'; this.style.transform='translateY(-1px)'"
              onmouseout="this.style.backgroundColor='${themeStyles.secondaryButton}'; this.style.transform='translateY(0)'">
                Cancel
              </button>
              
              <button type="button" onclick="submitDynamicCaseForm()" style="
                background: ${themeStyles.primaryButton};
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                transition: all 0.2s ease;
                min-width: 120px;
                box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
              "
              onmouseover="this.style.backgroundColor='${themeStyles.primaryButtonHover}'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(25, 118, 210, 0.4)'"
              onmouseout="this.style.backgroundColor='${themeStyles.primaryButton}'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(25, 118, 210, 0.3)'">
                Create Case
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('dynamic-case-creation-dialog');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Set default values
      setFormDefaultValues(formConfig);
      
      console.log('✅ Dynamic case creation form displayed');
    }
    
    /**
     * Get current theme from theme manager
     */
    function getCurrentTheme() {
      try {
        if (window.CasesDashThemeManager && typeof window.CasesDashThemeManager.getCurrentTheme === 'function') {
          return window.CasesDashThemeManager.getCurrentTheme();
        }
        
        // Fallback: check for theme in localStorage or document
        const savedTheme = localStorage.getItem('casesdash-theme');
        if (savedTheme) {
          return savedTheme;
        }
        
        // Check if dark mode is active in document
        if (document.body.classList.contains('dark-theme') ||
            document.documentElement.classList.contains('dark-theme')) {
          return 'dark';
        }
        
        return 'light';
      } catch (error) {
        console.warn('Failed to get current theme:', error);
        return 'light';
      }
    }
    
    /**
     * Get theme-specific styles
     */
    function getThemeStyles(isDark) {
      if (isDark) {
        return {
          background: '#1e1e1e',
          text: '#ffffff',
          title: '#ffffff',
          subtitle: '#b3b3b3',
          border: '#444444',
          optionBackground: '#2d2d2d',
          optionBorder: '#444444',
          optionHover: '#3d3d3d',
          primaryButton: '#1976d2',
          primaryButtonHover: '#1565c0',
          secondaryButton: '#666666',
          secondaryButtonHover: '#555555'
        };
      } else {
        return {
          background: '#ffffff',
          text: '#333333',
          title: '#333333',
          subtitle: '#666666',
          border: '#e0e0e0',
          optionBackground: '#fafafa',
          optionBorder: '#ddd',
          optionHover: '#f0f0f0',
          primaryButton: '#1976d2',
          primaryButtonHover: '#1565c0',
          secondaryButton: '#666666',
          secondaryButtonHover: '#555555'
        };
      }
    }
    
    /**
     * Select sheet type and highlight selection
     */
    function selectSheetType(sheetTypeName, element) {
      console.log('🎯 Sheet type selected:', sheetTypeName);
      
      // Get current theme styles
      const isDark = getCurrentTheme() === 'dark';
      const themeStyles = getThemeStyles(isDark);
      
      // Clear previous selections
      const options = document.querySelectorAll('#sheet-type-selection-dialog .sheet-type-options > div');
      options.forEach(option => {
        option.style.backgroundColor = themeStyles.optionBackground;
        option.style.borderColor = themeStyles.optionBorder;
      });
      
      // Highlight selected option
      element.style.backgroundColor = isDark ? '#1565c0' : '#e3f2fd';
      element.style.borderColor = '#1976d2';
      
      // Select radio button
      const radio = element.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
      }
    }

    /**
     * Proceed with selected sheet type to generate dynamic form (spec 4.3.2)
     */
    async function proceedWithSelectedSheetType() {
      try {
        const selectedRadio = document.querySelector('input[name="sheetType"]:checked');
        if (!selectedRadio) {
          showError('ケースタイプを選択してください');
          return;
        }
        
        const selectedSheetType = selectedRadio.value;
        console.log('🎯 選択されたシートタイプ:', selectedSheetType);
        
        // Validate selected sheet type
        if (!selectedSheetType || selectedSheetType.trim() === '') {
          console.error('❌ Invalid sheet type selected:', selectedSheetType);
          showError('有効なケースタイプを選択してください');
          return;
        }
        
        // Close selection dialog
        closeSheetTypeDialog();
        
        // Show loading indicator
        showLoading(true);
        
        try {
          // Generate dynamic form based on selected sheet type (spec 4.3.2)
          await generateDynamicCaseForm(selectedSheetType);
        } catch (formError) {
          console.error('🔄 Dynamic form generation failed, using fallback:', formError);
          // Fallback to simple case creation
          await createNewCaseFallback();
        } finally {
          showLoading(false);
        }
        
      } catch (error) {
        console.error('❌ フォーム生成エラー:', error);
        showError('フォームの生成に失敗しました: ' + error.message);
        showLoading(false);
      }
    }

    /**
     * Generate dynamic case creation form based on sheet type (spec 4.3.2)
     */
    async function generateDynamicCaseForm(sheetType) {
      try {
        console.log('🎨 動的フォーム生成開始 - シートタイプ:', sheetType);
        
        // Determine form fields based on sheet type
        const formConfig = getDynamicFormConfig(sheetType);
        
        // Display dynamic form modal
        displayDynamicCaseCreationForm(sheetType, formConfig);
        
        console.log('✅ Dynamic case creation form generated successfully');
        
      } catch (error) {
        console.error('❌ 動的フォーム生成エラー:', error);
        throw error;
      }
    }

    /**
     * Get form configuration based on sheet type (spec 4.3.2)
     */
    function getDynamicFormConfig(sheetType) {
      // Common fields for all sheets (spec section: 共通フィールド（全シート）)
      const commonFields = {
        caseId: { type: 'text', label: 'Case ID', required: true, format: 'X-1234567890123' },
        caseOpenDate: { type: 'date', label: 'Case Open Date', required: true, default: 'today' },
        caseOpenTime: { type: 'time', label: 'Case Open Time', required: true, default: 'now' },
        incomingSegment: {
          type: 'select',
          label: 'Incoming Segment',
          required: true,
          options: ['Gold', 'Platinum', 'Titanium', 'Silver', 'Bronze - Low', 'Bronze - High'],
          default: 'Gold'
        },
        productCategory: {
          type: 'select',
          label: 'Product Category',
          required: true,
          options: ['Search', 'Display', 'Video', 'Commerce', 'Apps', 'M&A', 'Policy', 'Billing', 'Other'],
          default: 'Search'
        },
        triage: { type: 'checkbox', label: 'Triage', default: false },
        preferEither: { type: 'checkbox', label: 'Prefer Either', default: false },
        is30: { type: 'checkbox', label: 'Is 3.0', default: false },
        firstAssignee: {
          type: 'text',
          label: '1st Assignee',
          required: true,
          default: 'currentUser'
        },
        mcc: { type: 'checkbox', label: 'MCC', default: false },
        changeToChild: { type: 'checkbox', label: 'Change to Child', default: false },
        caseStatus: {
          type: 'select',
          label: 'Case Status',
          required: true,
          options: ['Assigned', 'Solution Offered', 'Finished'],
          default: 'Assigned'
        },
        bug: { type: 'checkbox', label: 'Bug', default: false },
        needInfo: { type: 'checkbox', label: 'Need Info', default: false }
      };

      // Sheet-specific fields
      let specificFields = {};
      
      // OT Email specific fields (spec: OT Email特有フィールド)
      if (sheetType === 'OT Email') {
        specificFields.amInitiated = { type: 'checkbox', label: 'AM Initiated', default: false };
      }
      
      // 3PO specific fields (spec: 3POシート特有フィールド)
      if (sheetType.includes('3PO')) {
        specificFields.issueCategory = {
          type: 'select',
          label: 'Issue Category',
          required: true,
          options: [
            'CBT invo-invo', 'CBT invo-auto', 'CBT (self to self)', 'LC creation',
            'PP link', 'PP update', 'IDT/ Bmod', 'LCS billing policy', 'self serve issue',
            'Unidentified Charge', 'CBT Flow', 'GQ', 'OOS', 'Bulk CBT', 'CBT ext request',
            'MMS billing policy', 'Promotion code', 'Refund', 'Review', 'TM form',
            'Trademarks issue', 'Under Review', 'Certificate', 'Suspend', 'AIV', 'Complaint'
          ]
        };
        specificFields.details = { type: 'textarea', label: 'Details', required: false };
      }

      return {
        sheetType: sheetType,
        fields: { ...commonFields, ...specificFields },
        channelType: getChannelType(sheetType),
        is3PO: sheetType.includes('3PO')
      };
    }

    /**
     * Get channel type from sheet name
     */
    function getChannelType(sheetType) {
      if (sheetType.includes('Email')) return 'Email';
      if (sheetType.includes('Chat')) return 'Chat';
      if (sheetType.includes('Phone')) return 'Phone';
      return 'Unknown';
    }


    /**
     * Display case creation form modal with FormGenerator
     */
    function displayCaseCreationFormModal(containerId, sheetType, formGenerator) {
      // Get current theme
      const isDark = getCurrentTheme() === 'dark';
      const themeStyles = getThemeStyles(isDark);
      
      const modalHTML = `
        <div id="case-creation-dialog" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        ">
          <div style="
            background: ${themeStyles.background};
            color: ${themeStyles.text};
            border-radius: 8px;
            padding: 24px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid ${themeStyles.border};
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0; color: ${themeStyles.title};">新しいケースを作成 - ${escapeHtml(sheetType)}</h4>
              <button onclick="closeCaseCreationDialog()" style="
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: ${themeStyles.subtitle};
                padding: 4px;
                transition: color 0.2s ease;
              "
              onmouseover="this.style.color='${themeStyles.text}'"
              onmouseout="this.style.color='${themeStyles.subtitle}'">&times;</button>
            </div>
            <div id="${containerId}"></div>
            <div style="text-align: right; margin-top: 16px; border-top: 1px solid ${themeStyles.border}; padding-top: 16px;">
              <button type="button" onclick="closeCaseCreationDialog()" style="
                background: ${themeStyles.secondaryButton};
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s ease;
              "
              onmouseover="this.style.backgroundColor='${themeStyles.secondaryButtonHover}'"
              onmouseout="this.style.backgroundColor='${themeStyles.secondaryButton}'">
                キャンセル
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('case-creation-dialog');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      console.log('✅ Case creation form modal displayed');
      
      // Generate form using FormGenerator
      try {
        formGenerator.generateForm(containerId);
        console.log('✅ FormGenerator form generated successfully');
      } catch (error) {
        console.error('フォーム生成エラー:', error);
        const container = document.getElementById(containerId);
        if (container) {
          container.innerHTML = `
            <div style="
              padding: 20px;
              border: 1px solid #f44336;
              border-radius: 4px;
              background-color: ${isDark ? '#2d1b1b' : '#ffebee'};
              color: ${isDark ? '#ff6b6b' : '#c62828'};
            ">
              <p><strong>フォームの生成に失敗しました。</strong></p>
              <p>${escapeHtml(error.message)}</p>
              <button onclick="closeCaseCreationDialog(); ${window.CasesDashCaseManager ? 'window.CasesDashCaseManager.createNewCaseFallback()' : 'createNewCaseFallback()'};" style="
                background: ${themeStyles.primaryButton};
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 8px;
                transition: background 0.2s ease;
              "
              onmouseover="this.style.backgroundColor='${themeStyles.primaryButtonHover}'"
              onmouseout="this.style.backgroundColor='${themeStyles.primaryButton}'">
                シンプルフォームを使用
              </button>
            </div>
          `;
        }
      }
    }


    /**
     * Close sheet type selection dialog
     */
    function closeSheetTypeDialog() {
      const modal = document.getElementById('sheet-type-selection-dialog');
      if (modal) {
        modal.style.display = 'none';
        modal.remove();
      }
    }

    /**
     * Display sheet type selection dialog (spec 4.3.1)
     */
    function displaySheetTypeSelection(sheetTypes) {
      console.log('🎯 Displaying sheet type selection for:', sheetTypes);
      
      // Get current theme
      const isDark = getCurrentTheme() === 'dark';
      const themeStyles = getThemeStyles(isDark);
      
      const modalHTML = `
        <div id="sheet-type-selection-dialog" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        ">
          <div style="
            background: ${themeStyles.background};
            color: ${themeStyles.text};
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 1px solid ${themeStyles.border};
          ">
            <h3 style="margin: 0 0 24px 0; color: ${themeStyles.title}; font-size: 24px;">
              📋 Select Case Type
            </h3>
            
            <p style="margin-bottom: 24px; color: ${themeStyles.subtitle}; font-size: 16px;">
              Choose the sheet type for your new case. This will determine which fields are available and how the case is processed.
            </p>
            
            <div class="sheet-type-options">
              ${sheetTypes.map(sheetType => `
                <div onclick="selectSheetType('${escapeHtml(sheetType)}', this)" style="
                  padding: 16px;
                  margin-bottom: 12px;
                  border: 2px solid ${themeStyles.optionBorder};
                  border-radius: 8px;
                  cursor: pointer;
                  background: ${themeStyles.optionBackground};
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                "
                onmouseover="this.style.backgroundColor='${themeStyles.optionHover}'"
                onmouseout="this.style.backgroundColor='${themeStyles.optionBackground}'">
                  <div style="display: flex; align-items: center;">
                    <input type="radio" name="sheetType" value="${escapeHtml(sheetType)}" style="margin-right: 12px; transform: scale(1.2);">
                    <span style="font-weight: 500; font-size: 16px;">${escapeHtml(sheetType)}</span>
                  </div>
                  <div style="font-size: 12px; color: ${themeStyles.subtitle};">
                    ${getSheetTypeDescription(sheetType)}
                  </div>
                </div>
              `).join('')}
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 32px; padding-top: 24px; border-top: 1px solid ${themeStyles.border};">
              <button onclick="closeSheetTypeDialog()" style="
                background: ${themeStyles.secondaryButton};
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                transition: all 0.2s ease;
                min-width: 120px;
              "
              onmouseover="this.style.backgroundColor='${themeStyles.secondaryButtonHover}'"
              onmouseout="this.style.backgroundColor='${themeStyles.secondaryButton}'">
                Cancel
              </button>
              
              <button onclick="proceedWithSelectedSheetType()" style="
                background: ${themeStyles.primaryButton};
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                transition: all 0.2s ease;
                min-width: 120px;
                box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
              "
              onmouseover="this.style.backgroundColor='${themeStyles.primaryButtonHover}'; this.style.transform='translateY(-2px)'"
              onmouseout="this.style.backgroundColor='${themeStyles.primaryButton}'; this.style.transform='translateY(0)'">
                Continue
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('sheet-type-selection-dialog');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      console.log('✅ Sheet type selection dialog displayed');
    }

    /**
     * Get sheet type description for UI
     */
    function getSheetTypeDescription(sheetType) {
      const descriptions = {
        'OT Email': 'Email channel, OT cases',
        '3PO Email': 'Email channel, 3PO cases with categories',
        'OT Chat': 'Chat channel, OT cases',
        '3PO Chat': 'Chat channel, 3PO cases with categories',
        'OT Phone': 'Phone channel, OT cases',
        '3PO Phone': 'Phone channel, 3PO cases with categories'
      };
      return descriptions[sheetType] || 'Standard case type';
    }

    /**
     * Close case creation dialog
     */
    function closeCaseCreationDialog() {
      const modal = document.getElementById('case-creation-dialog');
      if (modal) {
        modal.style.display = 'none';
        modal.remove();
      }
    }

    /**
     * Helper functions for specification-compliant Create Case form (spec 4.3.2)
     */
    
    /**
     * Generate unique Case ID in specification format (X-1234567890123)
     */
    function generateCaseId() {
      try {
        const timestamp = Date.now().toString();
        const randomDigit = Math.floor(Math.random() * 10);
        // Format: X-1234567890123 (where X is random digit, followed by 13 digits)
        const caseId = `${randomDigit}-${timestamp.slice(-13).padStart(13, '0')}`;
        console.log('🆔 Generated Case ID:', caseId);
        return caseId;
      } catch (error) {
        console.error('❌ Failed to generate Case ID:', error);
        // Fallback format
        return `${Math.floor(Math.random() * 10)}-${Date.now().toString().slice(-13)}`;
      }
    }

    /**
     * Get current date in YYYY-MM-DD format
     */
    function getCurrentDate() {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      } catch (error) {
        console.error('❌ Failed to get current date:', error);
        return new Date().toISOString().split('T')[0];
      }
    }

    /**
     * Get current time in HH:MM format
     */
    function getCurrentTime() {
      try {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      } catch (error) {
        console.error('❌ Failed to get current time:', error);
        const fallback = new Date().toTimeString().slice(0, 5);
        return fallback;
      }
    }

    /**
     * Handle sheet type change to show/hide 3PO-specific fields
     */
    function handleSheetTypeChange(selectedSheetType) {
      try {
        console.log('📋 Sheet type changed to:', selectedSheetType);
        
        // Get 3PO-specific fields
        const issueCategoryField = document.getElementById('issue-category-field');
        const detailsField = document.getElementById('details-field');
        const amInitiatedField = document.getElementById('am-initiated-field');
        
        if (selectedSheetType.includes('3PO')) {
          // Show 3PO fields
          if (issueCategoryField) issueCategoryField.style.display = 'block';
          if (detailsField) detailsField.style.display = 'block';
          if (amInitiatedField) amInitiatedField.style.display = 'none'; // Hide AM Initiated for 3PO
          console.log('✅ Showing 3PO-specific fields');
        } else {
          // Hide 3PO fields for OT cases
          if (issueCategoryField) issueCategoryField.style.display = 'none';
          if (detailsField) detailsField.style.display = 'none';
          if (amInitiatedField && selectedSheetType.includes('Email')) {
            amInitiatedField.style.display = 'block'; // Show AM Initiated for OT Email only
          }
          console.log('✅ Hiding 3PO-specific fields');
        }
      } catch (error) {
        console.error('❌ Failed to handle sheet type change:', error);
      }
    }

    /**
     * Submit specification-based case form (spec 4.3.2)
     */
    async function submitSpecificationBasedCase() {
      try {
        console.log('📤 Starting specification-based case submission...');
        
        // Show loading
        if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
          window.CasesDashApp.showLoading(true);
        }
        
        // Collect form data from specification form
        const formData = {
          caseId: document.getElementById('case-id-input')?.value?.trim(),
          caseOpenDate: document.getElementById('case-open-date')?.value,
          caseOpenTime: document.getElementById('case-open-time')?.value,
          sheetType: document.getElementById('sheet-type-select')?.value,
          incomingSegment: document.getElementById('incoming-segment')?.value,
          productCategory: document.getElementById('product-category')?.value,
          firstAssignee: document.getElementById('first-assignee')?.value?.trim(),
          finalAssignee: document.getElementById('final-assignee')?.value?.trim(),
          finalSegment: document.getElementById('final-segment')?.value,
          caseStatus: document.getElementById('case-status')?.value,
          nonNCC: document.getElementById('non-ncc')?.value || '',
          
          // Checkboxes
          triage: document.getElementById('triage')?.checked || false,
          preferEither: document.getElementById('prefer-either')?.checked || false,
          is30: document.getElementById('is-30')?.checked || false,
          mcc: document.getElementById('mcc')?.checked || false,
          changeToChild: document.getElementById('change-to-child')?.checked || false,
          bug: document.getElementById('bug')?.checked || false,
          needInfo: document.getElementById('need-info')?.checked || false,
          
          // 3PO specific fields (conditionally included)
          issueCategory: document.getElementById('issue-category')?.value || '',
          details: document.getElementById('details')?.value?.trim() || '',
          
          // OT Email specific field
          amInitiated: document.getElementById('am-initiated')?.checked || false
        };
        
        console.log('📋 Collected form data:', formData);
        
        // Validate required fields
        const validationResult = validateSpecificationForm(formData);
        if (!validationResult.isValid) {
          showError(validationResult.message);
          return;
        }
        
        // Add metadata
        formData.createdBy = getCurrentUser();
        formData.createdDate = new Date().toISOString();
        formData.channel = getChannelType(formData.sheetType);
        
        console.log('📡 Submitting case to server...');
        
        // Call server function to create case
        const response = await callServerFunction('createCase', formData);
        
        if (response && response.success) {
          console.log('✅ Case created successfully:', response);
          showToast(`✅ Case ${formData.caseId} created successfully in ${formData.sheetType}!`, 'success');
          
          // Reset form
          resetSpecificationCaseForm();
          
          // Refresh case list if available
          if (typeof loadUserCases === 'function') {
            setTimeout(() => loadUserCases(), 1000);
          }
          
          // Switch back to dashboard
          if (window.CasesDashApp && typeof window.CasesDashApp.showDashboard === 'function') {
            setTimeout(() => window.CasesDashApp.showDashboard(), 2000);
          }
          
        } else {
          console.error('❌ Server response indicates failure:', response);
          throw new Error(response?.error || response?.message || 'Failed to create case');
        }
        
      } catch (error) {
        console.error('❌ Specification case submission error:', error);
        showError('ケースの作成に失敗しました: ' + error.message);
      } finally {
        if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
          window.CasesDashApp.showLoading(false);
        }
      }
    }

    /**
     * Validate specification form data (spec 4.3.2)
     */
    function validateSpecificationForm(formData) {
      // Required fields for all sheet types
      const requiredFields = [
        { field: 'caseId', name: 'Case ID' },
        { field: 'caseOpenDate', name: 'Case Open Date' },
        { field: 'caseOpenTime', name: 'Case Open Time' },
        { field: 'sheetType', name: 'Sheet Type' },
        { field: 'incomingSegment', name: 'Incoming Segment' },
        { field: 'productCategory', name: 'Product Category' },
        { field: 'firstAssignee', name: '1st Assignee' },
        { field: 'finalAssignee', name: 'Final Assignee' },
        { field: 'finalSegment', name: 'Final Segment' },
        { field: 'caseStatus', name: 'Case Status' }
      ];
      
      // Check required fields
      for (const { field, name } of requiredFields) {
        if (!formData[field] || formData[field].toString().trim() === '') {
          document.getElementById(field.replace(/([A-Z])/g, '-$1').toLowerCase())?.focus();
          return {
            isValid: false,
            message: `${name} is required (spec 4.3.2)`
          };
        }
      }
      
      // Validate Case ID format (X-1234567890123)
      const caseIdPattern = /^\d-\d{13}$/;
      if (!caseIdPattern.test(formData.caseId)) {
        document.getElementById('case-id-input')?.focus();
        return {
          isValid: false,
          message: 'Case ID must be in format: X-1234567890123 (spec 4.3.2)'
        };
      }
      
      // Validate 3PO specific requirements
      if (formData.sheetType && formData.sheetType.includes('3PO')) {
        if (!formData.issueCategory || formData.issueCategory.trim() === '') {
          document.getElementById('issue-category')?.focus();
          return {
            isValid: false,
            message: 'Issue Category is required for 3PO cases (spec 4.3.2)'
          };
        }
      }
      
      return { isValid: true };
    }

    /**
     * Reset specification case form to defaults
     */
    function resetSpecificationCaseForm() {
      try {
        console.log('🔄 Resetting specification case form...');
        
        // Reset text inputs to defaults
        const caseIdInput = document.getElementById('case-id-input');
        if (caseIdInput) caseIdInput.value = generateCaseId();
        
        const dateInput = document.getElementById('case-open-date');
        if (dateInput) dateInput.value = getCurrentDate();
        
        const timeInput = document.getElementById('case-open-time');
        if (timeInput) timeInput.value = getCurrentTime();
        
        // Reset selects to defaults
        const sheetTypeSelect = document.getElementById('sheet-type-select');
        if (sheetTypeSelect) sheetTypeSelect.value = '';
        
        const segmentSelect = document.getElementById('incoming-segment');
        if (segmentSelect) segmentSelect.value = 'Gold';
        
        const categorySelect = document.getElementById('product-category');
        if (categorySelect) categorySelect.value = 'Search';
        
        const statusSelect = document.getElementById('case-status');
        if (statusSelect) statusSelect.value = 'Assigned';
        
        // Reset assignee fields
        const currentUser = getCurrentUser().split('@')[0];
        const firstAssigneeInput = document.getElementById('first-assignee');
        if (firstAssigneeInput) firstAssigneeInput.value = currentUser;
        
        const finalAssigneeInput = document.getElementById('final-assignee');
        if (finalAssigneeInput) finalAssigneeInput.value = currentUser;
        
        const finalSegmentSelect = document.getElementById('final-segment');
        if (finalSegmentSelect) finalSegmentSelect.value = 'Gold';
        
        // Reset all checkboxes
        const checkboxes = ['triage', 'prefer-either', 'is-30', 'mcc', 'change-to-child', 'bug', 'need-info', 'am-initiated'];
        checkboxes.forEach(id => {
          const checkbox = document.getElementById(id);
          if (checkbox) checkbox.checked = false;
        });
        
        // Reset 3PO fields
        const issueCategorySelect = document.getElementById('issue-category');
        if (issueCategorySelect) issueCategorySelect.value = '';
        
        const detailsTextarea = document.getElementById('details');
        if (detailsTextarea) detailsTextarea.value = '';
        
        console.log('✅ Specification case form reset successfully');
        
      } catch (error) {
        console.error('❌ Failed to reset specification case form:', error);
      }
    }

    /**
     * Cancel case form and return to dashboard
     */
    function cancelCaseForm() {
      try {
        console.log('❌ Canceling case form...');
        
        if (window.CasesDashApp && typeof window.CasesDashApp.showDashboard === 'function') {
          window.CasesDashApp.showDashboard();
        }
        
      } catch (error) {
        console.error('❌ Failed to cancel case form:', error);
      }
    }

    /**
     * Utility wrapper functions for calling global functions
     */
    function callServerFunction(functionName, ...args) {
      if (window.CasesDashApp && typeof window.CasesDashApp.callServerFunction === 'function') {
        return window.CasesDashApp.callServerFunction(functionName, ...args);
      }
      // Fallback to direct Google Script call
      return new Promise((resolve, reject) => {
        try {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            [functionName](...args);
        } catch (error) {
          reject(error);
        }
      });
    }

    function showError(message) {
      if (window.CasesDashApp && typeof window.CasesDashApp.showError === 'function') {
        window.CasesDashApp.showError(message);
      } else {
        console.error('Error:', message);
        alert('Error: ' + message);
      }
    }

    function showToast(message, type = 'info') {
      if (window.CasesDashApp && typeof window.CasesDashApp.showToast === 'function') {
        window.CasesDashApp.showToast(message, type);
      } else {
        console.log('Toast:', message);
        // Fallback to simple alert for important messages
        if (type === 'error') {
          alert(message);
        }
      }
    }

    function showLoading(show) {
      if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
        window.CasesDashApp.showLoading(show);
      } else {
        console.log('Loading:', show);
      }
    }

    // Public API
    return {
      initialize,
      loadUserCases,
      viewCaseDetails,
      deleteCase,
      reactivateCase,
      handleCaseSelection,
      updateSelectedCases,
      createNewCase,
      createNewCaseFallback,
      
      // Dynamic form functions (spec 4.3.2)
      showCaseCreationForm,
      generateDynamicCaseForm,
      displayDynamicCaseCreationForm,
      generateFormFieldsHTML,
      setFormDefaultValues,
      submitDynamicCaseForm,
      validateDynamicForm,
      closeDynamicCaseDialog,
      getDynamicFormConfig,
      getChannelType,
      
      // Legacy functions
      displaySheetTypeSelection,
      proceedWithSelectedSheetType,
      closeSheetTypeDialog,
      closeCaseCreationDialog,
      submitSimpleCaseForm,
      closeSimpleCaseDialog,
      submitIntegratedCaseForm,
      closeIntegratedCaseDialog,
      
      // Specification-based functions (spec 4.3.2)
      generateSpecificationCaseForm,
      generateCaseId,
      getCurrentDate,
      getCurrentTime,
      handleSheetTypeChange,
      submitSpecificationBasedCase,
      validateSpecificationForm,
      resetSpecificationCaseForm,
      cancelCaseForm,
      
      // Case re-activation functionality (Spec 4.2.3)
      reactivateCase,
      
      getState: () => ({ ...caseState })
    };

  })();

  // Global functions for HTML onclick handlers
  window.viewCaseDetails = function(caseId, sheetType) {
    if (window.CasesDashCaseManager) {
      window.CasesDashCaseManager.viewCaseDetails(caseId, sheetType);
    }
  };

  window.deleteCase = function(caseId, sheetType) {
    if (window.CasesDashCaseManager) {
      window.CasesDashCaseManager.deleteCase(caseId, sheetType);
    }
  };

  window.handleCaseSelection = function(checkbox) {
    if (window.CasesDashCaseManager) {
      window.CasesDashCaseManager.handleCaseSelection(checkbox);
    }
  };

  window.goToPage = function(page) {
    if (window.CasesDashCaseManager && window.CasesDashCaseManager.getState) {
      const state = window.CasesDashCaseManager.getState();
      state.pagination.currentPage = page;
      window.CasesDashCaseManager.loadUserCases();
    }
  };

  // Case creation global functions
  window.proceedWithSelectedSheetType = function() {
    try {
      const selectedRadio = document.querySelector('input[name="sheetType"]:checked');
      if (!selectedRadio) {
        if (window.CasesDashApp && typeof window.CasesDashApp.showError === 'function') {
          window.CasesDashApp.showError('ケースタイプを選択してください');
        }
        return;
      }
      
      const selectedSheetType = selectedRadio.value;
      console.log('🎯 選択されたシートタイプ (Global):', selectedSheetType);
      
      // Validate selected sheet type
      if (!selectedSheetType || selectedSheetType.trim() === '') {
        console.error('❌ Invalid sheet type selected (Global):', selectedSheetType);
        if (window.CasesDashApp && typeof window.CasesDashApp.showError === 'function') {
          window.CasesDashApp.showError('有効なケースタイプを選択してください');
        }
        return;
      }
      
      // Close selection dialog
      const modal = document.getElementById('sheet-type-selection-dialog');
      if (modal) {
        modal.style.display = 'none';
        modal.remove();
      }
      
      // Show loading
      if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
        window.CasesDashApp.showLoading(true);
      }
      
      // Call case manager to generate form
      if (window.CasesDashCaseManager) {
        const manager = window.CasesDashCaseManager;
        if (typeof manager.generateCaseForm === 'function') {
          manager.generateCaseForm(selectedSheetType).catch(error => {
            console.error('🔄 FormGenerator failed, using fallback (Global):', error);
            // Fallback to simple case creation
            if (typeof manager.createNewCaseFallback === 'function') {
              manager.createNewCaseFallback();
            }
          }).finally(() => {
            if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
              window.CasesDashApp.showLoading(false);
            }
          });
        } else {
          // Direct fallback
          if (typeof manager.createNewCaseFallback === 'function') {
            manager.createNewCaseFallback();
          }
          if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
            window.CasesDashApp.showLoading(false);
          }
        }
      }
      
    } catch (error) {
      console.error('❌ フォーム生成エラー (Global):', error);
      if (window.CasesDashApp && typeof window.CasesDashApp.showError === 'function') {
        window.CasesDashApp.showError('フォームの生成に失敗しました: ' + error.message);
      }
      if (window.CasesDashApp && typeof window.CasesDashApp.showLoading === 'function') {
        window.CasesDashApp.showLoading(false);
      }
    }
  };

  window.closeSheetTypeDialog = function() {
    const modal = document.getElementById('sheet-type-selection-dialog');
    if (modal) {
      modal.style.display = 'none';
      modal.remove();
    }
  };

  window.closeCaseCreationDialog = function() {
    const modal = document.getElementById('case-creation-dialog');
    if (modal) {
      modal.style.display = 'none';
      modal.remove();
    }
  };

  // Dynamic case creation global functions (spec 4.3.2)
  window.submitDynamicCaseForm = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.submitDynamicCaseForm === 'function') {
      window.CasesDashCaseManager.submitDynamicCaseForm();
    }
  };

  window.closeDynamicCaseDialog = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.closeDynamicCaseDialog === 'function') {
      window.CasesDashCaseManager.closeDynamicCaseDialog();
    }
  };

  // Integrated case creation global functions (legacy)
  window.submitIntegratedCaseForm = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.submitIntegratedCaseForm === 'function') {
      window.CasesDashCaseManager.submitIntegratedCaseForm();
    }
  };

  window.closeIntegratedCaseDialog = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.closeIntegratedCaseDialog === 'function') {
      window.CasesDashCaseManager.closeIntegratedCaseDialog();
    }
  };

  // Simple case creation global functions
  window.submitSimpleCaseForm = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.submitSimpleCaseForm === 'function') {
      window.CasesDashCaseManager.submitSimpleCaseForm();
    }
  };

  window.closeSimpleCaseDialog = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.closeSimpleCaseDialog === 'function') {
      window.CasesDashCaseManager.closeSimpleCaseDialog();
    }
  };

  // Specification-based case creation global functions (spec 4.3.2)
  window.submitSpecificationBasedCase = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.submitSpecificationBasedCase === 'function') {
      window.CasesDashCaseManager.submitSpecificationBasedCase();
    }
  };

  window.resetSpecificationCaseForm = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.resetSpecificationCaseForm === 'function') {
      window.CasesDashCaseManager.resetSpecificationCaseForm();
    }
  };

  window.cancelCaseForm = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.cancelCaseForm === 'function') {
      window.CasesDashCaseManager.cancelCaseForm();
    }
  };

  window.handleSheetTypeChange = function(selectedSheetType) {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.handleSheetTypeChange === 'function') {
      window.CasesDashCaseManager.handleSheetTypeChange(selectedSheetType);
    }
  };

  window.generateCaseId = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.generateCaseId === 'function') {
      return window.CasesDashCaseManager.generateCaseId();
    }
    // Fallback
    return `${Math.floor(Math.random() * 10)}-${Date.now().toString().slice(-13)}`;
  };

  window.getCurrentDate = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.getCurrentDate === 'function') {
      return window.CasesDashCaseManager.getCurrentDate();
    }
    // Fallback
    return new Date().toISOString().split('T')[0];
  };

  window.getCurrentTime = function() {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.getCurrentTime === 'function') {
      return window.CasesDashCaseManager.getCurrentTime();
    }
    // Fallback
    return new Date().toTimeString().slice(0, 5);
  };

  // Sheet type selection global function
  window.selectSheetType = function(sheetTypeName, element) {
    console.log('🎯 Sheet type selected (Global):', sheetTypeName);
    
    // Get current theme styles
    const isDark = (function() {
      try {
        if (window.CasesDashThemeManager && typeof window.CasesDashThemeManager.getCurrentTheme === 'function') {
          return window.CasesDashThemeManager.getCurrentTheme() === 'dark';
        }
        
        const savedTheme = localStorage.getItem('casesdash-theme');
        if (savedTheme) {
          return savedTheme === 'dark';
        }
        
        if (document.body.classList.contains('dark-theme') ||
            document.documentElement.classList.contains('dark-theme')) {
          return true;
        }
        
        return false;
      } catch (error) {
        console.warn('Failed to get current theme (Global):', error);
        return false;
      }
    })();
    
    const themeStyles = isDark ? {
      optionBackground: '#2d2d2d',
      optionBorder: '#444444'
    } : {
      optionBackground: '#fafafa',
      optionBorder: '#ddd'
    };
    
    // Clear previous selections
    const options = document.querySelectorAll('#sheet-type-selection-dialog .sheet-type-options > div');
    options.forEach(option => {
      option.style.backgroundColor = themeStyles.optionBackground;
      option.style.borderColor = themeStyles.optionBorder;
    });
    
    // Highlight selected option
    element.style.backgroundColor = isDark ? '#1565c0' : '#e3f2fd';
    element.style.borderColor = '#1976d2';
    
    // Select radio button
    const radio = element.querySelector('input[type="radio"]');
    if (radio) {
      radio.checked = true;
    }
  };

  // Case Re-activation functionality (Spec 4.2.3)
  window.reactivateCase = function(caseId) {
    if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.reactivateCase === 'function') {
      return window.CasesDashCaseManager.reactivateCase(caseId);
    }
    
    // Fallback implementation
    console.log('🔄 Reactivating case:', caseId);
    
    // Show confirmation dialog
    if (!confirm(`Are you sure you want to reactivate case ${caseId}?`)) {
      return;
    }
    
    // Call server function to reactivate case
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response && response.success) {
            console.log('✅ Case reactivated successfully:', caseId);
            // Refresh the case list if available
            if (typeof refreshCaseList === 'function') {
              refreshCaseList();
            }
            // Show success message
            if (typeof showToast === 'function') {
              showToast('Case reactivated successfully', 'success');
            }
          } else {
            console.error('❌ Failed to reactivate case:', response?.error || 'Unknown error');
            if (typeof showToast === 'function') {
              showToast('Failed to reactivate case: ' + (response?.error || 'Unknown error'), 'error');
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('❌ Server error reactivating case:', error);
          if (typeof showToast === 'function') {
            showToast('Server error: Failed to reactivate case', 'error');
          }
        })
        .reactivateCase(caseId);
    } else {
      console.warn('⚠️ Google Apps Script environment not available - cannot reactivate case');
      if (typeof showToast === 'function') {
        showToast('Cannot reactivate case: GAS environment not available', 'warning');
      }
    }
  };
}
</script>