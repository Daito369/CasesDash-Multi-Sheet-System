<script>
/**
 * CasesDash Dashboard Manager
 * ä»•æ§˜æ›¸æº–æ‹ ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚±ãƒ¼ã‚¹ä¸€è¦§è¡¨ç¤ºã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç®¡ç†ã‚’æ‹…å½“
 * 
 * ä¸»è¦æ©Ÿèƒ½:
 * - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚±ãƒ¼ã‚¹("Assigned"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)ã®è¡¨ç¤º
 * - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ï¼ˆTRT & P95ï¼‰
 * - ã‚·ãƒ¼ãƒˆåˆ¥ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
 * - ã‚±ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
 * - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
 * 
 * @author CasesDash Development Team
 * @version 2.0.0
 */

// GASç’°å¢ƒã§ã®å®‰å…¨ãªwindowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§
(function(global) {
    'use strict';
    
    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§windowãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¬ãƒ¼ãƒ‰
    if (typeof global === 'undefined') {
        console.log('âš ï¸ Global object not available, skipping DashboardManager initialization');
        return;
    }
    
    global.CasesDashDashboardManager = (function() {
        'use strict';
        
        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
        const CONFIG = {
            UPDATE_INTERVAL: 1000,              // 1ç§’é–“éš”ã§ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
            CRITICAL_THRESHOLD: 2 * 60 * 60,    // 2æ™‚é–“ï¼ˆç§’ï¼‰
            WARNING_THRESHOLD: 3 * 60 * 60,     // 3æ™‚é–“ï¼ˆç§’ï¼‰
            P95_TARGET_HOURS: 72,               // P95ç›®æ¨™ï¼š72æ™‚é–“
            
            // ã‚·ãƒ¼ãƒˆåˆ¥ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆä»•æ§˜æ›¸æº–æ‹ ï¼‰
            SHEET_COLORS: {
                'OT Email': { color: '#4285F4', border: 'solid', name: 'Google Blue' },
                '3PO Email': { color: '#34A853', border: 'dashed', name: 'Google Green' },
                'OT Chat': { color: '#FBBC05', border: 'solid', name: 'Google Yellow' },
                '3PO Chat': { color: '#EA4335', border: 'dashed', name: 'Google Red' },
                'OT Phone': { color: '#8430CE', border: 'solid', name: 'Google Purple' },
                '3PO Phone': { color: '#F57C00', border: 'dashed', name: 'Google Orange' }
            },
            
            // TRTæ™‚é–“è¨­å®šï¼ˆä»•æ§˜æ›¸æº–æ‹ ï¼‰
            TRT_HOURS: {
                'Email': 36,    // 36æ™‚é–“
                'Chat': 8,      // 8æ™‚é–“  
                'Phone': 8      // 8æ™‚é–“
            }
        };
        
        // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆå¤‰æ•°
        let activeCases = [];
        let timerInterval = null;
        let currentFilters = {
            sheet: 'all',
            channel: 'all',
            segment: 'all',
            urgency: 'all'
        };
        
        /**
         * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
         */
        function initialize() {
            console.log('ğŸš€ Initializing Dashboard Manager...');
            
            try {
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œ
                if (typeof global.document !== 'undefined') {
                    setupUI();
                    loadActiveCases();
                    startRealtimeUpdates();
                    setupEventListeners();
                }
                
                console.log('âœ… Dashboard Manager initialized successfully');
            } catch (error) {
                console.error('âŒ Failed to initialize Dashboard Manager:', error);
                showError('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        /**
         * UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
         */
        function setupUI() {
            console.log('ğŸ¨ Setting up Dashboard UI components...');
            
            if (typeof global.document === 'undefined') return;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¿½åŠ 
            addFilterControls();
            
            // ã‚±ãƒ¼ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã®æº–å‚™
            prepareActiveCasesArea();
            
            // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã®æ‹¡å¼µ
            enhanceStatsCards();
        }
        
        /**
         * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«è¿½åŠ 
         */
        function addFilterControls() {
            if (typeof global.document === 'undefined') return;
            
            const dashboardView = global.document.getElementById('dashboard-view');
            if (!dashboardView) return;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (global.document.getElementById('dashboard-filters')) return;
            
            const filterControlsHtml = `
                <div id="dashboard-filters" class="dashboard-filters" style="margin-bottom: var(--md-space-6);">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Active Cases Filters</h3>
                            <div class="card-actions">
                                <button class="btn btn-icon" onclick="CasesDashDashboardManager.resetFilters()" title="Reset Filters">
                                    <span class="material-symbols-outlined">filter_alt_off</span>
                                </button>
                                <button class="btn btn-icon" onclick="CasesDashDashboardManager.refreshActiveCases()" title="Refresh">
                                    <span class="material-symbols-outlined">refresh</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="filter-controls-grid">
                                <div class="filter-group">
                                    <label for="sheet-filter">Sheet</label>
                                    <select id="sheet-filter" class="filter-select">
                                        <option value="all">All Sheets</option>
                                        <option value="OT Email">OT Email</option>
                                        <option value="3PO Email">3PO Email</option>
                                        <option value="OT Chat">OT Chat</option>
                                        <option value="3PO Chat">3PO Chat</option>
                                        <option value="OT Phone">OT Phone</option>
                                        <option value="3PO Phone">3PO Phone</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="channel-filter">Channel</label>
                                    <select id="channel-filter" class="filter-select">
                                        <option value="all">All Channels</option>
                                        <option value="Email">Email</option>
                                        <option value="Chat">Chat</option>
                                        <option value="Phone">Phone</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="segment-filter">Segment</label>
                                    <select id="segment-filter" class="filter-select">
                                        <option value="all">All Segments</option>
                                        <option value="Platinum">Platinum</option>
                                        <option value="Titanium">Titanium</option>
                                        <option value="Gold">Gold</option>
                                        <option value="Silver">Silver</option>
                                        <option value="Bronze - Low">Bronze - Low</option>
                                        <option value="Bronze - High">Bronze - High</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="urgency-filter">Urgency</label>
                                    <select id="urgency-filter" class="filter-select">
                                        <option value="all">All Urgency</option>
                                        <option value="critical">Critical (â‰¤2h)</option>
                                        <option value="warning">Warning (â‰¤3h)</option>
                                        <option value="normal">Normal (>3h)</option>
                                        <option value="missed">Missed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // æ—¢å­˜ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã®å‰ã«æŒ¿å…¥
            const dashboardGrid = dashboardView.querySelector('.dashboard-grid');
            if (dashboardGrid) {
                dashboardGrid.insertAdjacentHTML('beforebegin', filterControlsHtml);
            }
        }
        
        /**
         * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚±ãƒ¼ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã®æº–å‚™
         */
        function prepareActiveCasesArea() {
            if (typeof global.document === 'undefined') return;
            
            const dashboardGrid = global.document.querySelector('#dashboard-view .dashboard-grid');
            if (!dashboardGrid) return;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚±ãƒ¼ã‚¹ã‚¨ãƒªã‚¢ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (global.document.getElementById('active-cases-section')) return;
            
            const activeCasesHtml = `
                <div class="grid-col-12" id="active-cases-section">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Active Cases</h3>
                                <p class="card-subtitle">Cases with "Assigned" status</p>
                            </div>
                            <div class="card-actions">
                                <span id="active-cases-count" class="cases-count-badge">0</span>
                                <button class="btn btn-icon" onclick="CasesDashDashboardManager.toggleView()" title="Toggle View">
                                    <span class="material-symbols-outlined">view_module</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="active-cases-container" class="active-cases-grid">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <span>Loading active cases...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Recent Activityã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰ã«æŒ¿å…¥
            const recentActivitySection = dashboardGrid.querySelector('.grid-col-12:last-child');
            if (recentActivitySection) {
                recentActivitySection.insertAdjacentHTML('beforebegin', activeCasesHtml);
            } else {
                dashboardGrid.insertAdjacentHTML('beforeend', activeCasesHtml);
            }
        }
        
        /**
         * çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã®æ©Ÿèƒ½å¼·åŒ–
         */
        function enhanceStatsCards() {
            if (typeof global.document === 'undefined') return;
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ãŸã‚ã®æº–å‚™
            const statsCards = global.document.querySelectorAll('.stats-card');
            statsCards.forEach(card => {
                card.addEventListener('click', function() {
                    const cardTitle = this.querySelector('.card-title')?.textContent;
                    if (cardTitle) {
                        applyQuickFilter(cardTitle);
                    }
                });
            });
        }
        
        /**
         * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚±ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿
         */
        async function loadActiveCases() {
            console.log('ğŸ“‹ Loading active cases...');
            
            try {
                showLoadingState();
                
                // å®Ÿéš›ã®GAS APIå‘¼ã³å‡ºã—
                const response = await callServerFunction('getActiveCases');
                console.log('ğŸ” Server response structure:', response);
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®æ­£è¦åŒ–
                let extractedCases = [];
                if (response && response.success && typeof response.data === 'string') {
                    try {
                        extractedCases = JSON.parse(response.data);
                    } catch (parseError) {
                        console.error('âŒ Failed to parse response data:', parseError);
                        extractedCases = [];
                    }
                } else if (Array.isArray(response)) {
                    extractedCases = response; // Fallback for direct array response (e.g., mock data)
                } else {
                    console.warn('âš ï¸ Unexpected response format:', response);
                    extractedCases = [];
                }
                
                activeCases = extractedCases;
                console.log('ğŸ” Extracted active cases:', activeCases);
                console.log('ğŸ” Is array?', Array.isArray(activeCases));
                console.log(`âœ… Loaded ${activeCases.length} active cases`);
                console.log('ğŸ” Sample case:', activeCases[0]);
                
                // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                if (!Array.isArray(activeCases)) {
                    throw new Error('Active cases data is not an array');
                }
                
                renderActiveCases();
                updateStatistics();
                
            } catch (error) {
                console.error('âŒ Failed to load active cases:', error);
                showError('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚±ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                console.log('ğŸ”„ Falling back to demo data...');
                try {
                    const demoData = generateMockData();
                    activeCases = demoData || [];
                    renderActiveCases();
                    updateStatistics();
                    showDemoNotice();
                } catch (demoError) {
                    console.error('âŒ Demo data fallback failed:', demoError);
                    showEmptyState('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }
        
        /**
         * GASã‚µãƒ¼ãƒãƒ¼é–¢æ•°ã‚’å®‰å…¨ã«å‘¼ã³å‡ºã—
         * @param {string} functionName - å‘¼ã³å‡ºã™GASé–¢æ•°å
         * @param {...any} args - é–¢æ•°ã®å¼•æ•°
         * @returns {Promise} - çµæœã®Promise
         */
        function callServerFunction(functionName, ...args) {
            return new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        [functionName](...args);
                } else {
                    reject(new Error('Google Apps Script environment not available'));
                }
            });
        }
        
        /**
         * ãƒ‡ãƒ¢ç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
         */
        function generateMockData() {
            const sheets = ['OT Email', '3PO Email', 'OT Chat', '3PO Chat', 'OT Phone', '3PO Phone'];
            const segments = ['Platinum', 'Titanium', 'Gold', 'Silver', 'Bronze - Low', 'Bronze - High'];
            const categories = ['Search', 'Display', 'Video', 'Commerce', 'Apps', 'Policy', 'Billing'];
            const assignees = ['tanaka', 'suzuki', 'sato', 'yamada', 'watanabe'];
            
            const mockCases = [];
            
            for (let i = 0; i < 15; i++) {
                const sheet = sheets[Math.floor(Math.random() * sheets.length)];
                const openTime = new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000); // æœ€å¤§24æ™‚é–“å‰
                
                mockCases.push({
                    caseId: `${Math.floor(Math.random() * 9)}-${Date.now().toString().slice(-10)}${i.toString().padStart(3, '0')}`,
                    sheetName: sheet,
                    caseOpenDate: openTime.toLocaleDateString('ja-JP'),
                    caseOpenTime: openTime.toLocaleTimeString('ja-JP'),
                    incomingSegment: segments[Math.floor(Math.random() * segments.length)],
                    productCategory: categories[Math.floor(Math.random() * categories.length)],
                    firstAssignee: assignees[Math.floor(Math.random() * assignees.length)],
                    finalAssignee: assignees[Math.floor(Math.random() * assignees.length)],
                    caseStatus: 'Assigned',
                    bug: Math.random() > 0.8 ? '1' : '0',
                    tsConsulted: Math.random() > 0.9 ? '1' : '0',
                    idtBlocked: Math.random() > 0.9 ? '1' : '0',
                    payreqBlocked: Math.random() > 0.9 ? '1' : '0'
                });
            }
            
            return mockCases;
        }
        
        /**
         * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚±ãƒ¼ã‚¹ã‚’ç”»é¢ã«æç”»
         */
        function renderActiveCases() {
            if (typeof global.document === 'undefined') return;
            
            const container = global.document.getElementById('active-cases-container');
            if (!container) return;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é©ç”¨
            const filteredCases = applyFilters(activeCases);
            
            // ã‚±ãƒ¼ã‚¹æ•°æ›´æ–°
            updateCaseCount(filteredCases.length);
            
            if (filteredCases.length === 0) {
                showEmptyState('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ã‚±ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const casesHtml = filteredCases.map(caseData => createCaseCard(caseData)).join('');
            container.innerHTML = casesHtml;
            
            console.log(`ğŸ“‹ Rendered ${filteredCases.length} case cards`);
        }
        
        /**
         * ã‚±ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
         */
        function createCaseCard(caseData) {
            const sheetConfig = CONFIG.SHEET_COLORS[caseData.sheetName] || CONFIG.SHEET_COLORS['OT Email'];
            const channel = getChannelFromSheet(caseData.sheetName);
            const trtHours = CONFIG.TRT_HOURS[channel] || 8;
            
            // ã‚¿ã‚¤ãƒãƒ¼è¨ˆç®—
            const timers = calculateTimers(caseData, trtHours);
            
            // ç·Šæ€¥åº¦ã‚¯ãƒ©ã‚¹
            const urgencyClass = getUrgencyClass(timers.trtRemaining);
            
            // é™¤å¤–ã‚±ãƒ¼ã‚¹ã®è¡¨ç¤º
            const exclusionStatus = getExclusionStatus(caseData);
            
            return `
                <div class="case-card ${urgencyClass}" 
                     data-case-id="${escapeHtml(caseData.caseId)}"
                     data-sheet="${escapeHtml(caseData.sheetName)}"
                     data-channel="${escapeHtml(channel)}"
                     data-segment="${escapeHtml(caseData.incomingSegment)}"
                     style="border-left: 4px ${sheetConfig.border} ${sheetConfig.color};">
                    
                    <div class="case-card-header">
                        <div class="case-badges">
                            <span class="sheet-badge" style="background-color: ${sheetConfig.color};">
                                ${escapeHtml(caseData.sheetName)}
                            </span>
                            <span class="channel-icon" title="${channel}">
                                <span class="material-symbols-outlined">
                                    ${getChannelIcon(channel)}
                                </span>
                            </span>
                        </div>
                        <div class="case-actions">
                            <button class="btn btn-icon" onclick="CasesDashDashboardManager.editCase('${escapeHtml(caseData.caseId)}')" title="Edit">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button class="btn btn-icon" onclick="CasesDashDashboardManager.deleteCase('${escapeHtml(caseData.caseId)}')" title="Delete">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="case-card-body" onclick="CasesDashDashboardManager.showCaseDetails('${escapeHtml(caseData.caseId)}')">
                        <div class="case-id">
                            <strong>Case ID:</strong> ${escapeHtml(caseData.caseId)}
                        </div>
                        <div class="case-info-grid">
                            <div class="info-item">
                                <span class="label">Assignee:</span>
                                <span class="value">${escapeHtml(caseData.finalAssignee || caseData.firstAssignee || 'Unassigned')}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Segment:</span>
                                <span class="value">${escapeHtml(caseData.incomingSegment)}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Category:</span>
                                <span class="value">${escapeHtml(caseData.productCategory)}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Status:</span>
                                <span class="value status-assigned">${escapeHtml(caseData.caseStatus)}</span>
                            </div>
                        </div>
                        
                        <div class="case-timers">
                            <div class="timer-item">
                                <span class="timer-label">TRT Timer:</span>
                                <span class="timer-value trt-timer ${getTimerClass(timers.trtRemaining)}" 
                                      data-remaining="${timers.trtRemaining}">
                                    ${formatTimer(timers.trtRemaining)}
                                </span>
                            </div>
                            <div class="timer-item">
                                <span class="timer-label">P95 Timer:</span>
                                <span class="timer-value p95-timer ${getTimerClass(timers.p95Remaining)}" 
                                      data-remaining="${timers.p95Remaining}">
                                    ${formatP95Timer(timers.p95Remaining)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="case-card-footer">
                        <div class="exclusion-controls">
                            ${createExclusionControls(caseData, exclusionStatus)}
                        </div>
                    </div>
                    
                    ${exclusionStatus.isExcluded ? '<div class="exclusion-indicator">Excluded!!</div>' : ''}
                </div>`;
        }
        
        /**
         * ã‚¿ã‚¤ãƒãƒ¼è¨ˆç®—ï¼ˆTRT & P95ï¼‰
         */
        function calculateTimers(caseData, trtHours) {
            const now = new Date();
            const openDateTime = new Date(`${caseData.caseOpenDate} ${caseData.caseOpenTime}`);
            
            // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
            const elapsedSeconds = Math.floor((now - openDateTime) / 1000);
            
            // TRTæ®‹ã‚Šæ™‚é–“
            const trtTargetSeconds = trtHours * 60 * 60;
            const trtRemaining = trtTargetSeconds - elapsedSeconds;
            
            // P95æ®‹ã‚Šæ™‚é–“ï¼ˆ72æ™‚é–“ï¼‰
            const p95TargetSeconds = CONFIG.P95_TARGET_HOURS * 60 * 60;
            const p95Remaining = p95TargetSeconds - elapsedSeconds;
            
            return {
                trtRemaining: trtRemaining,
                p95Remaining: p95Remaining,
                elapsed: elapsedSeconds
            };
        }
        
        /**
         * é™¤å¤–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèª
         */
        function getExclusionStatus(caseData) {
            const exclusions = [];
            let isExcluded = false;
            
            // å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå…±é€šã®é™¤å¤–æ¡ä»¶
            if (caseData.bug && caseData.bug !== '0') {
                exclusions.push('Bug Case');
                isExcluded = true;
            }
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå›ºæœ‰ã®é™¤å¤–æ¡ä»¶
            if (caseData.incomingSegment === 'Policy' && caseData.tsConsulted && caseData.tsConsulted !== '0') {
                exclusions.push('T&S Consulted');
                isExcluded = true;
            }
            
            if (caseData.incomingSegment === 'Billing') {
                if (caseData.idtBlocked && caseData.idtBlocked !== '0') {
                    exclusions.push('IDT Blocked');
                    isExcluded = true;
                }
                if (caseData.payreqBlocked && caseData.payreqBlocked !== '0') {
                    exclusions.push('Payreq Blocked');
                    isExcluded = true;
                }
            }
            
            return {
                isExcluded: isExcluded,
                exclusions: exclusions
            };
        }
        
        /**
         * é™¤å¤–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®HTMLç”Ÿæˆ
         */
        function createExclusionControls(caseData, exclusionStatus) {
            const segment = caseData.incomingSegment;
            let controls = [];
            
            // Bug Caseï¼ˆå…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå…±é€šï¼‰
            const bugChecked = caseData.bug && caseData.bug !== '0' ? 'checked' : '';
            controls.push(`
                <label class="exclusion-toggle">
                    <input type="checkbox" ${bugChecked} onchange="CasesDashDashboardManager.toggleExclusion('${caseData.caseId}', 'bug', this.checked)">
                    <span>Bug</span>
                </label>
            `);
            
            // L2 Consultedï¼ˆå…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå…±é€šï¼‰
            const l2Checked = caseData.l2Consulted && caseData.l2Consulted !== '0' ? 'checked' : '';
            controls.push(`
                <label class="exclusion-toggle">
                    <input type="checkbox" ${l2Checked} onchange="CasesDashDashboardManager.toggleExclusion('${caseData.caseId}', 'l2Consulted', this.checked)">
                    <span>L2</span>
                </label>
            `);
            
            // Policyç‰¹æœ‰
            if (segment === 'Policy') {
                const tsChecked = caseData.tsConsulted && caseData.tsConsulted !== '0' ? 'checked' : '';
                controls.push(`
                    <label class="exclusion-toggle">
                        <input type="checkbox" ${tsChecked} onchange="CasesDashDashboardManager.toggleExclusion('${caseData.caseId}', 'tsConsulted', this.checked)">
                        <span>T&S</span>
                    </label>
                `);
            }
            
            // Billingç‰¹æœ‰
            if (segment === 'Billing') {
                const idtChecked = caseData.idtBlocked && caseData.idtBlocked !== '0' ? 'checked' : '';
                const payreqChecked = caseData.payreqBlocked && caseData.payreqBlocked !== '0' ? 'checked' : '';
                
                controls.push(`
                    <label class="exclusion-toggle">
                        <input type="checkbox" ${idtChecked} onchange="CasesDashDashboardManager.toggleExclusion('${caseData.caseId}', 'idtBlocked', this.checked)">
                        <span>IDT</span>
                    </label>
                `);
                
                controls.push(`
                    <label class="exclusion-toggle">
                        <input type="checkbox" ${payreqChecked} onchange="CasesDashDashboardManager.toggleExclusion('${caseData.caseId}', 'payreqBlocked', this.checked)">
                        <span>Payreq</span>
                    </label>
                `);
            }
            
            return controls.join('');
        }
        
        /**
         * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
         */
        function startRealtimeUpdates() {
            if (typeof global.document === 'undefined') return;
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                updateTimers();
                checkCriticalCases();
            }, CONFIG.UPDATE_INTERVAL);
            
            console.log('â° Started realtime timer updates');
        }
        
        /**
         * ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
         */
        function updateTimers() {
            if (typeof global.document === 'undefined') return;
            
            const timerElements = global.document.querySelectorAll('.timer-value');
            
            timerElements.forEach(timer => {
                const remaining = parseInt(timer.dataset.remaining);
                if (isNaN(remaining)) return;
                
                // çµŒéæ™‚é–“åˆ†ã‚’æ¸›ç®—
                const newRemaining = remaining - 1;
                timer.dataset.remaining = newRemaining;
                
                // è¡¨ç¤ºæ›´æ–°
                if (timer.classList.contains('p95-timer')) {
                    timer.textContent = formatP95Timer(newRemaining);
                } else {
                    timer.textContent = formatTimer(newRemaining);
                }
                
                // ã‚¯ãƒ©ã‚¹æ›´æ–°
                timer.className = timer.className.replace(/(timer-normal|timer-warning|timer-critical|timer-missed)/g, '');
                timer.classList.add(getTimerClass(newRemaining));
            });
        }
        
        /**
         * ç·Šæ€¥ã‚±ãƒ¼ã‚¹ã®ãƒã‚§ãƒƒã‚¯ã¨é€šçŸ¥
         */
        function checkCriticalCases() {
            const criticalCases = activeCases.filter(caseData => {
                const timers = calculateTimers(caseData, CONFIG.TRT_HOURS[getChannelFromSheet(caseData.sheetName)] || 8);
                return timers.p95Remaining <= CONFIG.CRITICAL_THRESHOLD && timers.p95Remaining > 0;
            });
            
            if (criticalCases.length > 0) {
                // é€šçŸ¥é€ä¿¡ï¼ˆå®Ÿè£…ã¯å¾Œã§ï¼‰
                console.warn(`âš ï¸ ${criticalCases.length} critical cases found`);
            }
        }
        
        /**
         * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
         */
        function applyFilters(cases) {
            return cases.filter(caseData => {
                // ã‚·ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (currentFilters.sheet !== 'all' && caseData.sheetName !== currentFilters.sheet) {
                    return false;
                }
                
                // ãƒãƒ£ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (currentFilters.channel !== 'all') {
                    const channel = getChannelFromSheet(caseData.sheetName);
                    if (channel !== currentFilters.channel) {
                        return false;
                    }
                }
                
                // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (currentFilters.segment !== 'all' && caseData.incomingSegment !== currentFilters.segment) {
                    return false;
                }
                
                // ç·Šæ€¥åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (currentFilters.urgency !== 'all') {
                    const timers = calculateTimers(caseData, CONFIG.TRT_HOURS[getChannelFromSheet(caseData.sheetName)] || 8);
                    const urgency = getUrgencyLevel(timers.trtRemaining);
                    if (urgency !== currentFilters.urgency) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
         */
        function setupEventListeners() {
            if (typeof global.document === 'undefined') return;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            ['sheet-filter', 'channel-filter', 'segment-filter', 'urgency-filter'].forEach(filterId => {
                const filterElement = global.document.getElementById(filterId);
                if (filterElement) {
                    filterElement.addEventListener('change', handleFilterChange);
                }
            });
        }
        
        /**
         * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
         */
        function handleFilterChange(event) {
            const filterId = event.target.id;
            const filterValue = event.target.value;
            
            switch (filterId) {
                case 'sheet-filter':
                    currentFilters.sheet = filterValue;
                    break;
                case 'channel-filter':
                    currentFilters.channel = filterValue;
                    break;
                case 'segment-filter':
                    currentFilters.segment = filterValue;
                    break;
                case 'urgency-filter':
                    currentFilters.urgency = filterValue;
                    break;
            }
            
            console.log('ğŸ” Filter applied:', filterId, '=', filterValue);
            renderActiveCases();
        }
        
        /**
         * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤
         */
        function getChannelFromSheet(sheetName) {
            if (sheetName.includes('Email')) return 'Email';
            if (sheetName.includes('Chat')) return 'Chat';
            if (sheetName.includes('Phone')) return 'Phone';
            return 'Unknown';
        }
        
        function getChannelIcon(channel) {
            switch (channel) {
                case 'Email': return 'email';
                case 'Chat': return 'chat';
                case 'Phone': return 'phone';
                default: return 'help';
            }
        }
        
        function getUrgencyClass(remainingSeconds) {
            if (remainingSeconds <= 0) return 'case-missed';
            if (remainingSeconds <= CONFIG.CRITICAL_THRESHOLD) return 'case-critical';
            if (remainingSeconds <= CONFIG.WARNING_THRESHOLD) return 'case-warning';
            return 'case-normal';
        }
        
        function getUrgencyLevel(remainingSeconds) {
            if (remainingSeconds <= 0) return 'missed';
            if (remainingSeconds <= CONFIG.CRITICAL_THRESHOLD) return 'critical';
            if (remainingSeconds <= CONFIG.WARNING_THRESHOLD) return 'warning';
            return 'normal';
        }
        
        function getTimerClass(remainingSeconds) {
            if (remainingSeconds <= 0) return 'timer-missed';
            if (remainingSeconds <= CONFIG.CRITICAL_THRESHOLD) return 'timer-critical';
            if (remainingSeconds <= CONFIG.WARNING_THRESHOLD) return 'timer-warning';
            return 'timer-normal';
        }
        
        function formatTimer(seconds) {
            if (seconds <= 0) return 'Missed';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatP95Timer(seconds) {
            if (seconds <= 0) return 'Missed';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (days > 0) {
                return `${days}æ—¥ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            if (typeof global.document === 'undefined') return text;
            
            const div = global.document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showLoadingState() {
            if (typeof global.document === 'undefined') return;
            
            const container = global.document.getElementById('active-cases-container');
            if (container) {
                container.innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <span>Loading active cases...</span>
                    </div>`;
            }
        }
        
        function showEmptyState(message = 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“') {
            if (typeof global.document === 'undefined') return;
            
            const container = global.document.getElementById('active-cases-container');
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-outlined">inbox</span>
                        <h4>No Active Cases</h4>
                        <p>${escapeHtml(message)}</p>
                    </div>`;
            }
        }
        
        function showError(message) {
            // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã®å®Ÿè£…
            console.error('Dashboard Error:', message);
            if (global.showToast) {
                global.showToast(message, 'error');
            }
        }
        
        function updateCaseCount(count) {
            if (typeof global.document === 'undefined') return;
            
            const countBadge = global.document.getElementById('active-cases-count');
            if (countBadge) {
                countBadge.textContent = count;
            }
        }
        
        function updateStatistics() {
            // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã®æ›´æ–°
            updateStatsCard('my-cases-count', activeCases.length);
            
            const openCases = activeCases.filter(c => c.caseStatus === 'Assigned');
            updateStatsCard('open-cases-count', openCases.length);
        }
        
        function updateStatsCard(elementId, value) {
            if (typeof global.document === 'undefined') return;
            
            const element = global.document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        }
        
        function applyQuickFilter(cardTitle) {
            // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            switch (cardTitle) {
                case 'My Cases':
                    // è‡ªåˆ†ã®ã‚±ãƒ¼ã‚¹ã®ã¿è¡¨ç¤º
                    break;
                case 'Open Cases':
                    // ã‚ªãƒ¼ãƒ—ãƒ³ã‚±ãƒ¼ã‚¹ã®ã¿è¡¨ç¤º
                    break;
            }
        }
        
        /**
         * ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰é€šçŸ¥ã‚’è¡¨ç¤º
         */
        function showDemoNotice() {
            if (typeof global.document === 'undefined') return;
            
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotice = global.document.getElementById('demo-notice');
            if (existingNotice) {
                existingNotice.remove();
            }
            
            const dashboardView = global.document.getElementById('dashboard-view');
            if (!dashboardView) return;
            
            const noticeHtml = `
                <div id="demo-notice" class="demo-notice" style="
                    background: linear-gradient(90deg, #FFF3CD, #F8D7DA);
                    border: 1px solid #FFEAA7;
                    border-radius: var(--md-radius-2);
                    padding: var(--md-space-4);
                    margin-bottom: var(--md-space-4);
                    display: flex;
                    align-items: center;
                    gap: var(--md-space-3);
                ">
                    <span class="material-symbols-outlined" style="color: #856404;">
                        info
                    </span>
                    <div style="flex: 1;">
                        <strong>ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰:</strong>
                        å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
                    </div>
                    <button class="btn btn-icon" onclick="this.parentElement.remove()" style="color: #856404;">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>`;
            
            const firstChild = dashboardView.firstElementChild;
            firstChild.insertAdjacentHTML('beforebegin', noticeHtml);
        }
        
        // ãƒ‘ãƒ–ãƒªãƒƒã‚¯API
        return {
            initialize: initialize,
            
            // ã‚±ãƒ¼ã‚¹ç®¡ç†
            refreshActiveCases: loadActiveCases,
            showCaseDetails: function(caseId) {
                console.log('ğŸ“‹ Show case details:', caseId);
                // ã‚±ãƒ¼ã‚¹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å®Ÿè£…
            },
            
            editCase: function(caseId) {
                console.log('âœï¸ Edit case:', caseId);
                // ã‚±ãƒ¼ã‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å®Ÿè£…
            },
            
            deleteCase: function(caseId) {
                console.log('ğŸ—‘ï¸ Delete case:', caseId);
                // ã‚±ãƒ¼ã‚¹å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å®Ÿè£…
            },
            
            // é™¤å¤–è¨­å®š
            toggleExclusion: function(caseId, exclusionType, isEnabled) {
                console.log('ğŸ”„ Toggle exclusion:', caseId, exclusionType, isEnabled);
                
                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§é™¤å¤–è¨­å®šã‚’æ›´æ–°
                callServerFunction('updateCaseExclusion', caseId, exclusionType, isEnabled)
                    .then(() => {
                        console.log('âœ… Exclusion updated successfully');
                        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                        const caseData = activeCases.find(c => c.caseId === caseId);
                        if (caseData) {
                            caseData[exclusionType] = isEnabled ? '1' : '0';
                            renderActiveCases(); // å†æç”»
                        }
                    })
                    .catch(error => {
                        console.error('âŒ Failed to update exclusion:', error);
                        showError('é™¤å¤–è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        
                        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å…ƒã«æˆ»ã™
                        if (typeof global.document !== 'undefined') {
                            const checkbox = global.document.querySelector(
                                `input[onchange*="${caseId}"][onchange*="${exclusionType}"]`
                            );
                            if (checkbox) {
                                checkbox.checked = !isEnabled;
                            }
                        }
                    });
            },
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç®¡ç†
            resetFilters: function() {
                currentFilters = { sheet: 'all', channel: 'all', segment: 'all', urgency: 'all' };
                
                if (typeof global.document !== 'undefined') {
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIã‚’ãƒªã‚»ãƒƒãƒˆ
                    ['sheet-filter', 'channel-filter', 'segment-filter', 'urgency-filter'].forEach(filterId => {
                        const element = global.document.getElementById(filterId);
                        if (element) element.value = 'all';
                    });
                }
                
                renderActiveCases();
                console.log('ğŸ”„ Filters reset');
            },
            
            // è¡¨ç¤ºåˆ‡æ›¿
            toggleView: function() {
                if (typeof global.document === 'undefined') return;
                
                const container = global.document.getElementById('active-cases-container');
                if (container) {
                    container.classList.toggle('list-view');
                    console.log('ğŸ”„ View toggled');
                }
            },
            
            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ¡ã‚½ãƒƒãƒ‰
            updateCaseStatus: function(caseId, newStatus) {
                return callServerFunction('updateCaseStatus', caseId, newStatus)
                    .then(() => {
                        console.log('âœ… Case status updated:', caseId, newStatus);
                        loadActiveCases(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    })
                    .catch(error => {
                        console.error('âŒ Failed to update case status:', error);
                        showError('ã‚±ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
            },
            
            // æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            forceRefresh: function() {
                console.log('ğŸ”„ Force refreshing dashboard data...');
                loadActiveCases();
            },
            
            // é–‹ç™ºè€…ç”¨ï¼šãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
            toggleDemoMode: function() {
                const demoData = generateMockData();
                activeCases = demoData;
                renderActiveCases();
                updateStatistics();
                showDemoNotice();
                console.log('ğŸ­ Demo mode activated with mock data');
            },
            
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            destroy: function() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                console.log('ğŸ§¹ Dashboard Manager destroyed');
            }
        };
    })();
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    global.showDashboard = function() {
        if (typeof global.document === 'undefined') return;
        
        const currentView = global.document.querySelector('.view-container:not([style*="display: none"])');
        if (currentView && currentView.id !== 'dashboard-view') {
            // ä»–ã®ç”»é¢ã‹ã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹å ´åˆã¯åˆæœŸåŒ–
            if (global.CasesDashDashboardManager) {
                global.CasesDashDashboardManager.refreshActiveCases();
            }
        }
        
        if (global.showView) {
            global.showView('dashboard');
        }
    };
    
    console.log('ğŸš€ Dashboard Manager module loaded');
    
})(typeof window !== 'undefined' ? window : this);
</script>