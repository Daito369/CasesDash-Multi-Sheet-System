<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CasesDash - Enterprise Case Management System with Material Design 3.0">
    <meta name="theme-color" content="#008197">
    <title>CasesDash - Enterprise Case Management</title>
    
    <!-- Material Symbols & Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    
    <!-- Material Dashboard CSS -->
    <?!= include('client/css/material-dashboard'); ?>
    
    <!-- Chart.js for Premium Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Legacy MDL Support -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    
    <!-- Custom Styles for backward compatibility -->
    <?!= include('client/css/styles'); ?>
    
    <!-- Dashboard Specific Styles -->
    <?!= include('client/css/dashboard'); ?>
    
    <!-- Performance & SEO -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    
    <style>
        /* Force hide all spinners immediately */
        #loading-overlay,
        .mdl-spinner,
        .mdl-js-spinner,
        .loading-overlay {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Ensure body is visible */
        body {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Quick Actions Grid */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--md-space-3);
            margin-top: var(--md-space-4);
        }
        
        /* Search Container */
        .search-container {
            margin-bottom: var(--md-space-6);
        }
        
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--current-surface-container);
            border-radius: var(--md-radius-lg);
            border: 1px solid var(--current-surface-container-high);
            padding: var(--md-space-3);
        }
        
        .search-icon {
            color: var(--current-on-surface-variant);
            margin-right: var(--md-space-2);
        }
        
        .search-input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font: var(--md-body-large-font);
            color: var(--current-on-surface);
        }
        
        .search-clear {
            margin-left: var(--md-space-2);
        }
        
        /* Status Tabs (Spec 4.2.2) */
        .status-tabs-container {
            margin-bottom: var(--md-space-6);
            border-bottom: 1px solid var(--current-surface-container-high);
        }
        
        .status-tabs {
            display: flex;
            gap: var(--md-space-1);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .status-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .status-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--md-space-1);
            padding: var(--md-space-3) var(--md-space-4);
            border: none;
            background: none;
            color: var(--current-on-surface-variant);
            cursor: pointer;
            border-radius: var(--md-radius-md) var(--md-radius-md) 0 0;
            transition: all var(--md-motion-duration-short2) var(--md-motion-easing-standard);
            position: relative;
            min-width: 120px;
            font: var(--md-label-large-font);
            white-space: nowrap;
        }
        
        .status-tab:hover {
            background-color: var(--current-surface-container-high);
            color: var(--current-on-surface);
        }
        
        .status-tab.active {
            background-color: var(--current-surface-container);
            color: var(--md-primary-50);
            border-bottom: 2px solid var(--md-primary-50);
        }
        
        .status-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--md-primary-50);
            border-radius: 1px 1px 0 0;
        }
        
        .tab-label {
            font-weight: 500;
        }
        
        .tab-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            background-color: var(--current-surface-container-highest);
            color: var(--current-on-surface-variant);
            font: var(--md-label-small-font);
            font-weight: 600;
            border-radius: var(--md-radius-full);
            padding: 0 var(--md-space-1);
            transition: all var(--md-motion-duration-short2) var(--md-motion-easing-standard);
        }
        
        .status-tab.active .tab-count {
            background-color: var(--md-primary-90);
            color: var(--md-primary-20);
        }
        
        [data-theme="dark"] .status-tab.active .tab-count {
            background-color: var(--md-primary-30);
            color: var(--md-primary-90);
        }

        /* Table Container */
        .table-container {
            overflow-x: auto;
            border-radius: var(--md-radius-lg);
            background-color: var(--current-surface-container);
        }
        
        /* User Menu */
        .user-menu-container {
            position: relative;
        }
        
        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--current-surface-container);
            border-radius: var(--md-radius-lg);
            box-shadow: var(--current-elevation-3);
            padding: var(--md-space-2);
            min-width: 200px;
            z-index: 1200;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: var(--md-space-3);
            padding: var(--md-space-3);
            border-radius: var(--md-radius-sm);
            cursor: pointer;
            color: var(--current-on-surface);
            transition: background-color var(--md-motion-duration-short2) var(--md-motion-easing-standard);
        }
        
        .menu-item:hover {
            background-color: var(--current-surface-container-high);
        }
        
        .menu-separator {
            height: 1px;
            background-color: var(--current-surface-container-high);
            margin: var(--md-space-2) 0;
        }
        
        /* Modal Dialog Improvements */
        .modal-dialog {
            border: none;
            border-radius: var(--md-radius-xl);
            box-shadow: var(--current-elevation-5);
            background-color: var(--current-surface-container);
            color: var(--current-on-surface);
            max-width: 600px;
            width: 90vw;
        }
        
        .modal-content {
            padding: 0;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--md-space-6);
            border-bottom: 1px solid var(--current-surface-container-high);
        }
        
        .modal-title {
            font: var(--md-headline-small-font);
            margin: 0;
        }
        
        .modal-body {
            padding: var(--md-space-6);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--md-space-3);
            justify-content: flex-end;
            padding: var(--md-space-6);
            border-top: 1px solid var(--current-surface-container-high);
        }
        
        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--md-space-4);
            margin-bottom: var(--md-space-4);
        }
        
        .form-field {
            display: flex;
            flex-direction: column;
            gap: var(--md-space-1);
        }
        
        .form-field label {
            font: var(--md-label-large-font);
            color: var(--current-on-surface);
        }
        
        .form-field input,
        .form-field select,
        .form-field textarea {
            padding: var(--md-space-3);
            border: 1px solid var(--current-surface-container-high);
            border-radius: var(--md-radius-sm);
            background-color: var(--current-surface);
            color: var(--current-on-surface);
            font: var(--md-body-medium-font);
        }
        
        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: 2px solid var(--md-primary-50);
            border-color: var(--md-primary-50);
        }
        
        .field-hint {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
        }
        
        .form-actions {
            display: flex;
            gap: var(--md-space-3);
            justify-content: flex-start;
            margin-top: var(--md-space-6);
        }
        
        /* Recent Activity List */
        .recent-activity-list {
            display: flex;
            flex-direction: column;
            gap: var(--md-space-3);
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: var(--md-space-3);
            padding: var(--md-space-3);
            border-radius: var(--md-radius-sm);
            background-color: var(--current-surface-container-high);
        }
        
        .activity-icon {
            color: var(--md-primary-50);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font: var(--md-body-medium-font);
            color: var(--current-on-surface);
            margin: 0 0 var(--md-space-1) 0;
        }
        
        .activity-time {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
        }
        
        /* Toast Container */
        .toast-container {
            position: fixed;
            top: var(--md-space-6);
            right: var(--md-space-6);
            z-index: 1300;
            display: flex;
            flex-direction: column;
            gap: var(--md-space-2);
        }
        
        .toast {
            background-color: var(--current-surface-container-highest);
            color: var(--current-on-surface);
            padding: var(--md-space-4);
            border-radius: var(--md-radius-lg);
            box-shadow: var(--current-elevation-3);
            display: flex;
            align-items: center;
            gap: var(--md-space-3);
            min-width: 300px;
            animation: slideInRight var(--md-motion-duration-medium2) var(--md-motion-easing-emphasized);
        }
        
        .toast.success {
            border-left: 4px solid var(--md-success-50);
        }
        
        .toast.error {
            border-left: 4px solid var(--md-error-50);
        }
        
        .toast.warning {
            border-left: 4px solid var(--md-warning-50);
        }
        
        /* Validation Messages */
        .validation-messages {
            background-color: var(--md-error-95);
            color: var(--md-error-20);
            padding: var(--md-space-3);
            border-radius: var(--md-radius-sm);
            margin-top: var(--md-space-3);
        }
        
        [data-theme="dark"] .validation-messages {
            background-color: var(--md-error-20);
            color: var(--md-error-90);
        }
        
        /* Sentiment Score Specific Styles */
        .sentiment-period-selection {
            margin-bottom: var(--md-space-6);
        }
        
        .sentiment-score-input {
            margin-bottom: var(--md-space-6);
        }
        
        .score-slider-container {
            display: flex;
            align-items: center;
            gap: var(--md-space-4);
            margin: var(--md-space-4) 0;
        }
        
        .sentiment-slider {
            flex: 1;
            height: 8px;
            border-radius: var(--md-radius-xs);
            background: linear-gradient(to right, var(--md-error-50), var(--md-warning-50), var(--md-success-50));
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .sentiment-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--md-primary-50);
            cursor: pointer;
            box-shadow: var(--current-elevation-2);
        }
        
        .sentiment-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--md-primary-50);
            cursor: pointer;
            border: none;
            box-shadow: var(--current-elevation-2);
        }
        
        .score-display {
            display: flex;
            align-items: baseline;
            gap: var(--md-space-1);
            min-width: 80px;
        }
        
        .score-value {
            font: var(--md-headline-medium-font);
            color: var(--md-primary-40);
            font-weight: 500;
        }
        
        .score-buttons {
            display: flex;
            gap: var(--md-space-2);
        }
        
        /* Search Results */
        .search-results {
            margin-top: var(--md-space-6);
        }
        
        .search-results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--md-space-4);
        }
        
        .search-results-count {
            font: var(--md-body-medium-font);
            color: var(--current-on-surface-variant);
        }
        
        /* Sentiment Management Specific */
        .sentiment-current-section,
        .sentiment-history-section,
        .sentiment-table-section {
            margin-bottom: var(--md-space-8);
        }
        
        .sentiment-current-section h4,
        .sentiment-history-section h4,
        .sentiment-table-section h4 {
            font: var(--md-title-large-font);
            color: var(--current-on-surface);
            margin: 0 0 var(--md-space-4) 0;
        }
        
        .current-sentiment-display {
            display: flex;
            align-items: center;
            gap: var(--md-space-6);
            padding: var(--md-space-6);
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
        }
        
        .sentiment-score-large {
            display: flex;
            align-items: baseline;
            gap: var(--md-space-2);
        }
        
        .score-large {
            font: var(--md-display-medium-font);
            color: var(--md-primary-40);
            font-weight: 300;
        }
        
        .scale-text {
            font: var(--md-title-large-font);
            color: var(--current-on-surface-variant);
        }
        
        .sentiment-info {
            flex: 1;
        }
        
        .sentiment-info p {
            margin: 0 0 var(--md-space-2) 0;
            font: var(--md-body-large-font);
            color: var(--current-on-surface);
        }
        
        .status-text {
            font: var(--md-body-medium-font);
            color: var(--current-on-surface-variant);
        }
        
        .sentiment-history-chart {
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-6);
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* TRT(P95) Management Specific Styles */
        .trt-overview-section,
        .trt-chart-section,
        .trt-exclusions-section,
        .trt-alerts-section {
            margin-bottom: var(--md-space-8);
        }
        
        .trt-overview-section h4,
        .trt-chart-section h4,
        .trt-exclusions-section h4,
        .trt-alerts-section h4 {
            font: var(--md-title-large-font);
            color: var(--current-on-surface);
            margin: 0 0 var(--md-space-4) 0;
        }
        
        .trt-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--md-space-4);
            margin-bottom: var(--md-space-6);
        }
        
        .trt-metric-card {
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-6);
            border-left: 4px solid var(--md-primary-50);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            gap: var(--md-space-2);
            margin-bottom: var(--md-space-3);
        }
        
        .metric-header .material-symbols-outlined {
            color: var(--md-primary-50);
            font-size: 20px;
        }
        
        .metric-header h5 {
            font: var(--md-title-medium-font);
            color: var(--current-on-surface);
            margin: 0;
        }
        
        .metric-value {
            font: var(--md-display-small-font);
            color: var(--md-primary-40);
            font-weight: 600;
            margin-bottom: var(--md-space-1);
        }
        
        .metric-target,
        .metric-detail {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
            margin-bottom: var(--md-space-1);
        }
        
        .metric-status {
            font: var(--md-label-large-font);
            padding: var(--md-space-1) var(--md-space-3);
            border-radius: var(--md-radius-xs);
            display: inline-block;
        }
        
        .metric-status.compliant {
            background-color: var(--md-success-95);
            color: var(--md-success-20);
        }
        
        .metric-status.violation {
            background-color: var(--md-error-95);
            color: var(--md-error-20);
        }
        
        [data-theme="dark"] .metric-status.compliant {
            background-color: var(--md-success-20);
            color: var(--md-success-90);
        }
        
        [data-theme="dark"] .metric-status.violation {
            background-color: var(--md-error-20);
            color: var(--md-error-90);
        }
        
        .metric-change {
            font: var(--md-body-small-font);
            display: flex;
            align-items: center;
            gap: var(--md-space-1);
        }
        
        .metric-change.positive {
            color: var(--md-success-40);
        }
        
        .metric-change.negative {
            color: var(--md-error-40);
        }
        
        .chart-container {
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-6);
            min-height: 400px;
            position: relative;
        }
        
        .exclusions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--md-space-4);
        }
        
        .exclusion-item {
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-md);
            padding: var(--md-space-4);
            text-align: center;
        }
        
        .exclusion-label {
            font: var(--md-title-small-font);
            color: var(--current-on-surface);
            margin-bottom: var(--md-space-2);
        }
        
        .exclusion-count {
            font: var(--md-headline-large-font);
            color: var(--md-primary-40);
            font-weight: 500;
            margin-bottom: var(--md-space-1);
        }
        
        .exclusion-scope {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--md-space-4);
        }
        
        .alerts-container {
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-4);
            min-height: 200px;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--md-space-3);
            border-radius: var(--md-radius-sm);
            margin-bottom: var(--md-space-2);
            border-left: 4px solid var(--md-warning-50);
        }
        
        .alert-item.critical {
            border-left-color: var(--md-error-50);
            background-color: var(--md-error-99);
        }
        
        [data-theme="dark"] .alert-item.critical {
            background-color: var(--md-error-10);
        }
        
        .alert-info {
            flex: 1;
        }
        
        .alert-case-id {
            font: var(--md-title-small-font);
            color: var(--current-on-surface);
            margin-bottom: var(--md-space-1);
        }
        
        .alert-details {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
        }
        
        .alert-urgency {
            display: flex;
            align-items: center;
            gap: var(--md-space-2);
            padding: var(--md-space-2) var(--md-space-3);
            border-radius: var(--md-radius-sm);
            font: var(--md-label-medium-font);
        }
        
        .alert-urgency.critical {
            background-color: var(--md-error-50);
            color: var(--md-error-99);
        }
        
        .alert-urgency.warning {
            background-color: var(--md-warning-50);
            color: var(--md-warning-10);
        }
        
        /* Team Management Styles */
        .team-member-card {
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-4);
            margin-bottom: var(--md-space-3);
        }
        
        .member-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--md-space-3);
        }
        
        .member-info h6 {
            font: var(--md-title-medium-font);
            color: var(--current-on-surface);
            margin: 0 0 var(--md-space-1) 0;
        }
        
        .member-role {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
        }
        
        .workload-indicator {
            display: flex;
            align-items: center;
            gap: var(--md-space-2);
        }
        
        .workload-bar {
            width: 60px;
            height: 8px;
            background-color: var(--current-surface-container);
            border-radius: var(--md-radius-xs);
            overflow: hidden;
        }
        
        .workload-fill {
            height: 100%;
            background: linear-gradient(to right, var(--md-success-50), var(--md-warning-50), var(--md-error-50));
            transition: width var(--md-motion-duration-medium2) var(--md-motion-easing-standard);
        }
        
        .workload-score {
            font: var(--md-label-medium-font);
            color: var(--current-on-surface-variant);
        }
        
        /* Audit Logs Styles */
        .audit-log-item {
            display: flex;
            align-items: center;
            padding: var(--md-space-3);
            border-bottom: 1px solid var(--current-surface-container-high);
        }
        
        .audit-timestamp {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
            min-width: 120px;
        }
        
        .audit-action {
            font: var(--md-body-medium-font);
            color: var(--current-on-surface);
            flex: 1;
            margin: 0 var(--md-space-3);
        }
        
        .audit-user {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
            min-width: 150px;
        }
        
        /* Animation for new alerts */
        .alert-item.new {
            animation: slideInAlert var(--md-motion-duration-medium2) var(--md-motion-easing-emphasized);
        }
        
        @keyframes slideInAlert {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Loading states for TRT components */
        .trt-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            gap: var(--md-space-3);
            color: var(--current-on-surface-variant);
        }
        
        .trt-loading .material-symbols-outlined {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Reports View Specific Styles */
        .reports-period-controls {
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-6);
            margin-bottom: var(--md-space-6);
        }

        .reports-period-controls h5 {
            font: var(--md-title-medium-font);
            color: var(--current-on-surface);
            margin: 0 0 var(--md-space-4) 0;
        }

        /* Export Options Grid */
        .export-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--md-space-4);
        }

        .export-option-card {
            display: flex;
            align-items: center;
            gap: var(--md-space-4);
            background-color: var(--current-surface-container-high);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-4);
            border: 1px solid var(--current-surface-container-highest);
            transition: all var(--md-motion-duration-short2) var(--md-motion-easing-standard);
        }

        .export-option-card:hover {
            background-color: var(--current-surface-container-highest);
            box-shadow: var(--current-elevation-2);
        }

        .export-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background-color: var(--md-primary-90);
            border-radius: var(--md-radius-md);
            color: var(--md-primary-30);
        }

        [data-theme="dark"] .export-icon {
            background-color: var(--md-primary-30);
            color: var(--md-primary-90);
        }

        .export-content {
            flex: 1;
        }

        .export-content h5 {
            font: var(--md-title-medium-font);
            color: var(--current-on-surface);
            margin: 0 0 var(--md-space-1) 0;
        }

        .export-content p {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
            margin: 0 0 var(--md-space-3) 0;
        }

        /* TRT Analytics Panel */
        .trt-analytics-panel {
            display: flex;
            flex-direction: column;
            gap: var(--md-space-6);
        }

        /* Sentiment Integration Panel */
        .sentiment-integration-panel {
            display: flex;
            flex-direction: column;
            gap: var(--md-space-4);
        }

        .sentiment-current-card {
            display: flex;
            align-items: center;
            gap: var(--md-space-4);
            background-color: var(--current-surface-container-highest);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-4);
        }

        .sentiment-trend-mini {
            background-color: var(--current-surface-container-highest);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-4);
        }

        .trend-title {
            font: var(--md-title-small-font);
            color: var(--current-on-surface);
            margin-bottom: var(--md-space-3);
        }

        .mini-chart-container {
            display: flex;
            align-items: end;
            gap: var(--md-space-2);
            height: 80px;
        }

        .mini-chart-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--md-space-1);
            flex: 1;
            position: relative;
        }

        .bar-value {
            font: var(--md-label-small-font);
            color: var(--current-on-surface);
            font-weight: 500;
        }

        .bar-label {
            font: var(--md-body-small-font);
            color: var(--current-on-surface-variant);
            font-size: 10px;
        }

        .no-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
            font: var(--md-body-medium-font);
            color: var(--current-on-surface-variant);
        }

        /* Statistics Charts Panel */
        .statistics-charts-panel {
            display: flex;
            flex-direction: column;
            gap: var(--md-space-4);
        }

        .stats-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--md-space-4);
        }

        .chart-title {
            font: var(--md-title-small-font);
            color: var(--current-on-surface);
            margin-bottom: var(--md-space-3);
            text-align: center;
        }

        /* Enhanced Chart Container */
        .chart-container canvas {
            max-height: 300px;
        }

        /* Loading states for reports */
        .loading-skeleton {
            background: linear-gradient(90deg,
                var(--current-surface-container) 25%,
                var(--current-surface-container-high) 50%,
                var(--current-surface-container) 75%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
            border-radius: var(--md-radius-sm);
        }

        @keyframes loading-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Error states */
        .error-message {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            font: var(--md-body-medium-font);
            color: var(--md-error-40);
            background-color: var(--md-error-95);
            border-radius: var(--md-radius-lg);
            padding: var(--md-space-4);
        }

        [data-theme="dark"] .error-message {
            background-color: var(--md-error-20);
            color: var(--md-error-90);
        }

        /* Responsive adjustments for reports */
        @media (max-width: 768px) {
            .export-options-grid {
                grid-template-columns: 1fr;
            }
            
            .export-option-card {
                flex-direction: column;
                text-align: center;
            }
            
            .sentiment-current-card {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Modal Dialog Styles */
        .modal-dialog {
            border: none;
            border-radius: 12px;
            background: var(--current-surface-container);
            color: var(--current-on-surface);
            box-shadow: var(--current-elevation-3);
            max-width: 500px;
            width: 90vw;
            max-height: 80vh;
            overflow: hidden;
            padding: 0;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }
        
        .modal-dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--current-surface-container-high);
            background: var(--current-surface-container-high);
        }
        
        .modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
            font-size: 20px;
            font-weight: 500;
            color: var(--current-on-surface);
        }
        
        .modal-title .material-symbols-outlined {
            font-size: 24px;
            color: var(--md-primary-50);
        }
        
        .modal-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 24px;
            border-top: 1px solid var(--current-surface-container-high);
            background: var(--current-surface-container-high);
        }
        
        /* Profile Section Styles */
        .profile-section {
            margin-bottom: 24px;
        }
        
        .profile-section:last-child {
            margin-bottom: 0;
        }
        
        .profile-section h5 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--md-primary-50);
            border-bottom: 1px solid var(--current-surface-container-high);
            padding-bottom: 8px;
        }
        
        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--current-surface-variant);
        }
        
        .profile-field:last-child {
            border-bottom: none;
        }
        
        .profile-field label {
            font-weight: 500;
            color: var(--current-on-surface-variant);
            min-width: 120px;
        }
        
        .profile-field span {
            color: var(--current-on-surface);
            text-align: right;
            flex: 1;
        }
        
        /* Settings Section Styles */
        .settings-section {
            margin-bottom: 24px;
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
        }
        
        .settings-section h5 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--md-primary-50);
            border-bottom: 1px solid var(--current-surface-container-high);
            padding-bottom: 8px;
        }
        
        .setting-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--current-surface-variant);
        }
        
        .setting-field:last-child {
            border-bottom: none;
        }
        
        .setting-field label {
            font-weight: 500;
            color: var(--current-on-surface);
            min-width: 120px;
        }
        
        .setting-field select {
            background: var(--current-surface-container-high);
            border: 1px solid var(--current-surface-container-highest);
            border-radius: 4px;
            padding: 8px 12px;
            color: var(--current-on-surface);
            min-width: 120px;
        }
        
        .setting-field select:focus {
            outline: 2px solid var(--md-primary-50);
            outline-offset: 2px;
        }
        
        /* Checkbox Container Styles */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            position: relative;
            padding-left: 32px;
            margin: 0;
            font-weight: normal !important;
            min-width: auto !important;
        }
        
        .checkbox-container input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        
        .checkmark {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 20px;
            background-color: var(--current-surface-container-high);
            border: 2px solid var(--current-surface-container-highest);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .checkbox-container:hover input ~ .checkmark {
            border-color: var(--md-primary-50);
        }
        
        .checkbox-container input:checked ~ .checkmark {
            background-color: var(--md-primary-50);
            border-color: var(--md-primary-50);
        }
        
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 10px;
            border: solid var(--md-primary-99);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        
        /* Toast Notification Styles */
        .toast {
            background-color: var(--current-surface-container-highest);
            color: var(--current-on-surface);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--current-elevation-3);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
            margin-bottom: 8px;
        }
        
        .toast.success {
            border-left: 4px solid var(--md-success-50);
        }
        
        .toast.error {
            border-left: 4px solid var(--md-error-50);
        }
        
        .toast.warning {
            border-left: 4px solid var(--md-warning-50);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="mdl-spinner mdl-js-spinner is-active"></div>
        <p>Loading CasesDash...</p>
    </div>

    <!-- Error Snackbar -->
    <div id="error-snackbar" class="mdl-snackbar mdl-js-snackbar">
        <div class="mdl-snackbar__text"></div>
        <button class="mdl-snackbar__action" type="button"></button>
    </div>

    <!-- ===== Dashboard Layout ===== -->
    <div class="dashboard-layout">
        
        <!-- === Header === -->
        <header class="dashboard-header">
            <div class="header-left">
                <button class="menu-button" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <h1 class="app-title">CasesDash</h1>
            </div>
            
            <div class="header-spacer"></div>
            
            <div class="header-actions">
                <!-- Theme Toggle -->
                <button class="theme-toggle" data-action="toggle-theme" aria-label="Toggle theme">
                    <span class="material-symbols-outlined">dark_mode</span>
                </button>
                
                <!-- Live Mode Button -->
                <button class="live-mode-button" id="live-mode-button" onclick="openLiveMode()" aria-label="Open Live Mode">
                    <span class="material-symbols-outlined">open_in_new</span>
                    <span class="nav-text">LIVE MODE</span>
                </button>
                
                <!-- User Menu -->
                <div class="user-menu-container">
                    <button class="btn btn-icon" id="user-menu-button" aria-label="User menu" aria-expanded="false">
                        <span class="material-symbols-outlined">account_circle</span>
                    </button>
                    <div class="user-menu" id="user-menu" hidden>
                        <div class="menu-item" onclick="showUserProfile()">
                            <span class="material-symbols-outlined">person</span>
                            <span>Profile</span>
                        </div>
                        <div class="menu-item" onclick="showSettings()">
                            <span class="material-symbols-outlined">settings</span>
                            <span>Settings</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-item" onclick="logout()">
                            <span class="material-symbols-outlined">logout</span>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- === Sidebar === -->
        <nav class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Navigation</h2>
            </div>
            
            <div class="sidebar-nav">
                <!-- Main Navigation -->
                <div class="nav-section">
                    <h3 class="nav-section-title">Main</h3>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link active" onclick="showDashboard()" data-view="dashboard">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">dashboard</span>
                            </div>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showCaseList()" data-view="case-list">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">list_alt</span>
                            </div>
                            <span class="nav-text">My Cases</span>
                            <span class="nav-badge" id="my-cases-badge">0</span>
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showCreateCase()" data-view="case-form">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">add_circle</span>
                            </div>
                            <span class="nav-text">Create Case</span>
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showAdvancedSearch()" data-view="search">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">search</span>
                            </div>
                            <span class="nav-text">Advanced Search</span>
                        </a>
                    </div>
                </div>
                
                <!-- Analytics -->
                <div class="nav-section">
                    <h3 class="nav-section-title">Analytics</h3>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showReports()" data-view="reports">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">analytics</span>
                            </div>
                            <span class="nav-text">Reports</span>
                        </a>
                    </div>
                </div>
                
                <!-- Admin Section -->
                <div class="nav-section admin-only" id="admin-nav" style="display: none;">
                    <h3 class="nav-section-title">Admin</h3>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showTeamManagement()" data-view="team">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">groups</span>
                            </div>
                            <span class="nav-text">Team Management</span>
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showAuditLogs()" data-view="audit">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">history</span>
                            </div>
                            <span class="nav-text">Audit Logs</span>
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSystemConfig()" data-view="config">
                            <div class="nav-icon">
                                <span class="material-symbols-outlined">tune</span>
                            </div>
                            <span class="nav-text">System Config</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- === Main Content === -->
        <main class="dashboard-main">
            <div class="main-content">
                
                <!-- === Dashboard View === -->
                <div id="dashboard-view" class="view-container fade-in">
                    <div class="dashboard-grid">
                        
                        <!-- Stats Cards Row -->
                        <div class="grid-col-3">
                            <div class="dashboard-card stats-card scale-in">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">My Cases</h3>
                                        <p class="card-subtitle">Currently assigned</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <span class="stats-number" id="my-cases-count">--</span>
                                    <div class="stats-change positive" id="my-cases-change">
                                        <span class="material-symbols-outlined">trending_up</span>
                                        <span>+3 this week</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid-col-3">
                            <div class="dashboard-card stats-card scale-in" style="animation-delay: 0.1s;">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">Open Cases</h3>
                                        <p class="card-subtitle">In progress</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <span class="stats-number" id="open-cases-count">--</span>
                                    <div class="stats-change" id="open-cases-change">
                                        <span class="material-symbols-outlined">trending_flat</span>
                                        <span>No change</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid-col-3">
                            <div class="dashboard-card stats-card scale-in" style="animation-delay: 0.2s;">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">Closed Today</h3>
                                        <p class="card-subtitle">Today's closures</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <span class="stats-number" id="closed-today-count">--</span>
                                    <div class="stats-change positive" id="closed-today-change">
                                        <span class="material-symbols-outlined">trending_up</span>
                                        <span>+2 vs yesterday</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid-col-3">
                            <div class="dashboard-card stats-card scale-in" style="animation-delay: 0.3s;">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">Total Cases</h3>
                                        <p class="card-subtitle">All time count</p>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <span class="stats-number" id="total-cases-count">--</span>
                                    <div class="stats-change positive" id="total-cases-change">
                                        <span class="material-symbols-outlined">trending_up</span>
                                        <span>+5 this month</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sentiment Card -->
                        <div class="grid-col-6">
                            <div class="dashboard-card sentiment-card slide-in-left" style="animation-delay: 0.4s;">
                                <div class="card-header">
                                    <div>
                                        <h3 class="card-title">Sentiment Score</h3>
                                        <p class="card-subtitle" id="sentiment-period-text">This month's score</p>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn btn-icon" onclick="showSentimentModal()" aria-label="Edit sentiment score">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="sentiment-display">
                                        <div class="sentiment-score-display">
                                            <span class="sentiment-number" id="current-sentiment-score">--</span>
                                            <span class="sentiment-scale">/10</span>
                                        </div>
                                        <div class="sentiment-info">
                                            <div class="sentiment-period" id="sentiment-status">Loading...</div>
                                            <div class="sentiment-trend">
                                                <span class="material-symbols-outlined" id="sentiment-trend-icon">trending_flat</span>
                                                <span id="sentiment-trend-text">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="grid-col-6">
                            <div class="dashboard-card slide-in-right" style="animation-delay: 0.5s;">
                                <div class="card-header">
                                    <h3 class="card-title">Quick Actions</h3>
                                </div>
                                <div class="card-body">
                                    <div class="quick-actions-grid">
                                        <button class="btn btn-primary" onclick="showCreateCase()">
                                            <span class="material-symbols-outlined">add</span>
                                            Create New Case
                                        </button>
                                        <button class="btn btn-secondary" onclick="showAdvancedSearch()">
                                            <span class="material-symbols-outlined">search</span>
                                            Advanced Search
                                        </button>
                                        <button class="btn btn-secondary" onclick="showReports()">
                                            <span class="material-symbols-outlined">analytics</span>
                                            View Reports
                                        </button>
                                        <button class="btn btn-secondary" onclick="openLiveMode()">
                                            <span class="material-symbols-outlined">open_in_new</span>
                                            Live Mode
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="grid-col-12">
                            <div class="dashboard-card fade-in" style="animation-delay: 0.6s;">
                                <div class="card-header">
                                    <h3 class="card-title">Recent Activity</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-icon" onclick="refreshRecentActivity()" aria-label="Refresh">
                                            <span class="material-symbols-outlined">refresh</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="recent-activity" class="recent-activity-list">
                                        <div class="loading-skeleton" style="height: 60px; margin-bottom: 12px;"></div>
                                        <div class="loading-skeleton" style="height: 60px; margin-bottom: 12px;"></div>
                                        <div class="loading-skeleton" style="height: 60px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === Case List View === -->
                <div id="case-list-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">My Cases</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-icon" onclick="refreshCaseList()" aria-label="Refresh">
                                            <span class="material-symbols-outlined">refresh</span>
                                        </button>
                                        <button class="btn btn-primary" onclick="showCreateCase()">
                                            <span class="material-symbols-outlined">add</span>
                                            Create New
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Status Tabs (Spec 4.2.2) -->
                                    <div class="status-tabs-container">
                                        <div class="status-tabs">
                                            <button class="status-tab active" data-status="all" onclick="filterByStatus('all')">
                                                <span class="tab-label">All Cases</span>
                                                <span class="tab-count" id="all-count">0</span>
                                            </button>
                                            <button class="status-tab" data-status="Assigned" onclick="filterByStatus('Assigned')">
                                                <span class="tab-label">Assigned</span>
                                                <span class="tab-count" id="assigned-count">0</span>
                                            </button>
                                            <button class="status-tab" data-status="Solution Offered" onclick="filterByStatus('Solution Offered')">
                                                <span class="tab-label">Solution Offered</span>
                                                <span class="tab-count" id="solution-offered-count">0</span>
                                            </button>
                                            <button class="status-tab" data-status="Finished" onclick="filterByStatus('Finished')">
                                                <span class="tab-label">Finished</span>
                                                <span class="tab-count" id="finished-count">0</span>
                                            </button>
                                            <button class="status-tab" data-status="Closed" onclick="filterByStatus('Closed')">
                                                <span class="tab-label">Closed</span>
                                                <span class="tab-count" id="closed-count">0</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Search Bar -->
                                    <div class="search-container">
                                        <div class="search-input-wrapper">
                                            <span class="material-symbols-outlined search-icon">search</span>
                                            <input type="text" id="case-search" class="search-input" placeholder="Search cases...">
                                            <button class="btn btn-icon search-clear" id="search-clear" style="display: none;">
                                                <span class="material-symbols-outlined">close</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Advanced Cases Table -->
                                    <div class="advanced-table-container">
                                        <!-- Table Controls -->
                                        <div class="table-controls">
                                            <div class="table-controls-left">
                                                <div class="table-filters">
                                                    <select id="status-filter" class="filter-select">
                                                        <option value="">All Statuses</option>
                                                        <option value="open">Open</option>
                                                        <option value="in-progress">In Progress</option>
                                                        <option value="resolved">Resolved</option>
                                                        <option value="closed">Closed</option>
                                                    </select>
                                                    <select id="type-filter" class="filter-select">
                                                        <option value="">All Types</option>
                                                        <!-- Populated dynamically -->
                                                    </select>
                                                    <input type="date" id="date-from" class="date-filter" placeholder="From date">
                                                    <input type="date" id="date-to" class="date-filter" placeholder="To date">
                                                </div>
                                            </div>
                                            <div class="table-controls-right">
                                                <div class="table-actions">
                                                    <button class="btn btn-icon" id="export-btn" title="Export Data">
                                                        <span class="material-symbols-outlined">download</span>
                                                    </button>
                                                    <button class="btn btn-icon" id="refresh-table" title="Refresh">
                                                        <span class="material-symbols-outlined">refresh</span>
                                                    </button>
                                                    <button class="btn btn-icon" id="table-settings" title="Table Settings">
                                                        <span class="material-symbols-outlined">tune</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Table Wrapper -->
                                        <div class="table-wrapper">
                                            <table class="enterprise-table" id="cases-table">
                                                <thead>
                                                    <tr>
                                                        <th class="select-column">
                                                            <label class="checkbox-container">
                                                                <input type="checkbox" id="select-all">
                                                                <span class="checkmark"></span>
                                                            </label>
                                                        </th>
                                                        <th class="sortable" data-sort="caseId">
                                                            <div class="column-header">
                                                                <span>Case ID</span>
                                                                <span class="sort-indicator">
                                                                    <span class="material-symbols-outlined">unfold_more</span>
                                                                </span>
                                                            </div>
                                                        </th>
                                                        <th class="sortable" data-sort="type">
                                                            <div class="column-header">
                                                                <span>Type</span>
                                                                <span class="sort-indicator">
                                                                    <span class="material-symbols-outlined">unfold_more</span>
                                                                </span>
                                                            </div>
                                                        </th>
                                                        <th class="sortable" data-sort="status">
                                                            <div class="column-header">
                                                                <span>Status</span>
                                                                <span class="sort-indicator">
                                                                    <span class="material-symbols-outlined">unfold_more</span>
                                                                </span>
                                                            </div>
                                                        </th>
                                                        <th class="sortable" data-sort="priority">
                                                            <div class="column-header">
                                                                <span>Priority</span>
                                                                <span class="sort-indicator">
                                                                    <span class="material-symbols-outlined">unfold_more</span>
                                                                </span>
                                                            </div>
                                                        </th>
                                                        <th class="sortable" data-sort="openDate">
                                                            <div class="column-header">
                                                                <span>Open Date</span>
                                                                <span class="sort-indicator">
                                                                    <span class="material-symbols-outlined">unfold_more</span>
                                                                </span>
                                                            </div>
                                                        </th>
                                                        <th class="sortable" data-sort="assignee">
                                                            <div class="column-header">
                                                                <span>Assignee</span>
                                                                <span class="sort-indicator">
                                                                    <span class="material-symbols-outlined">unfold_more</span>
                                                                </span>
                                                            </div>
                                                        </th>
                                                        <th class="sortable" data-sort="progress">
                                                            <div class="column-header">
                                                                <span>Progress</span>
                                                                <span class="sort-indicator">
                                                                    <span class="material-symbols-outlined">unfold_more</span>
                                                                </span>
                                                            </div>
                                                        </th>
                                                        <th class="actions-column">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="cases-table-body">
                                                    <!-- Dynamic content will be inserted here -->
                                                    <tr class="loading-row">
                                                        <td colspan="9">
                                                            <div class="table-loading">
                                                                <div class="loading-spinner"></div>
                                                                <span>Loading cases...</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Pagination -->
                                        <div class="table-pagination">
                                            <div class="pagination-info">
                                                <span>Rows per page:</span>
                                                <select id="rows-per-page" class="rows-select">
                                                    <option value="10">10</option>
                                                    <option value="25" selected>25</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select>
                                                <span id="page-info">1-25 of 250</span>
                                            </div>
                                            <div class="pagination-controls">
                                                <button class="btn btn-icon" id="first-page" disabled>
                                                    <span class="material-symbols-outlined">first_page</span>
                                                </button>
                                                <button class="btn btn-icon" id="prev-page" disabled>
                                                    <span class="material-symbols-outlined">chevron_left</span>
                                                </button>
                                                <div class="page-numbers" id="page-numbers">
                                                    <!-- Page numbers will be generated -->
                                                </div>
                                                <button class="btn btn-icon" id="next-page">
                                                    <span class="material-symbols-outlined">chevron_right</span>
                                                </button>
                                                <button class="btn btn-icon" id="last-page">
                                                    <span class="material-symbols-outlined">last_page</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === Case Form View === -->
                <div id="case-form-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title" id="form-title">Create New Case</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-secondary" onclick="cancelCaseForm()">
                                            <span class="material-symbols-outlined">close</span>
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <form id="case-form" class="case-form">
                                        <!-- Dynamic form content will be generated here -->
                                        <div class="loading-skeleton" style="height: 200px;"></div>
                                    </form>
                                </div>
                                <div class="card-actions">
                                    <button type="button" class="btn btn-primary" onclick="submitCaseForm()">
                                        <span class="material-symbols-outlined">save</span>
                                        Save Case
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelCaseForm()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === Search View === -->
                <div id="search-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Advanced Search</h3>
                                </div>
                                <div class="card-body">
                                    <form id="search-form" class="search-form">
                                        <div class="form-grid">
                                            <div class="form-field">
                                                <label for="search-query">Search Query</label>
                                                <input type="text" id="search-query" placeholder="Enter search keywords...">
                                            </div>
                                            <div class="form-field">
                                                <label for="search-sheet-type">Sheet Type</label>
                                                <select id="search-sheet-type">
                                                    <option value="">All Sheet Types</option>
                                                    <!-- Populated dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-actions">
                                            <button type="button" class="btn btn-primary" onclick="performAdvancedSearch()">
                                                <span class="material-symbols-outlined">search</span>
                                                Execute Search
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div id="search-results" class="search-results">
                                        <!-- Search results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === Sentiment View === -->
                <div id="sentiment-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Sentiment Score Management</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-primary" onclick="showSentimentModal()">
                                            <span class="material-symbols-outlined">edit</span>
                                            Edit Score
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Current Month Score -->
                                    <div class="sentiment-current-section">
                                        <h4>Current Month Score</h4>
                                        <div class="current-sentiment-display">
                                            <div class="sentiment-score-large">
                                                <span id="current-month-score" class="score-large">--</span>
                                                <span class="scale-text">/10</span>
                                            </div>
                                            <div class="sentiment-info">
                                                <p id="current-month-text">Loading...</p>
                                                <p id="current-month-status" class="status-text">--</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Historical Chart -->
                                    <div class="sentiment-history-section">
                                        <h4>12-Month History</h4>
                                        <div id="sentiment-history-chart" class="sentiment-history-chart">
                                            <div class="loading-skeleton" style="height: 300px;"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- History Table -->
                                    <div class="sentiment-table-section">
                                        <h4>Score History</h4>
                                        <div class="table-container">
                                            <table class="data-table" id="sentiment-history-table">
                                                <thead>
                                                    <tr>
                                                        <th>Period</th>
                                                        <th>Score</th>
                                                        <th>Comment</th>
                                                        <th>Last Modified</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="sentiment-history-tbody">
                                                    <!-- Dynamic content -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === Reports View === -->
                <div id="reports-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <!-- Report Controls -->
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Analytics & Reports Dashboard</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-secondary" onclick="refreshReportsData()">
                                            <span class="material-symbols-outlined">refresh</span>
                                            Refresh All
                                        </button>
                                        <button class="btn btn-primary" onclick="exportFullReport()">
                                            <span class="material-symbols-outlined">download</span>
                                            Export Full Report
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Period Selection Controls -->
                                    <div class="reports-period-controls">
                                        <h5>Report Period</h5>
                                        <div class="form-grid">
                                            <div class="form-field">
                                                <label for="reports-period-type">Period Type</label>
                                                <select id="reports-period-type" onchange="togglePeriodFields(this.value)">
                                                    <option value="monthly">Monthly</option>
                                                    <option value="quarterly">Quarterly</option>
                                                    <option value="yearly">Yearly</option>
                                                    <option value="custom">Custom Range</option>
                                                </select>
                                            </div>
                                            <div class="form-field">
                                                <label for="reports-year">Year</label>
                                                <select id="reports-year">
                                                    <!-- Populated dynamically -->
                                                </select>
                                            </div>
                                            <div class="form-field" id="reports-month-field">
                                                <label for="reports-month">Month</label>
                                                <select id="reports-month">
                                                    <option value="1">January</option>
                                                    <option value="2">February</option>
                                                    <option value="3">March</option>
                                                    <option value="4">April</option>
                                                    <option value="5">May</option>
                                                    <option value="6">June</option>
                                                    <option value="7">July</option>
                                                    <option value="8">August</option>
                                                    <option value="9">September</option>
                                                    <option value="10">October</option>
                                                    <option value="11">November</option>
                                                    <option value="12">December</option>
                                                </select>
                                            </div>
                                            <div class="form-field" id="reports-quarter-field" style="display: none;">
                                                <label for="reports-quarter">Quarter</label>
                                                <select id="reports-quarter">
                                                    <option value="1">Q1 (Jan-Mar)</option>
                                                    <option value="2">Q2 (Apr-Jun)</option>
                                                    <option value="3">Q3 (Jul-Sep)</option>
                                                    <option value="4">Q4 (Oct-Dec)</option>
                                                </select>
                                            </div>
                                            <div class="form-field" id="reports-custom-from-field" style="display: none;">
                                                <label for="reports-custom-from">From Date</label>
                                                <input type="date" id="reports-custom-from">
                                            </div>
                                            <div class="form-field" id="reports-custom-to-field" style="display: none;">
                                                <label for="reports-custom-to">To Date</label>
                                                <input type="date" id="reports-custom-to">
                                            </div>
                                        </div>
                                        <div class="form-actions">
                                            <button class="btn btn-primary" onclick="applyPeriodFilter()">
                                                <span class="material-symbols-outlined">filter_alt</span>
                                                Apply Filter
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TRT Analytics Section -->
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">TRT(P95) Analytics</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-secondary" onclick="exportTRTReport()">
                                            <span class="material-symbols-outlined">download</span>
                                            Export TRT
                                        </button>
                                        <button class="btn btn-secondary" onclick="setupTRTNotifications()">
                                            <span class="material-symbols-outlined">notifications</span>
                                            Setup Alerts
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="trt-analytics-container">
                                        <div class="loading-skeleton" style="height: 400px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sentiment Integration Section -->
                        <div class="grid-col-6">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Sentiment Integration</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-secondary" onclick="exportSentimentReport()">
                                            <span class="material-symbols-outlined">download</span>
                                            Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="sentiment-integration-container">
                                        <div class="loading-skeleton" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Charts Section -->
                        <div class="grid-col-6">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Performance Statistics</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-secondary" onclick="exportStatisticsReport()">
                                            <span class="material-symbols-outlined">download</span>
                                            Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="statistics-charts-container">
                                        <div class="loading-skeleton" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Options Section -->
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Export & Sharing Options</h3>
                                </div>
                                <div class="card-body">
                                    <div class="export-options-grid">
                                        <div class="export-option-card">
                                            <div class="export-icon">
                                                <span class="material-symbols-outlined">timer</span>
                                            </div>
                                            <div class="export-content">
                                                <h5>TRT Analytics Report</h5>
                                                <p>Complete TRT(P95) analysis with trends and exclusions</p>
                                                <button class="btn btn-primary" onclick="exportTRTReport()">
                                                    <span class="material-symbols-outlined">download</span>
                                                    Export TRT
                                                </button>
                                            </div>
                                        </div>

                                        <div class="export-option-card">
                                            <div class="export-icon">
                                                <span class="material-symbols-outlined">sentiment_satisfied</span>
                                            </div>
                                            <div class="export-content">
                                                <h5>Sentiment Report</h5>
                                                <p>Sentiment scores and trends analysis</p>
                                                <button class="btn btn-primary" onclick="exportSentimentReport()">
                                                    <span class="material-symbols-outlined">download</span>
                                                    Export Sentiment
                                                </button>
                                            </div>
                                        </div>

                                        <div class="export-option-card">
                                            <div class="export-icon">
                                                <span class="material-symbols-outlined">analytics</span>
                                            </div>
                                            <div class="export-content">
                                                <h5>Statistics Report</h5>
                                                <p>Comprehensive performance statistics</p>
                                                <button class="btn btn-primary" onclick="exportStatisticsReport()">
                                                    <span class="material-symbols-outlined">download</span>
                                                    Export Stats
                                                </button>
                                            </div>
                                        </div>

                                        <div class="export-option-card">
                                            <div class="export-icon">
                                                <span class="material-symbols-outlined">folder_zip</span>
                                            </div>
                                            <div class="export-content">
                                                <h5>Combined Report</h5>
                                                <p>All analytics combined in one comprehensive report</p>
                                                <button class="btn btn-primary" onclick="exportCombinedReport()">
                                                    <span class="material-symbols-outlined">download</span>
                                                    Export All
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === Team Management View === -->
                <div id="team-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Team Management</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-secondary" onclick="refreshTeamData()">
                                            <span class="material-symbols-outlined">refresh</span>
                                            Refresh
                                        </button>
                                        <button class="btn btn-secondary" onclick="exportTeamReport()">
                                            <span class="material-symbols-outlined">download</span>
                                            Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="team-management-content">
                                        <div class="loading-skeleton" style="height: 400px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === Audit Logs View === -->
                <div id="audit-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">Audit Logs</h3>
                                    <div class="card-actions">
                                        <input type="date" id="audit-date-from" class="date-filter">
                                        <input type="date" id="audit-date-to" class="date-filter">
                                        <button class="btn btn-secondary" onclick="refreshAuditLogs()">
                                            <span class="material-symbols-outlined">search</span>
                                            Filter
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="audit-logs-content">
                                        <div class="loading-skeleton" style="height: 400px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- === System Config View === -->
                <div id="config-view" class="view-container" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="grid-col-12">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3 class="card-title">System Configuration</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-primary" onclick="saveSystemConfig()">
                                            <span class="material-symbols-outlined">save</span>
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="system-config-content">
                                        <div class="loading-skeleton" style="height: 400px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- === Dialogs & Modals === -->
    
    <!-- Case Detail Dialog -->
    <dialog class="modal-dialog" id="case-detail-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Case Details</h3>
                <button class="btn btn-icon close-modal" aria-label="Close">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="case-detail-content">
                    <!-- Case details will be loaded here -->
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="editCase()">
                    <span class="material-symbols-outlined">edit</span>
                    Edit
                </button>
                <button type="button" class="btn btn-secondary close-modal">
                    Close
                </button>
            </div>
        </div>
    </dialog>
    
    <!-- Sentiment Score Modal -->
    <dialog class="modal-dialog" id="sentiment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Monthly Sentiment Score</h3>
                <button class="btn btn-icon close-modal" aria-label="Close">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="sentiment-form">
                    <!-- Period Selection -->
                    <div class="sentiment-period-selection">
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="sentiment-year">Year</label>
                                <select id="sentiment-year" required>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="sentiment-month">Month</label>
                                <select id="sentiment-month" required>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Score Input -->
                    <div class="sentiment-score-input">
                        <h5>Sentiment Score (1.0 - 10.0)</h5>
                        <div class="score-slider-container">
                            <input type="range" id="sentiment-score-slider" min="1" max="10" step="0.5" value="5" class="sentiment-slider">
                            <div class="score-display">
                                <span id="sentiment-score-display" class="score-value">5.0</span>
                                <span class="score-scale">/10</span>
                            </div>
                        </div>
                        <div class="score-buttons">
                            <button type="button" class="btn btn-icon" onclick="adjustScore(-0.5)" aria-label="Decrease by 0.5">
                                <span class="material-symbols-outlined">remove</span>
                            </button>
                            <button type="button" class="btn btn-icon" onclick="adjustScore(0.5)" aria-label="Increase by 0.5">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Comment Input -->
                    <div class="form-field">
                        <label for="sentiment-comment">Comment (optional)</label>
                        <textarea id="sentiment-comment" rows="3" maxlength="500" placeholder="Enter your comments about this score..."></textarea>
                        <div class="field-hint">Maximum 500 characters</div>
                    </div>
                    
                    <!-- Validation Messages -->
                    <div id="sentiment-validation-messages" class="validation-messages" style="display: none;">
                        <!-- Dynamic validation messages -->
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="saveSentimentScore()">
                    <span class="material-symbols-outlined">save</span>
                    Save Score
                </button>
                <button type="button" class="btn btn-secondary close-modal" onclick="closeSentimentModal()">
                    Cancel
                </button>
            </div>
        </div>
    </dialog>
    
    <!-- Floating Action Button -->
    <button class="btn btn-fab" onclick="showCreateCase()" aria-label="Create new case">
        <span class="material-symbols-outlined">add</span>
    </button>
    
    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container">
        <!-- Toast notifications will be dynamically inserted here -->
    </div>

    <!-- Toast for notifications (legacy) -->
    <div id="toast" class="mdl-snackbar mdl-js-snackbar">
        <div class="mdl-snackbar__text"></div>
        <button class="mdl-snackbar__action" type="button"></button>
    </div>
    
    <!-- === Scripts === -->
    
    <!-- Core Dependencies -->
    <?!= include('server/Dependencies'); ?>
    
    <!-- Theme Manager -->
    <?!= include('client/js/ThemeManager'); ?>
    
    <!-- Main Application Script -->
    <?!= include('client/js/AppMain'); ?>
    
    <!-- App Main Logic Script -->
    <?!= include('client/js/AppMainLogic'); ?>
    
    <!-- Statistics Manager Script -->
    <?!= include('client/js/StatisticsManager'); ?>
    
    <!-- Case Manager Script -->
    <?!= include('client/js/CaseManagerModule'); ?>
    
    <!-- Form Generator Script -->
    <?!= include('client/js/FormGenerator'); ?>
    
    <!-- Sentiment Manager Script -->
    <?!= include('client/js/SentimentManager'); ?>
    
    <!-- Dashboard Manager Script -->
    <?!= include('client/js/DashboardManager'); ?>
    
    <script>
        // ===== Application Initialization =====
        
        /**
         * Initialize the CasesDash application
         */
        function initializeCasesDash() {
            console.log('🚀 Initializing CasesDash Material Dashboard...');
            
            try {
                // Hide loading spinner first
                hideLoadingSpinner();
                
                // Initialize sidebar functionality
                initializeSidebar();
                
                // Initialize user menu
                initializeUserMenu();
                
                // Initialize modal dialogs
                initializeDialogs();
                
                // Initialize search functionality
                initializeSearch();
                
                // Initialize theme toggle functionality
                initializeThemeToggle();
                
                // Initialize application components
                if (window.CasesDashApp && typeof window.CasesDashApp.initialize === 'function') {
                    window.CasesDashApp.initialize();
                } else {
                    console.warn('❌ CasesDashApp not available, using fallback');
                    initializeFallback();
                }
                
                // Initialize Dashboard Manager
                if (window.CasesDashDashboardManager && typeof window.CasesDashDashboardManager.initialize === 'function') {
                    window.CasesDashDashboardManager.initialize();
                    console.log('✅ Dashboard Manager initialized');
                } else {
                    console.warn('⚠️ Dashboard Manager not available');
                }
                
                console.log('✅ CasesDash initialized successfully');
                
            } catch (error) {
                console.error('❌ Failed to initialize CasesDash:', error);
                showErrorToast('Failed to initialize application');
            }
        }
        
        /**
         * Force hide loading spinner immediately
         */
        function hideLoadingSpinner() {
            const spinner = document.getElementById('loading-overlay');
            if (spinner) {
                spinner.style.display = 'none';
                console.log('✅ Loading spinner hidden');
            }
        }
        
        /**
         * Initialize sidebar functionality
         */
        function initializeSidebar() {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const body = document.body;
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    body.classList.toggle('sidebar-collapsed');
                    
                    // Update icon
                    const icon = sidebarToggle.querySelector('.material-symbols-outlined');
                    if (body.classList.contains('sidebar-collapsed')) {
                        icon.textContent = 'menu_open';
                    } else {
                        icon.textContent = 'menu';
                    }
                    
                    // Update aria-expanded
                    const isExpanded = !body.classList.contains('sidebar-collapsed');
                    sidebarToggle.setAttribute('aria-expanded', isExpanded.toString());
                });
                
                // Handle mobile sidebar
                if (window.innerWidth <= 768) {
                    body.classList.add('sidebar-collapsed');
                }
            }
        }
        
        /**
         * Initialize user menu functionality
         */
        function initializeUserMenu() {
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            
            if (userMenuButton && userMenu) {
                userMenuButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = !userMenu.hidden;
                    
                    userMenu.hidden = isOpen;
                    userMenuButton.setAttribute('aria-expanded', (!isOpen).toString());
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function() {
                    userMenu.hidden = true;
                    userMenuButton.setAttribute('aria-expanded', 'false');
                });
                
                // Handle menu item clicks
                userMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Find the clicked menu item
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem) {
                        // Close the menu first
                        userMenu.hidden = true;
                        userMenuButton.setAttribute('aria-expanded', 'false');
                        
                        // Execute the appropriate action based on the menu item
                        const onclick = menuItem.getAttribute('onclick');
                        if (onclick) {
                            try {
                                // Execute the onclick function
                                eval(onclick);
                            } catch (error) {
                                console.error('Error executing menu action:', error);
                                showErrorToast('Menu action failed: ' + error.message);
                            }
                        }
                    }
                });
            }
        }
        
        /**
         * Initialize modal dialogs
         */
        function initializeDialogs() {
            const dialogs = document.querySelectorAll('.modal-dialog');
            
            dialogs.forEach(dialog => {
                const closeButtons = dialog.querySelectorAll('.close-modal');
                
                closeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        dialog.close();
                    });
                });
                
                // Close on backdrop click
                dialog.addEventListener('click', function(e) {
                    if (e.target === dialog) {
                        dialog.close();
                    }
                });
                
                // Handle escape key
                dialog.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        dialog.close();
                    }
                });
            });
        }
        
        /**
         * Initialize search functionality
         */
        function initializeSearch() {
            const searchInput = document.getElementById('case-search');
            const searchClear = document.getElementById('search-clear');
            
            if (searchInput && searchClear) {
                searchInput.addEventListener('input', function() {
                    if (this.value.length > 0) {
                        searchClear.style.display = 'flex';
                    } else {
                        searchClear.style.display = 'none';
                    }
                });
                
                searchClear.addEventListener('click', function() {
                    searchInput.value = '';
                    searchClear.style.display = 'none';
                    searchInput.focus();
                });
            }
        }
        
        /**
         * Fallback initialization when main app is not available
         */
        function initializeFallback() {
            console.log('🔧 Running in fallback mode');
            
            // Show loading placeholders
            showLoadingPlaceholders();
            
            // Set up basic navigation
            setupBasicNavigation();
        }
        
        /**
         * Show loading placeholders
         */
        function showLoadingPlaceholders() {
            // Update stats with placeholder values
            const elements = [
                'my-cases-count', 'open-cases-count', 
                'closed-today-count', 'total-cases-count', 
                'current-sentiment-score'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '--';
                }
            });
        }
        
        /**
         * Set up basic navigation
         */
        function setupBasicNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active state
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding view
                    const viewName = this.getAttribute('data-view');
                    if (viewName) {
                        showView(viewName);
                    }
                });
            });
        }
        
        /**
         * Show a specific view
         */
        function showView(viewName) {
            const views = document.querySelectorAll('.view-container');
            views.forEach(view => {
                view.style.display = 'none';
            });
            
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.style.display = 'block';
                targetView.classList.add('fade-in');
            }
        }
        
        /**
         * Show error toast notification
         */
        function showErrorToast(message) {
            console.error('Error:', message);
            showToast(message, 'error');
        }
        
        /**
         * Show success toast notification
         */
        function showSuccessToast(message) {
            console.log('Success:', message);
            showToast(message, 'success');
        }
        
        /**
         * Show warning toast notification
         */
        function showWarningToast(message) {
            console.warn('Warning:', message);
            showToast(message, 'warning');
        }
        
        /**
         * Show toast notification
         */
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                console.error('Toast container not found');
                return;
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Add icon based on type
            let iconName = 'info';
            switch (type) {
                case 'success':
                    iconName = 'check_circle';
                    break;
                case 'error':
                    iconName = 'error';
                    break;
                case 'warning':
                    iconName = 'warning';
                    break;
                default:
                    iconName = 'info';
            }
            
            toast.innerHTML = `
                <span class="material-symbols-outlined">${iconName}</span>
                <span>${message}</span>
            `;
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, 5000);
            
            // Allow manual close on click
            toast.addEventListener('click', () => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            });
        }
        
        // ===== Global Functions (for compatibility) =====
        
        window.showDashboard = function() {
            showView('dashboard');
            // Initialize Dashboard Manager if available
            if (window.CasesDashDashboardManager && typeof window.CasesDashDashboardManager.initialize === 'function') {
                // Re-initialize to ensure fresh data
                setTimeout(() => {
                    window.CasesDashDashboardManager.refreshActiveCases();
                }, 100);
            }
        };
        window.showCaseList = function() { showView('case-list'); };
        window.showCreateCase = function() {
            console.log('🎯 Create Case clicked - Using Dynamic Form (spec 4.3.2)');
            
            // Priority: Use dynamic form creation (spec 4.3.2)
            if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.createNewCase === 'function') {
                console.log('✅ Using CaseManager createNewCase (dynamic modal)');
                // CaseManager uses dynamic modal dialogs based on specification
                window.CasesDashCaseManager.createNewCase();
            } else if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.showCaseCreationForm === 'function') {
                console.log('✅ Using CaseManager showCaseCreationForm (spec-based modal)');
                // Fallback to specification-based form
                window.CasesDashCaseManager.showCaseCreationForm();
            } else {
                console.log('⚠️ CaseManager not available, using enhanced fallback');
                showView('case-form');
                // Initialize enhanced case form with specification support
                setTimeout(() => {
                    const loadingSkeleton = document.querySelector('#case-form .loading-skeleton');
                    if (loadingSkeleton) {
                        loadingSkeleton.style.display = 'none';
                    }
                    initializeSpecificationBasedCaseForm();
                }, 100);
            }
        };
        window.showAdvancedSearch = function() {
            console.log('🔍 Advanced Search clicked');
            showView('search');
            initializeAdvancedSearch();
        };
        window.showReports = function() {
            console.log('📊 Reports clicked');
            showView('reports');
            initializeReports();
        };
        window.showTeamManagement = function() { console.log('Team management requested'); };
        window.showAuditLogs = function() { console.log('Audit logs requested'); };
        // User Menu Functions - Enhanced implementations
        window.showUserProfile = function() {
            console.log('👤 User profile requested');
            try {
                // Create and show user profile modal
                const profileModal = createUserProfileModal();
                document.body.appendChild(profileModal);
                profileModal.showModal();
            } catch (error) {
                console.error('Failed to show user profile:', error);
                showErrorToast('Failed to load user profile.');
            }
        };
        
        window.showSettings = function() {
            console.log('⚙️ Settings requested');
            try {
                // Create and show settings modal
                const settingsModal = createSettingsModal();
                document.body.appendChild(settingsModal);
                settingsModal.showModal();
            } catch (error) {
                console.error('Failed to show settings:', error);
                showErrorToast('Failed to load settings.');
            }
        };
        
        window.logout = function() {
            console.log('🚪 Logout requested');
            try {
                if (confirm('Are you sure you want to logout?')) {
                    // Clear any stored data
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Show logout message
                    showSuccessToast('Logged out successfully');
                    
                    // Redirect to logout or reload page
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            } catch (error) {
                console.error('Logout error:', error);
                showErrorToast('Logout failed. Please close the browser window.');
            }
        };
        
        /**
         * Create user profile modal
         */
        function createUserProfileModal() {
            const modal = document.createElement('dialog');
            modal.className = 'modal-dialog';
            modal.id = 'user-profile-modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <span class="material-symbols-outlined">person</span>
                            User Profile
                        </h3>
                        <button class="btn btn-icon close-modal" aria-label="Close">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="profile-section">
                            <h5>User Information</h5>
                            <div class="profile-field">
                                <label>Email:</label>
                                <span id="profile-email">Loading...</span>
                            </div>
                            <div class="profile-field">
                                <label>Role:</label>
                                <span id="profile-role">Loading...</span>
                            </div>
                            <div class="profile-field">
                                <label>Last Login:</label>
                                <span id="profile-last-login">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="profile-section">
                            <h5>System Information</h5>
                            <div class="profile-field">
                                <label>Application Version:</label>
                                <span>CasesDash v1.0</span>
                            </div>
                            <div class="profile-field">
                                <label>Browser:</label>
                                <span id="profile-browser">${navigator.userAgent.split(' ')[0]}</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary close-modal">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            // Setup close functionality
            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target.classList.contains('close-modal')) {
                    modal.close();
                    modal.remove();
                }
            });
            
            // Load user data
            setTimeout(() => {
                loadUserProfileData(modal);
            }, 100);
            
            return modal;
        }
        
        /**
         * Create settings modal
         */
        function createSettingsModal() {
            const modal = document.createElement('dialog');
            modal.className = 'modal-dialog';
            modal.id = 'settings-modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <span class="material-symbols-outlined">settings</span>
                            Settings
                        </h3>
                        <button class="btn btn-icon close-modal" aria-label="Close">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Spreadsheet Configuration Section (Migrated from setup.html) -->
                        <div class="settings-section">
                            <h5>
                                <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">table_chart</span>
                                Spreadsheet Configuration
                            </h5>
                            <div class="setting-field" style="flex-direction: column; align-items: flex-start;">
                                <label for="spreadsheet-id-setting" style="margin-bottom: 8px;">Google Spreadsheet ID:</label>
                                <input 
                                    type="text" 
                                    id="spreadsheet-id-setting" 
                                    placeholder="Enter your spreadsheet ID or URL..."
                                    style="width: 100%; padding: 12px; border: 2px solid var(--current-surface-container-highest); border-radius: 4px; background: var(--current-surface-container); color: var(--current-on-surface); font-size: 14px; margin-bottom: 8px;"
                                >
                                <div style="font-size: 12px; color: var(--current-on-surface-variant); margin-bottom: 12px;">
                                    Find this in your spreadsheet URL: https://docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit
                                </div>
                                <div style="display: flex; gap: 12px; width: 100%;">
                                    <button type="button" class="btn btn-secondary" onclick="testSpreadsheetConnection()" id="test-connection-btn">
                                        <span class="material-symbols-outlined">wifi_protected_setup</span>
                                        Test Connection
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="validateSpreadsheetSheets()" id="validate-sheets-btn">
                                        <span class="material-symbols-outlined">fact_check</span>
                                        Validate Sheets
                                    </button>
                                </div>
                                <div id="spreadsheet-status" style="margin-top: 12px; display: none;"></div>
                                <div id="sheet-validation-results" style="margin-top: 12px; display: none;">
                                    <h6 style="margin: 0 0 8px 0; color: var(--current-on-surface);">Sheet Validation Results:</h6>
                                    <div id="sheet-validation-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h5>Display Settings</h5>
                            <div class="setting-field">
                                <label for="theme-setting">Theme:</label>
                                <select id="theme-setting" class="form-control">
                                    <option value="dark">Dark Mode</option>
                                    <option value="light">Light Mode</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                            </div>
                            <div class="setting-field">
                                <label for="rows-per-page-setting">Rows Per Page:</label>
                                <select id="rows-per-page-setting" class="form-control">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h5>Notification Settings</h5>
                            <div class="setting-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="enable-notifications" checked>
                                    <span class="checkmark"></span>
                                    Enable notifications
                                </label>
                            </div>
                            <div class="setting-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="enable-sound" checked>
                                    <span class="checkmark"></span>
                                    Enable sound alerts
                                </label>
                            </div>
                        </div>

                        <!-- Team Leadership Configuration (spec 4.6.4) -->
                        <div class="settings-section" id="team-leadership-section" style="display: none;">
                            <h5>
                                <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">groups</span>
                                Team Leadership Configuration
                            </h5>
                            <div class="setting-field" style="flex-direction: column; align-items: flex-start;">
                                <label style="margin-bottom: 8px;">Google Chat Notification Room URL:</label>
                                <input 
                                    type="url" 
                                    id="chat-webhook-url" 
                                    placeholder="https://chat.googleapis.com/v1/spaces/..."
                                    style="width: 100%; padding: 12px; border: 2px solid var(--current-surface-container-highest); border-radius: 4px; background: var(--current-surface-container); color: var(--current-on-surface); font-size: 14px; margin-bottom: 8px;"
                                >
                                <div style="font-size: 12px; color: var(--current-on-surface-variant); margin-bottom: 12px;">
                                    URL for P95 alerts to team leaders (PL/TL/JTL/QM/WFM). Use Google Chat Apps for webhooks.
                                </div>
                                
                                <label style="margin-bottom: 8px;">Default Team Leaders (one per line):</label>
                                <textarea 
                                    id="default-team-leaders" 
                                    placeholder="team-leader@google.com&#10;qa-manager@google.com&#10;admin@google.com"
                                    rows="4"
                                    style="width: 100%; padding: 12px; border: 2px solid var(--current-surface-container-highest); border-radius: 4px; background: var(--current-surface-container); color: var(--current-on-surface); font-size: 14px; resize: vertical; margin-bottom: 8px;"
                                ></textarea>
                                <div style="font-size: 12px; color: var(--current-on-surface-variant); margin-bottom: 12px;">
                                    Fallback notification recipients when specific team leaders are not configured.
                                </div>
                                
                                <button type="button" class="btn btn-secondary" onclick="saveTeamLeadershipConfig()" id="save-team-config-btn">
                                    <span class="material-symbols-outlined">save</span>
                                    Save Team Configuration
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">
                            <span class="material-symbols-outlined">save</span>
                            Save Settings
                        </button>
                        <button type="button" class="btn btn-secondary close-modal">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Setup close functionality
            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target.classList.contains('close-modal')) {
                    modal.close();
                    modal.remove();
                }
            });
            
            // Load current settings
            setTimeout(() => {
                loadCurrentSettings(modal);
            }, 100);
            
            return modal;
        }
        
        /**
         * Load user profile data
         */
        function loadUserProfileData(modal) {
            try {
                // Google Apps Scriptからユーザー情報を取得
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(function(userInfo) {
                            updateUserProfileFields(modal, userInfo);
                        })
                        .withFailureHandler(function(error) {
                            console.error('❌ Error getting user info from GAS:', error);
                            handleUserProfileFallback(modal);
                        })
                        .getCurrentUserInfo();
                } else {
                    // フォールバック: 開発環境での処理
                    console.log('⚠️ Google Apps Script not available, using fallback');
                    handleUserProfileFallback(modal);
                }
            } catch (error) {
                console.error('❌ Failed to load user profile data:', error);
                handleUserProfileFallback(modal);
            }
        }
        
        /**
         * Update user profile fields with user info
         */
        function updateUserProfileFields(modal, userInfo) {
            try {
                const emailField = modal.querySelector('#profile-email');
                const roleField = modal.querySelector('#profile-role');
                const lastLoginField = modal.querySelector('#profile-last-login');
                
                if (userInfo && userInfo.email) {
                    // 開発者用特別アクセス権の確認
                    if (userInfo.email === 'past.and.future37@gmail.com') {
                        if (emailField) emailField.textContent = 'user@google.com (Developer Access)';
                        if (roleField) roleField.textContent = 'Administrator (Developer)';
                        showSuccessToast('開発者アクセス権で認証されました');
                    } else if (userInfo.email.includes('@google.com')) {
                        // LDAPユーザーの場合
                        const ldapUser = userInfo.email.split('@')[0];
                        if (emailField) emailField.textContent = `${ldapUser}@google.com`;
                        if (roleField) roleField.textContent = userInfo.role || 'User';
                    } else {
                        // 未認証または権限なし
                        if (emailField) emailField.textContent = 'Unauthorized Access';
                        if (roleField) roleField.textContent = 'Guest';
                        showWarningToast('認証されていないアクセスです。管理者にお問い合わせください。');
                    }
                    
                    if (lastLoginField) {
                        lastLoginField.textContent = userInfo.lastLogin || new Date().toLocaleString('ja-JP');
                    }
                } else {
                    handleUserProfileError(modal, 'ユーザー情報が取得できませんでした');
                }
            } catch (error) {
                console.error('❌ Error updating user profile fields:', error);
                handleUserProfileError(modal, error.message);
            }
        }
        
        /**
         * Handle user profile fallback for development
         */
        function handleUserProfileFallback(modal) {
            // 開発環境での処理
            const mockUserInfo = {
                email: 'past.and.future37@gmail.com',
                role: 'Administrator',
                lastLogin: new Date().toLocaleString('ja-JP')
            };
            updateUserProfileFields(modal, mockUserInfo);
        }
        
        /**
         * Handle user profile error
         */
        function handleUserProfileError(modal, error) {
            console.error('❌ User profile error:', error);
            const emailField = modal.querySelector('#profile-email');
            const roleField = modal.querySelector('#profile-role');
            const lastLoginField = modal.querySelector('#profile-last-login');
            
            if (emailField) emailField.textContent = 'Error loading email';
            if (roleField) roleField.textContent = 'Error loading role';
            if (lastLoginField) lastLoginField.textContent = 'Error loading login time';
            
            showErrorToast('ユーザー情報の取得に失敗しました');
        }
        
        /**
         * Load current settings
         */
        function loadCurrentSettings(modal) {
            try {
                // Load spreadsheet configuration
                const spreadsheetInput = modal.querySelector('#spreadsheet-id-setting');
                if (spreadsheetInput) {
                    // Try to get current spreadsheet ID from server
                    if (typeof google !== 'undefined' && google.script && google.script.run) {
                        google.script.run
                            .withSuccessHandler(function(spreadsheetId) {
                                if (spreadsheetId) {
                                    spreadsheetInput.value = spreadsheetId;
                                }
                            })
                            .withFailureHandler(function(error) {
                                console.warn('Could not load current spreadsheet ID:', error);
                            })
                            .getCurrentSpreadsheetId();
                    }
                }
                
                // Load theme setting
                const themeSelect = modal.querySelector('#theme-setting');
                if (themeSelect) {
                    const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
                    themeSelect.value = currentTheme;
                    
                    themeSelect.addEventListener('change', function() {
                        if (window.CasesDashThemeManager) {
                            window.CasesDashThemeManager.setTheme(this.value);
                        }
                    });
                }
                
                // Load rows per page setting
                const rowsSelect = modal.querySelector('#rows-per-page-setting');
                if (rowsSelect) {
                    const savedRows = localStorage.getItem('casesdash_rows_per_page') || '25';
                    rowsSelect.value = savedRows;
                }
                
                // Load notification settings
                const notificationsCheckbox = modal.querySelector('#enable-notifications');
                const soundCheckbox = modal.querySelector('#enable-sound');
                
                if (notificationsCheckbox) {
                    notificationsCheckbox.checked = localStorage.getItem('casesdash_notifications') !== 'false';
                }
                
                if (soundCheckbox) {
                    soundCheckbox.checked = localStorage.getItem('casesdash_sound') !== 'false';
                }
                
                // Load team leadership configuration (spec 4.6.4)
                loadTeamLeadershipSettings(modal);
                
            } catch (error) {
                console.error('Failed to load current settings:', error);
            }
        }
        
        /**
         * Load team leadership settings
         */
        function loadTeamLeadershipSettings(modal) {
            try {
                // Check if user has admin/team leader privileges
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(function(userInfo) {
                            if (userInfo && ['admin', 'teamLeader'].includes(userInfo.role)) {
                                // Show team leadership section
                                const teamSection = modal.querySelector('#team-leadership-section');
                                if (teamSection) {
                                    teamSection.style.display = 'block';
                                }
                                
                                // Load existing team configuration
                                loadExistingTeamConfiguration(modal);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.warn('Could not check user role for team settings:', error);
                        })
                        .getCurrentUserInfo();
                }
                
            } catch (error) {
                console.warn('Failed to load team leadership settings:', error);
            }
        }
        
        /**
         * Load existing team configuration
         */
        function loadExistingTeamConfiguration(modal) {
            try {
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(function(config) {
                            if (config && config.success && config.data) {
                                const data = config.data;
                                
                                // Load Chat webhook URL
                                const chatUrlInput = modal.querySelector('#chat-webhook-url');
                                if (chatUrlInput && data.chatWebhookUrl) {
                                    chatUrlInput.value = data.chatWebhookUrl;
                                }
                                
                                // Load default team leaders
                                const teamLeadersTextarea = modal.querySelector('#default-team-leaders');
                                if (teamLeadersTextarea && data.defaultTeamLeaders) {
                                    teamLeadersTextarea.value = data.defaultTeamLeaders.join('\n');
                                }
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.warn('Could not load existing team configuration:', error);
                        })
                        .getTeamLeadershipConfiguration();
                }
                
            } catch (error) {
                console.warn('Failed to load existing team configuration:', error);
            }
        }
        
        /**
         * Save settings
         */
        window.saveSettings = function() {
            try {
                const modal = document.getElementById('settings-modal');
                if (!modal) return;
                
                // Save spreadsheet configuration
                const spreadsheetInput = modal.querySelector('#spreadsheet-id-setting');
                if (spreadsheetInput && spreadsheetInput.value.trim()) {
                    const spreadsheetId = extractSpreadsheetId(spreadsheetInput.value.trim());
                    if (spreadsheetId) {
                        // Save to server
                        if (typeof google !== 'undefined' && google.script && google.script.run) {
                            google.script.run
                                .withSuccessHandler(function(result) {
                                    if (result && result.success) {
                                        console.log('Spreadsheet ID saved successfully');
                                    } else {
                                        console.warn('Failed to save spreadsheet ID:', result.message);
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    console.error('Error saving spreadsheet ID:', error);
                                })
                                .saveSpreadsheetId(spreadsheetId);
                        }
                    }
                }
                
                // Save theme setting
                const themeSelect = modal.querySelector('#theme-setting');
                if (themeSelect) {
                    localStorage.setItem('casesdash_theme', themeSelect.value);
                }
                
                // Save rows per page setting
                const rowsSelect = modal.querySelector('#rows-per-page-setting');
                if (rowsSelect) {
                    localStorage.setItem('casesdash_rows_per_page', rowsSelect.value);
                }
                
                // Save notification settings
                const notificationsCheckbox = modal.querySelector('#enable-notifications');
                const soundCheckbox = modal.querySelector('#enable-sound');
                
                if (notificationsCheckbox) {
                    localStorage.setItem('casesdash_notifications', notificationsCheckbox.checked);
                }
                
                if (soundCheckbox) {
                    localStorage.setItem('casesdash_sound', soundCheckbox.checked);
                }
                
                showSuccessToast('Settings saved successfully');
                modal.close();
                modal.remove();
                
            } catch (error) {
                console.error('Failed to save settings:', error);
                showErrorToast('Failed to save settings');
            }
        };
        
        /**
         * Test spreadsheet connection
         */
        window.testSpreadsheetConnection = function() {
            try {
                const spreadsheetInput = document.getElementById('spreadsheet-id-setting');
                const statusDiv = document.getElementById('spreadsheet-status');
                const testBtn = document.getElementById('test-connection-btn');
                
                if (!spreadsheetInput || !statusDiv || !testBtn) return;
                
                const spreadsheetId = extractSpreadsheetId(spreadsheetInput.value.trim());
                if (!spreadsheetId) {
                    showSpreadsheetStatus('Please enter a valid spreadsheet ID or URL', 'error');
                    return;
                }
                
                // Update input with extracted ID
                spreadsheetInput.value = spreadsheetId;
                
                // Show loading state
                testBtn.disabled = true;
                testBtn.innerHTML = '<span class="material-symbols-outlined">sync</span> Testing...';
                showSpreadsheetStatus('Testing connection to spreadsheet...', 'info');
                
                // Call server function to test connection
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(function(result) {
                            testBtn.disabled = false;
                            testBtn.innerHTML = '<span class="material-symbols-outlined">wifi_protected_setup</span> Test Connection';
                            
                            if (result && result.success) {
                                showSpreadsheetStatus('✅ Connection successful! Spreadsheet is accessible.', 'success');
                                
                                // Save the spreadsheet ID
                                if (typeof google.script.run.saveSpreadsheetId === 'function') {
                                    google.script.run.saveSpreadsheetId(spreadsheetId);
                                }
                            } else {
                                showSpreadsheetStatus(`❌ Connection failed: ${result.message || 'Unknown error'}`, 'error');
                            }
                        })
                        .withFailureHandler(function(error) {
                            testBtn.disabled = false;
                            testBtn.innerHTML = '<span class="material-symbols-outlined">wifi_protected_setup</span> Test Connection';
                            showSpreadsheetStatus(`❌ Connection failed: ${error.message || error}`, 'error');
                        })
                        .testSpreadsheetConnection(spreadsheetId);
                } else {
                    // Fallback for development
                    setTimeout(() => {
                        testBtn.disabled = false;
                        testBtn.innerHTML = '<span class="material-symbols-outlined">wifi_protected_setup</span> Test Connection';
                        showSpreadsheetStatus('⚠️ Development mode: Connection test simulated', 'warning');
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Error testing spreadsheet connection:', error);
                showSpreadsheetStatus(`❌ Error: ${error.message}`, 'error');
            }
        };
        
        /**
         * Validate spreadsheet sheets
         */
        window.validateSpreadsheetSheets = function() {
            try {
                const spreadsheetInput = document.getElementById('spreadsheet-id-setting');
                const validationDiv = document.getElementById('sheet-validation-results');
                const validationList = document.getElementById('sheet-validation-list');
                const validateBtn = document.getElementById('validate-sheets-btn');
                
                if (!spreadsheetInput || !validationDiv || !validationList || !validateBtn) return;
                
                const spreadsheetId = extractSpreadsheetId(spreadsheetInput.value.trim());
                if (!spreadsheetId) {
                    showSpreadsheetStatus('Please enter a valid spreadsheet ID or URL first', 'error');
                    return;
                }
                
                // Show loading state
                validateBtn.disabled = true;
                validateBtn.innerHTML = '<span class="material-symbols-outlined">sync</span> Validating...';
                
                const requiredSheets = ['OT Email', '3PO Email', 'OT Chat', '3PO Chat', 'OT Phone', '3PO Phone'];
                
                // Call server function to validate sheets
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(function(result) {
                            validateBtn.disabled = false;
                            validateBtn.innerHTML = '<span class="material-symbols-outlined">fact_check</span> Validate Sheets';
                            
                            if (result && result.success) {
                                displaySheetValidationResults(result.existingSheets || [], result.missingSheets || [], requiredSheets);
                            } else {
                                showSpreadsheetStatus(`❌ Validation failed: ${result.message || 'Unknown error'}`, 'error');
                            }
                        })
                        .withFailureHandler(function(error) {
                            validateBtn.disabled = false;
                            validateBtn.innerHTML = '<span class="material-symbols-outlined">fact_check</span> Validate Sheets';
                            showSpreadsheetStatus(`❌ Validation failed: ${error.message || error}`, 'error');
                        })
                        .validateSpreadsheetSheets(spreadsheetId);
                } else {
                    // Fallback for development
                    setTimeout(() => {
                        validateBtn.disabled = false;
                        validateBtn.innerHTML = '<span class="material-symbols-outlined">fact_check</span> Validate Sheets';
                        
                        // Simulate validation results
                        const simulatedExisting = ['OT Email', '3PO Email', 'OT Chat'];
                        const simulatedMissing = ['3PO Chat', 'OT Phone', '3PO Phone'];
                        displaySheetValidationResults(simulatedExisting, simulatedMissing, requiredSheets);
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Error validating spreadsheet sheets:', error);
                showSpreadsheetStatus(`❌ Error: ${error.message}`, 'error');
            }
        };
        
        /**
         * Extract spreadsheet ID from URL or return as-is if already an ID
         */
        function extractSpreadsheetId(input) {
            if (!input) return '';
            
            // Extract ID from Google Sheets URL
            const urlMatch = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return urlMatch ? urlMatch[1] : input;
        }
        
        /**
         * Show spreadsheet status message
         */
        function showSpreadsheetStatus(message, type) {
            const statusDiv = document.getElementById('spreadsheet-status');
            if (!statusDiv) return;
            
            const typeColors = {
                success: 'var(--md-success-50)',
                error: 'var(--md-error-50)',
                warning: 'var(--md-warning-50)',
                info: 'var(--md-primary-50)'
            };
            
            statusDiv.innerHTML = `
                <div style="padding: 12px; border-radius: 4px; background: var(--current-surface-container-high); border-left: 4px solid ${typeColors[type] || typeColors.info}; color: var(--current-on-surface);">
                    ${message}
                </div>
            `;
            statusDiv.style.display = 'block';
        }
        
        /**
         * Display sheet validation results
         */
        function displaySheetValidationResults(existingSheets, missingSheets, requiredSheets) {
            const validationDiv = document.getElementById('sheet-validation-results');
            const validationList = document.getElementById('sheet-validation-list');
            
            if (!validationDiv || !validationList) return;
            
            validationList.innerHTML = '';
            
            // Show results for all required sheets
            requiredSheets.forEach(sheetName => {
                const exists = existingSheets.includes(sheetName);
                const item = document.createElement('div');
                
                item.style.cssText = `
                    padding: 8px 12px; 
                    border-radius: 4px; 
                    font-size: 14px; 
                    display: flex; 
                    align-items: center; 
                    gap: 8px;
                    ${exists 
                        ? 'background: var(--md-success-90); color: var(--md-success-10);' 
                        : 'background: var(--md-error-90); color: var(--md-error-10);'
                    }
                `;
                
                item.innerHTML = `
                    <span class="material-symbols-outlined" style="font-size: 18px;">
                        ${exists ? 'check_circle' : 'error'}
                    </span>
                    <span>${sheetName}</span>
                `;
                
                validationList.appendChild(item);
            });
            
            validationDiv.style.display = 'block';
            
            // Show summary status
            const foundCount = existingSheets.filter(sheet => requiredSheets.includes(sheet)).length;
            const totalRequired = requiredSheets.length;
            
            if (foundCount === totalRequired) {
                showSpreadsheetStatus(`✅ All ${totalRequired} required sheets found! Spreadsheet is ready to use.`, 'success');
            } else {
                showSpreadsheetStatus(`⚠️ Found ${foundCount}/${totalRequired} required sheets. Missing sheets need to be created.`, 'warning');
            }
        }
        
        // Emergency Live Mode function
        window.openLiveMode = function() {
            try {
                console.log('🚀 Opening Live Mode...');
                
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.split('?')[0];
                const liveModeUrl = `${baseUrl}?page=live-mode`;
                
                const windowFeatures = [
                    'width=1200', 'height=800', 'left=100', 'top=100',
                    'resizable=yes', 'scrollbars=yes', 'status=yes',
                    'toolbar=no', 'menubar=no', 'location=no'
                ].join(',');
                
                const liveModeWindow = window.open(liveModeUrl, 'CasesDashLiveMode', windowFeatures);
                
                if (!liveModeWindow) {
                    alert('Failed to open Live Mode window. Please check popup blocker settings.');
                }
            } catch (error) {
                console.error('Failed to open Live Mode:', error);
                alert('Failed to open Live Mode window: ' + error.message);
            }
        };
        
        // Emergency sentiment management functions
        window.showSentimentModal = window.showSentimentModal || function() {
            console.log('💝 Opening Sentiment Modal');
            const modal = document.getElementById('sentiment-modal');
            if (modal && modal.showModal) {
                modal.showModal();
                // Initialize slider after modal is shown
                setTimeout(initializeSentimentSlider, 100);
            }
        };
        
        window.saveSentimentScore = window.saveSentimentScore || function() {
            console.log('💾 Save sentiment clicked (emergency mode)');
            alert('Save functionality requires full app initialization.');
        };
        
        window.closeSentimentModal = window.closeSentimentModal || function() {
            const modal = document.getElementById('sentiment-modal');
            if (modal && modal.close) {
                modal.close();
            }
        };
        
        window.adjustScore = window.adjustScore || function(delta) {
            const slider = document.getElementById('sentiment-score-slider');
            const display = document.getElementById('sentiment-score-display');
            
            if (slider && display) {
                let currentValue = parseFloat(slider.value);
                let newValue = Math.max(1, Math.min(10, currentValue + delta));
                slider.value = newValue;
                display.textContent = newValue.toFixed(1);
            }
        };
        
        /**
         * Save team leadership configuration (Spec 4.6.4)
         */
        window.saveTeamLeadershipConfig = function() {
            try {
                const modal = document.getElementById('settings-modal');
                if (!modal) return;
                
                const chatWebhookUrl = modal.querySelector('#chat-webhook-url')?.value?.trim();
                const defaultLeadersText = modal.querySelector('#default-team-leaders')?.value?.trim();
                const saveBtn = modal.querySelector('#save-team-config-btn');
                
                // Validate inputs
                if (!chatWebhookUrl && !defaultLeadersText) {
                    showErrorToast('Please provide at least a Chat URL or default team leaders');
                    return;
                }
                
                // Validate Chat URL format
                if (chatWebhookUrl && !chatWebhookUrl.includes('chat.googleapis.com')) {
                    showErrorToast('Invalid Google Chat URL format');
                    return;
                }
                
                // Parse default team leaders
                const defaultLeaders = defaultLeadersText 
                    ? defaultLeadersText.split('\n')
                        .map(email => email.trim())
                        .filter(email => email && email.includes('@'))
                    : [];
                
                if (defaultLeadersText && defaultLeaders.length === 0) {
                    showErrorToast('Please provide valid email addresses for team leaders');
                    return;
                }
                
                // Show loading state
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="material-symbols-outlined">sync</span> Saving...';
                }
                
                // Prepare configuration object
                const teamConfig = {
                    chatWebhookUrl: chatWebhookUrl,
                    defaultTeamLeaders: defaultLeaders,
                    updatedAt: new Date().toISOString(),
                    updatedBy: getCurrentUser() || 'unknown'
                };
                
                // Save to server
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(function(result) {
                            if (saveBtn) {
                                saveBtn.disabled = false;
                                saveBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Save Team Configuration';
                            }
                            
                            if (result && result.success) {
                                showSuccessToast('Team leadership configuration saved successfully');
                            } else {
                                showErrorToast('Failed to save team configuration: ' + (result.message || 'Unknown error'));
                            }
                        })
                        .withFailureHandler(function(error) {
                            if (saveBtn) {
                                saveBtn.disabled = false;
                                saveBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Save Team Configuration';
                            }
                            showErrorToast('Error saving team configuration: ' + error.message);
                        })
                        .saveTeamLeadershipConfiguration(teamConfig);
                } else {
                    // Fallback for development
                    setTimeout(() => {
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Save Team Configuration';
                        }
                        showSuccessToast('Team configuration saved (development mode)');
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error saving team leadership configuration:', error);
                showErrorToast('Error saving team configuration: ' + error.message);
            }
        };
        
        /**
         * Get current user identifier
         */
        function getCurrentUser() {
            try {
                // Try various methods to get current user
                if (window.CasesDashApp && window.CasesDashApp.getCurrentUser) {
                    return window.CasesDashApp.getCurrentUser();
                }
                
                // Fallback methods
                return sessionStorage.getItem('casesdash_current_user') || 
                       localStorage.getItem('casesdash_current_user') || 
                       'unknown@google.com';
            } catch (error) {
                return 'unknown@google.com';
            }
        }
        
        /**
         * Global reactivate case function (Spec 4.2.3)
         */
        window.reactivateCase = function(caseId, sheetType) {
            if (window.CasesDashCaseManager && typeof window.CasesDashCaseManager.reactivateCase === 'function') {
                window.CasesDashCaseManager.reactivateCase(caseId, sheetType);
            } else {
                console.error('❌ CaseManager not available for case reactivation');
                alert('Case Manager not available. Please refresh the page and try again.');
            }
        };
        
        /**
         * Initialize specification-based case form (spec 4.3)
         */
        window.initializeSpecificationBasedCaseForm = function() {
            console.log('🚀 Initializing specification-based case form (spec 4.3)');
            
            const caseForm = document.getElementById('case-form');
            if (!caseForm) {
                console.error('❌ Case form element not found');
                return;
            }
            
            // Show loading state first
            caseForm.innerHTML = `
                <div class="loading-skeleton" style="height: 60px; margin-bottom: 16px;"></div>
                <div class="loading-skeleton" style="height: 40px; margin-bottom: 16px;"></div>
                <div class="loading-skeleton" style="height: 40px; margin-bottom: 16px;"></div>
                <div style="text-align: center; padding: 20px; color: var(--current-on-surface-variant);">
                    <span class="material-symbols-outlined">construction</span>
                    Loading specification-based form...
                </div>
            `;
            
            // Try to get sheet types from server, with fallback
            setTimeout(() => {
                tryLoadServerData().then(serverData => {
                    renderSpecificationBasedForm(serverData);
                }).catch(error => {
                    console.warn('⚠️ Server data unavailable, using specification fallback:', error);
                    renderSpecificationBasedForm(null);
                });
            }, 500);
        };

        /**
         * Initialize enhanced case form with server error handling (legacy)
         */
        window.initializeEnhancedCaseForm = function() {
            console.log('🚀 Initializing enhanced case form (legacy)');
            // Redirect to specification-based form
            initializeSpecificationBasedCaseForm();
        };
        
        /**
         * Try to load data from server
         */
        function tryLoadServerData() {
            return new Promise((resolve, reject) => {
                try {
                    if (typeof google !== 'undefined' && google.script && google.script.run) {
                        const timeout = setTimeout(() => {
                            reject(new Error('Server request timeout'));
                        }, 5000);
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                clearTimeout(timeout);
                                console.log('✅ Server data loaded:', result);
                                resolve(result);
                            })
                            .withFailureHandler(function(error) {
                                clearTimeout(timeout);
                                console.error('❌ Server request failed:', error);
                                reject(error);
                            })
                            .getSheetTypes();
                    } else {
                        reject(new Error('Google Apps Script not available'));
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        /**
         * Render specification-based form (spec 4.3)
         */
        function renderSpecificationBasedForm(serverData) {
            const caseForm = document.getElementById('case-form');
            if (!caseForm) return;
            
            // Determine data source
            const isServerData = serverData && serverData.success;
            const sheetTypes = isServerData ? serverData.sheetTypes : [
                'OT Email', '3PO Email', 'OT Chat', '3PO Chat', 'OT Phone', '3PO Phone'
            ];
            
            // Generate case ID in specification format (X-1234567890123)
            const generatedCaseId = generateSpecificationCaseId();
            
            caseForm.innerHTML = `
                ${!isServerData ? `
                <div class="validation-messages" style="margin-bottom: 16px;">
                    <span class="material-symbols-outlined">warning</span>
                    Working in offline mode. Using specification-based form (4.3).
                </div>
                ` : ''}
                
                <div class="form-grid">
                    <!-- Case ID (spec format: X-1234567890123) -->
                    <div class="form-field">
                        <label for="case-id-input">Case ID *</label>
                        <input type="text" id="case-id-input" value="${generatedCaseId}" required
                               pattern="\\d-\\d{13}" title="Format: X-1234567890123">
                        <div class="field-hint">Format: X-1234567890123 (spec 4.3.2)</div>
                    </div>
                    
                    <!-- Case Open Date (spec: required, default today) -->
                    <div class="form-field">
                        <label for="case-open-date">Case Open Date *</label>
                        <input type="date" id="case-open-date" value="${getCurrentDate()}" required>
                        <div class="field-hint">Required field (spec 4.3.2)</div>
                    </div>
                    
                    <!-- Case Open Time (spec: required, default now) -->
                    <div class="form-field">
                        <label for="case-open-time">Case Open Time *</label>
                        <input type="time" id="case-open-time" value="${getCurrentTime()}" required>
                        <div class="field-hint">Required field (spec 4.3.2)</div>
                    </div>
                    
                    <!-- Sheet Type (spec: dynamic form generation) -->
                    <div class="form-field">
                        <label for="sheet-type-select">Sheet Type *</label>
                        <select id="sheet-type-select" required onchange="handleSheetTypeChange(this.value)">
                            <option value="">Select Sheet Type</option>
                            ${sheetTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                        </select>
                        <div class="field-hint">Triggers dynamic form generation (spec 4.3.2)</div>
                    </div>
                    
                    <!-- Incoming Segment (spec: required with predefined options) -->
                    <div class="form-field">
                        <label for="incoming-segment-select">Incoming Segment *</label>
                        <select id="incoming-segment-select" required>
                            <option value="">Select Segment</option>
                            <option value="Gold" selected>Gold</option>
                            <option value="Platinum">Platinum</option>
                            <option value="Titanium">Titanium</option>
                            <option value="Silver">Silver</option>
                            <option value="Bronze - Low">Bronze - Low</option>
                            <option value="Bronze - High">Bronze - High</option>
                        </select>
                        <div class="field-hint">Required field with spec options (spec 4.3.2)</div>
                    </div>
                    
                    <!-- Product Category (spec: required with predefined options) -->
                    <div class="form-field">
                        <label for="product-category-select">Product Category *</label>
                        <select id="product-category-select" required>
                            <option value="">Select Category</option>
                            <option value="Search" selected>Search</option>
                            <option value="Display">Display</option>
                            <option value="Video">Video</option>
                            <option value="Commerce">Commerce</option>
                            <option value="Apps">Apps</option>
                            <option value="M&A">M&A</option>
                            <option value="Policy">Policy</option>
                            <option value="Billing">Billing</option>
                            <option value="Other">Other</option>
                        </select>
                        <div class="field-hint">Required field with spec options (spec 4.3.2)</div>
                    </div>
                    
                    <!-- 1st Assignee (spec: required, default current user) -->
                    <div class="form-field">
                        <label for="first-assignee-input">1st Assignee *</label>
                        <input type="text" id="first-assignee-input" value="currentUser" required>
                        <div class="field-hint">Required field, defaults to current user (spec 4.3.2)</div>
                    </div>
                    
                    <!-- Case Status (spec: required with predefined options) -->
                    <div class="form-field">
                        <label for="case-status-select">Case Status *</label>
                        <select id="case-status-select" required>
                            <option value="Assigned" selected>Assigned</option>
                            <option value="Solution Offered">Solution Offered</option>
                            <option value="Finished">Finished</option>
                        </select>
                        <div class="field-hint">Required field with spec options (spec 4.3.2)</div>
                    </div>
                    
                    <!-- 3PO specific fields (spec: shown only for 3PO sheets) -->
                    <div id="3po-fields" style="display: none; grid-column: 1 / -1;">
                        <h4 style="margin: 20px 0 10px 0; color: var(--md-primary-50);">3PO Specific Fields</h4>
                        
                        <div class="form-grid">
                            <!-- Issue Category (spec: required for 3PO) -->
                            <div class="form-field">
                                <label for="issue-category-select">Issue Category *</label>
                                <select id="issue-category-select">
                                    <option value="">Select Issue Category</option>
                                    <option value="CBT invo-invo">CBT invo-invo</option>
                                    <option value="CBT invo-auto">CBT invo-auto</option>
                                    <option value="CBT (self to self)">CBT (self to self)</option>
                                    <option value="LC creation">LC creation</option>
                                    <option value="PP link">PP link</option>
                                    <option value="PP update">PP update</option>
                                    <option value="IDT/ Bmod">IDT/ Bmod</option>
                                    <option value="LCS billing policy">LCS billing policy</option>
                                    <option value="self serve issue">self serve issue</option>
                                    <option value="Unidentified Charge">Unidentified Charge</option>
                                    <option value="CBT Flow">CBT Flow</option>
                                    <option value="GQ">GQ</option>
                                    <option value="OOS">OOS</option>
                                    <option value="Bulk CBT">Bulk CBT</option>
                                    <option value="CBT ext request">CBT ext request</option>
                                    <option value="MMS billing policy">MMS billing policy</option>
                                    <option value="Promotion code">Promotion code</option>
                                    <option value="Refund">Refund</option>
                                    <option value="Review">Review</option>
                                    <option value="TM form">TM form</option>
                                    <option value="Trademarks issue">Trademarks issue</option>
                                    <option value="Under Review">Under Review</option>
                                    <option value="Certificate">Certificate</option>
                                    <option value="Suspend">Suspend</option>
                                    <option value="AIV">AIV</option>
                                    <option value="Complaint">Complaint</option>
                                </select>
                                <div class="field-hint">Required for 3PO sheets (spec 4.3.2)</div>
                            </div>
                        </div>
                        
                        <!-- Details (spec: optional for 3PO) -->
                        <div class="form-field" style="grid-column: 1 / -1;">
                            <label for="details-textarea">Details</label>
                            <textarea id="details-textarea" rows="3" maxlength="1000"
                                    placeholder="Additional details for 3PO case..."></textarea>
                            <div class="field-hint">Optional field for 3PO sheets (spec 4.3.2)</div>
                        </div>
                    </div>
                    
                    <!-- Common checkbox fields (spec 4.3.2) -->
                    <div class="form-field" style="grid-column: 1 / -1;">
                        <h4 style="margin: 20px 0 10px 0; color: var(--md-primary-50);">Additional Options</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="triage">
                                    <span class="checkmark"></span>
                                    Triage
                                </label>
                            </div>
                            <div class="form-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="prefer-either">
                                    <span class="checkmark"></span>
                                    Prefer Either
                                </label>
                            </div>
                            <div class="form-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="is-30">
                                    <span class="checkmark"></span>
                                    Is 3.0
                                </label>
                            </div>
                            <div class="form-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="mcc">
                                    <span class="checkmark"></span>
                                    MCC
                                </label>
                            </div>
                            <div class="form-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="change-to-child">
                                    <span class="checkmark"></span>
                                    Change to Child
                                </label>
                            </div>
                            <div class="form-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="bug">
                                    <span class="checkmark"></span>
                                    Bug
                                </label>
                            </div>
                            <div class="form-field">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="need-info">
                                    <span class="checkmark"></span>
                                    Need Info
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions" style="margin-top: 24px;">
                    <button type="button" class="btn btn-primary" onclick="submitSpecificationBasedCase()" id="submit-case-btn">
                        <span class="material-symbols-outlined">save</span>
                        Create Case (Spec 4.3)
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetSpecificationCaseForm()">
                        <span class="material-symbols-outlined">refresh</span>
                        Reset Form
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="cancelCaseForm()">
                        <span class="material-symbols-outlined">close</span>
                        Cancel
                    </button>
                </div>
            `;
            
            // Add form validation
            setupSpecificationFormValidation();
            
            console.log('✅ Specification-based case form rendered successfully');
            showSuccessToast('Specification-based case creation form loaded (spec 4.3)');
        }

        /**
         * Generate Case ID in specification format (X-1234567890123)
         */
        function generateSpecificationCaseId() {
            const randomDigit = Math.floor(Math.random() * 10);
            const timestamp = Date.now().toString();
            const randomSuffix = Math.random().toString().slice(2, 5);
            const caseNumber = (timestamp + randomSuffix).slice(0, 13);
            return `${randomDigit}-${caseNumber}`;
        }

        /**
         * Get current date in YYYY-MM-DD format
         */
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        /**
         * Get current time in HH:MM format
         */
        function getCurrentTime() {
            return new Date().toTimeString().split(' ')[0].substring(0, 5);
        }

        /**
         * Handle sheet type change (spec 4.3.2: dynamic form generation)
         */
        window.handleSheetTypeChange = function(sheetType) {
            console.log('🎯 Sheet type changed:', sheetType);
            
            const threePOFields = document.getElementById('3po-fields');
            const issueCategorySelect = document.getElementById('issue-category-select');
            
            if (threePOFields && issueCategorySelect) {
                if (sheetType.includes('3PO')) {
                    // Show 3PO specific fields
                    threePOFields.style.display = 'block';
                    issueCategorySelect.required = true;
                    console.log('✅ 3PO fields shown');
                    showSuccessToast('3PO specific fields are now available');
                } else {
                    // Hide 3PO specific fields
                    threePOFields.style.display = 'none';
                    issueCategorySelect.required = false;
                    issueCategorySelect.value = '';
                    console.log('✅ 3PO fields hidden');
                }
            }
        };

        /**
         * Render enhanced form with server data or fallback (legacy)
         */
        function renderEnhancedForm(serverData) {
            console.log('🔄 Redirecting to specification-based form');
            renderSpecificationBasedForm(serverData);
        }
        
        /**
         * Setup specification-based form validation
         */
        function setupSpecificationFormValidation() {
            const requiredFields = [
                'case-id-input', 'case-open-date', 'case-open-time', 'sheet-type-select',
                'incoming-segment-select', 'product-category-select', 'first-assignee-input', 'case-status-select'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        validateSpecificationField(this);
                    });
                    
                    field.addEventListener('input', function() {
                        clearFieldError(this);
                    });
                }
            });
            
            // Special validation for Case ID format
            const caseIdField = document.getElementById('case-id-input');
            if (caseIdField) {
                caseIdField.addEventListener('input', function() {
                    validateCaseIdFormat(this);
                });
            }
        }

        /**
         * Setup form validation (legacy)
         */
        function setupFormValidation() {
            console.log('🔄 Redirecting to specification form validation');
            setupSpecificationFormValidation();
        }
        
        /**
         * Validate specification field
         */
        function validateSpecificationField(field) {
            const value = field.value.trim();
            let isValid = value.length > 0;
            
            // Special validation for Case ID format
            if (field.id === 'case-id-input') {
                const caseIdPattern = /^\d-\d{13}$/;
                isValid = caseIdPattern.test(value);
            }
            
            if (!isValid) {
                field.style.borderColor = 'var(--md-error-50)';
                field.style.backgroundColor = 'var(--md-error-95)';
            } else {
                clearFieldError(field);
            }
            
            return isValid;
        }

        /**
         * Validate Case ID format (spec: X-1234567890123)
         */
        function validateCaseIdFormat(field) {
            const value = field.value.trim();
            const caseIdPattern = /^\d-\d{13}$/;
            
            if (value && !caseIdPattern.test(value)) {
                field.style.borderColor = 'var(--md-error-50)';
                field.title = 'Invalid format. Expected: X-1234567890123';
            } else {
                clearFieldError(field);
                field.title = 'Format: X-1234567890123';
            }
        }

        /**
         * Validate individual field (legacy)
         */
        function validateField(field) {
            return validateSpecificationField(field);
        }
        
        /**
         * Clear field error styling
         */
        function clearFieldError(field) {
            field.style.borderColor = '';
            field.style.backgroundColor = '';
        }
        
        /**
         * Initialize case form fallback when main system is not available
         */
        window.initializeCaseFormFallback = function() {
            console.log('🔧 Initializing case form fallback');
            initializeEnhancedCaseForm(); // Use enhanced form instead
        };
        
        /**
         * Submit specification-based case form
         */
        window.submitSpecificationBasedCase = function() {
            console.log('💾 Submitting specification-based case (spec 4.3)');
            
            const submitBtn = document.getElementById('submit-case-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <span class="material-symbols-outlined">hourglass_empty</span>
                    Creating...
                `;
            }
            
            // Validate all required fields according to specification
            const requiredFields = [
                'case-id-input', 'case-open-date', 'case-open-time', 'sheet-type-select',
                'incoming-segment-select', 'product-category-select', 'first-assignee-input', 'case-status-select'
            ];
            
            // Add 3PO specific required fields if applicable
            const sheetType = document.getElementById('sheet-type-select')?.value;
            if (sheetType && sheetType.includes('3PO')) {
                requiredFields.push('issue-category-select');
            }
            
            let isValid = true;
            const errors = [];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !validateSpecificationField(field)) {
                    isValid = false;
                    const label = field.closest('.form-field')?.querySelector('label')?.textContent?.replace('*', '') || fieldId;
                    errors.push(label);
                }
            });
            
            if (!isValid) {
                showErrorToast(`Please fill in required fields: ${errors.join(', ')}`);
                resetSubmitButton();
                return;
            }
            
            // Collect form data according to specification
            const caseData = {
                // Common fields (spec 4.3.2)
                caseId: document.getElementById('case-id-input')?.value?.trim(),
                caseOpenDate: document.getElementById('case-open-date')?.value,
                caseOpenTime: document.getElementById('case-open-time')?.value,
                incomingSegment: document.getElementById('incoming-segment-select')?.value,
                productCategory: document.getElementById('product-category-select')?.value,
                triage: document.getElementById('triage')?.checked || false,
                preferEither: document.getElementById('prefer-either')?.checked || false,
                is30: document.getElementById('is-30')?.checked || false,
                firstAssignee: document.getElementById('first-assignee-input')?.value?.trim(),
                mcc: document.getElementById('mcc')?.checked || false,
                changeToChild: document.getElementById('change-to-child')?.checked || false,
                caseStatus: document.getElementById('case-status-select')?.value,
                bug: document.getElementById('bug')?.checked || false,
                needInfo: document.getElementById('need-info')?.checked || false,
                
                // Sheet type and channel
                sheetType: sheetType,
                channel: getChannelFromSheetType(sheetType),
                
                // Timestamps
                createdDate: new Date().toISOString(),
                createdBy: 'current-user' // Will be replaced by server with actual user
            };
            
            // Add 3PO specific fields if applicable
            if (sheetType && sheetType.includes('3PO')) {
                caseData.issueCategory = document.getElementById('issue-category-select')?.value;
                caseData.details = document.getElementById('details-textarea')?.value?.trim();
            }
            
            // Add OT Email specific fields if applicable
            if (sheetType === 'OT Email') {
                caseData.amInitiated = document.getElementById('am-initiated')?.checked || false;
            }
            
            console.log('📋 Specification-based case data collected:', caseData);
            
            // Try to submit to server first, then fallback to local storage
            trySubmitToServer(caseData).then(result => {
                handleSuccessfulSubmission(result, caseData);
            }).catch(error => {
                console.warn('⚠️ Server submission failed, using local storage:', error);
                handleLocalSubmission(caseData);
            });
        };

        /**
         * Submit enhanced case form (legacy)
         */
        window.submitEnhancedCase = function() {
            console.log('💾 Submitting enhanced case (legacy redirect)');
            submitSpecificationBasedCase();
        };
        
        /**
         * Try to submit case to server
         */
        function trySubmitToServer(caseData) {
            return new Promise((resolve, reject) => {
                try {
                    if (typeof google !== 'undefined' && google.script && google.script.run) {
                        const timeout = setTimeout(() => {
                            reject(new Error('Server submission timeout'));
                        }, 10000);
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                clearTimeout(timeout);
                                console.log('✅ Server submission successful:', result);
                                resolve(result);
                            })
                            .withFailureHandler(function(error) {
                                clearTimeout(timeout);
                                console.error('❌ Server submission failed:', error);
                                reject(error);
                            })
                            .createCase(caseData);
                    } else {
                        reject(new Error('Google Apps Script not available'));
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        /**
         * Handle successful server submission
         */
        function handleSuccessfulSubmission(result, caseData) {
            console.log('✅ Case created successfully on server');
            
            resetSubmitButton();
            showSuccessToast(`Case ${caseData.caseId} created successfully!`);
            
            // Clear form
            resetCaseForm();
            
            // Return to dashboard after short delay
            setTimeout(() => {
                showView('dashboard');
            }, 2000);
        }
        
        /**
         * Handle local storage submission (fallback)
         */
        function handleLocalSubmission(caseData) {
            console.log('💾 Saving case to local storage');
            
            try {
                // Get existing cases from local storage
                const existingCases = JSON.parse(localStorage.getItem('casesdash_local_cases') || '[]');
                
                // Add new case
                existingCases.push(caseData);
                
                // Save back to local storage
                localStorage.setItem('casesdash_local_cases', JSON.stringify(existingCases));
                
                resetSubmitButton();
                showWarningToast(`Case ${caseData.caseId} saved locally. Will sync when server is available.`);
                
                // Clear form
                resetCaseForm();
                
                // Return to dashboard after short delay
                setTimeout(() => {
                    showView('dashboard');
                }, 2000);
                
            } catch (error) {
                console.error('❌ Failed to save case locally:', error);
                resetSubmitButton();
                showErrorToast('Failed to save case. Please try again.');
            }
        }
        
        /**
         * Reset submit button to normal state
         */
        function resetSubmitButton() {
            const submitBtn = document.getElementById('submit-case-btn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                    <span class="material-symbols-outlined">save</span>
                    Create Case
                `;
            }
        }
        
        /**
         * Reset case form to initial state
         */
        window.resetCaseForm = function() {
            console.log('🔄 Resetting case form');
            
            const form = document.getElementById('case-form');
            if (!form) return;
            
            // Clear all form fields
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'text' || input.type === 'textarea') {
                    input.value = '';
                } else if (input.type === 'select-one') {
                    input.selectedIndex = 0;
                }
                clearFieldError(input);
            });
            
            // Regenerate case ID
            const caseIdInput = document.getElementById('case-id-input');
            if (caseIdInput) {
                const newCaseId = 'CASE-' + new Date().getFullYear() + '-' +
                                String(Date.now()).slice(-6);
                caseIdInput.value = newCaseId;
            }
            
            showSuccessToast('Form reset successfully');
        };
        
        /**
         * Submit fallback case form (legacy function)
         */
        window.submitFallbackCase = function() {
            console.log('💾 Submitting fallback case (legacy)');
            // Redirect to enhanced submission
            submitEnhancedCase();
        };
        
        /**
         * Initialize Advanced Search functionality
         */
        window.initializeAdvancedSearch = function() {
            console.log('🔍 Initializing Advanced Search');
            
            const sheetTypeSelect = document.getElementById('search-sheet-type');
            if (sheetTypeSelect && sheetTypeSelect.children.length <= 1) {
                // Add sheet type options
                const sheetTypes = [
                    'OT Email', '3PO Email', 'OT Chat',
                    '3PO Chat', 'OT Phone', '3PO Phone'
                ];
                
                sheetTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    sheetTypeSelect.appendChild(option);
                });
                
                console.log('✅ Sheet type options populated');
            }
        };
        
        /**
         * Initialize Reports functionality
         */
        window.initializeReports = function() {
            console.log('📊 Initializing Reports');
            
            // Initialize period type select
            const periodTypeSelect = document.getElementById('reports-period-type');
            if (periodTypeSelect && periodTypeSelect.children.length < 4) {
                periodTypeSelect.innerHTML = `
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                    <option value="custom">Custom Range</option>
                `;
                console.log('✅ Period type options populated');
            }
            
            // Initialize year select
            const yearSelect = document.getElementById('reports-year');
            if (yearSelect && yearSelect.children.length === 0) {
                const currentYear = new Date().getFullYear();
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                }
                console.log('✅ Year options populated');
            }
        };
        
        /**
         * Initialize sentiment score slider functionality
         */
        window.initializeSentimentSlider = function() {
            console.log('💝 Initializing Sentiment Slider');
            
            const slider = document.getElementById('sentiment-score-slider');
            const display = document.getElementById('sentiment-score-display');
            
            if (slider && display) {
                // Add real-time update functionality
                slider.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    display.textContent = value.toFixed(1);
                });
                
                // Initialize with current value
                display.textContent = parseFloat(slider.value).toFixed(1);
                
                console.log('✅ Sentiment slider initialized');
            }
        };
        
        /**
         * Toggle period fields based on selection
         */
        window.togglePeriodFields = function(periodType) {
            const monthField = document.getElementById('reports-month-field');
            const quarterField = document.getElementById('reports-quarter-field');
            const customFromField = document.getElementById('reports-custom-from-field');
            const customToField = document.getElementById('reports-custom-to-field');
            
            // Hide all fields first
            [monthField, quarterField, customFromField, customToField].forEach(field => {
                if (field) field.style.display = 'none';
            });
            
            // Show relevant fields
            switch (periodType) {
                case 'daily':
                case 'weekly':
                case 'monthly':
                    if (monthField) monthField.style.display = 'block';
                    break;
                case 'quarterly':
                    if (quarterField) quarterField.style.display = 'block';
                    break;
                case 'custom':
                    if (customFromField) customFromField.style.display = 'block';
                    if (customToField) customToField.style.display = 'block';
                    break;
            }
        };
        
        /**
         * Apply period filter
         */
        window.applyPeriodFilter = function() {
            console.log('🔍 Applying period filter');
            alert('Period filter applied (demo mode)');
        };
        
        /**
         * Get channel type from sheet type
         */
        function getChannelFromSheetType(sheetType) {
            if (sheetType.includes('Email')) return 'Email';
            if (sheetType.includes('Chat')) return 'Chat';
            if (sheetType.includes('Phone')) return 'Phone';
            return 'Unknown';
        }

        /**
         * Reset specification case form
         */
        window.resetSpecificationCaseForm = function() {
            console.log('🔄 Resetting specification case form');
            
            const form = document.getElementById('case-form');
            if (!form) return;
            
            // Clear all form fields
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'text' || input.type === 'date' || input.type === 'time' || input.tagName === 'TEXTAREA') {
                    if (input.id === 'case-id-input') {
                        input.value = generateSpecificationCaseId();
                    } else if (input.id === 'case-open-date') {
                        input.value = getCurrentDate();
                    } else if (input.id === 'case-open-time') {
                        input.value = getCurrentTime();
                    } else if (input.id === 'first-assignee-input') {
                        input.value = 'currentUser';
                    } else {
                        input.value = '';
                    }
                } else if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.tagName === 'SELECT') {
                    // Reset to default values
                    if (input.id === 'incoming-segment-select') {
                        input.value = 'Gold';
                    } else if (input.id === 'product-category-select') {
                        input.value = 'Search';
                    } else if (input.id === 'case-status-select') {
                        input.value = 'Assigned';
                    } else {
                        input.selectedIndex = 0;
                    }
                }
                clearFieldError(input);
            });
            
            // Hide 3PO fields
            const threePOFields = document.getElementById('3po-fields');
            if (threePOFields) {
                threePOFields.style.display = 'none';
            }
            
            showSuccessToast('Specification form reset successfully');
        };

        /**
         * Initialize theme toggle functionality
         */
        window.initializeThemeToggle = function() {
            console.log('🎨 Initializing Theme Toggle');
            
            // Let ThemeManager handle everything
            if (window.CasesDashThemeManager && typeof window.CasesDashThemeManager.initialize === 'function') {
                console.log('✅ Theme toggle delegated to ThemeManager');
                return;
            }
            
            console.log('⚠️ ThemeManager not available, using fallback');
        };
        
        // Emergency functions for other features
        window.refreshRecentActivity = window.refreshRecentActivity || function() {
            console.log('🔄 Refresh recent activity (emergency mode)');
        };
        
        window.refreshCaseList = window.refreshCaseList || function() {
            console.log('🔄 Refresh case list (emergency mode)');
        };
        
        window.submitCaseForm = window.submitCaseForm || function() {
            console.log('💾 Submit case form (emergency mode)');
            alert('Form submission requires full app initialization.');
        };
        
        window.cancelCaseForm = window.cancelCaseForm || function() {
            showView('dashboard');
        };
        
        window.performAdvancedSearch = window.performAdvancedSearch || function() {
            console.log('🔍 Perform advanced search (emergency mode)');
            alert('Search functionality requires full app initialization.');
        };
        
        window.editCase = window.editCase || function() {
            console.log('✏️ Edit case (emergency mode)');
            alert('Edit functionality requires full app initialization.');
        };
        
        // ===== Event Listeners =====
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCasesDash);
        } else {
            initializeCasesDash();
        }
        
        // Emergency fallback - hide spinner after 2 seconds
        setTimeout(hideLoadingSpinner, 2000);
        
        // Handle window resize
        window.addEventListener('resize', function() {
            const body = document.body;
            if (window.innerWidth <= 768) {
                body.classList.add('sidebar-collapsed');
            } else if (window.innerWidth > 1024) {
                body.classList.remove('sidebar-collapsed');
            }
        });
        
    </script>
</body>
</html>
